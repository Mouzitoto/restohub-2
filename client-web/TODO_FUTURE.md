# Список задач для доработки client-web

## Критические задачи (требуют изменений в БД/API)

### 1. Интеграция координат столов на схеме зала
**Проблема:** В БД добавлены поля `position_x1`, `position_y1`, `position_x2`, `position_y2` для хранения координат столов на схеме зала (в процентах 0-100), но текущая реализация использует упрощенную сетку столов.

**Что нужно сделать:**
- [ ] Обновить типы `ApiTable` и `Table` в `src/types/restaurant.ts`:
  - Добавить поля `positionX1?: number`, `positionY1?: number`, `positionX2?: number`, `positionY2?: number`
  - Удалить комментарий "Coordinates not stored in DB"
- [ ] Обновить маппер `mapTable` в `src/utils/mappers.ts` для обработки координат
- [ ] Переработать `TableSelectionPage.tsx`:
  - Заменить упрощенную сетку на интерактивную карту с координатами
  - Использовать координаты для отображения столов на фоне схемы зала (`room.mapImageUrl`)
  - Реализовать визуализацию столов как прямоугольников с координатами (x1, y1) - (x2, y2)
  - Добавить возможность клика по столу на карте для выбора
  - Сохранить функциональность zoom и pan для карты

**Файлы для изменения:**
- `client-web/src/types/restaurant.ts`
- `client-web/src/utils/mappers.ts`
- `client-web/src/pages/TableSelectionPage.tsx`

**Примечание:** Координаты хранятся в процентах (0-100), нужно преобразовать их в пиксели относительно размера изображения схемы зала.

---

### 2. Обновление типов для recurrence_day_of_week (массив)
**Проблема:** В БД поле `recurrence_day_of_week` изменено с `INTEGER` на `INTEGER[]` (массив), но в типах фронтенда оно все еще определено как одно число.

**Что нужно сделать:**
- [ ] Обновить типы `ApiPromotion` и `Promotion` в `src/types/restaurant.ts`:
  - Изменить `recurrenceDayOfWeek: number | null` на `recurrenceDayOfWeek: number[] | null`
  - Обновить комментарии
- [ ] Обновить маппер `mapPromotion` в `src/utils/mappers.ts` для обработки массива
- [ ] Обновить компонент `PromotionCard.tsx`:
  - Изменить отображение дней недели с одного числа на массив
  - Показывать все дни недели, если это массив (например, "Пн, Ср, Пт" вместо "Пн")

**Файлы для изменения:**
- `client-web/src/types/restaurant.ts`
- `client-web/src/utils/mappers.ts`
- `client-web/src/components/PromotionCard.tsx`

---

## Важные задачи (улучшение функциональности)

### 3. Endpoint для получения URL изображений
**Проблема:** API возвращает `imageId` (число), но компоненты ожидают `imageUrl` (строка). Сейчас используется функция `getImageUrl()`, которая формирует URL на основе `IMAGE_BASE_URL`, но нужно убедиться, что endpoint существует и работает корректно.

**Что нужно сделать:**
- [ ] Проверить, что endpoint `GET /images/{imageId}` существует в `client-api` или `image-service`
- [ ] Убедиться, что переменная окружения `VITE_IMAGE_BASE_URL` настроена правильно
- [ ] Протестировать загрузку изображений для всех типов:
  - Логотипы ресторанов (`logoId`)
  - Фоновые изображения ресторанов (`bgImageId`)
  - Изображения блюд (`imageId` в `menu_items`)
  - Изображения промо (`imageId` в `promotions`)
  - Схемы залов (`imageId` в `rooms`)
  - Фотографии столов (`imageId` в `tables`)
- [ ] Добавить обработку ошибок загрузки изображений (уже есть `ImageWithFallback`, но можно улучшить)

**Файлы для проверки:**
- `client-web/src/services/api.ts` (функция `getImageUrl`)
- `client-web/src/components/figma/ImageWithFallback.tsx`
- Переменные окружения в `.env` или `.env.example`

---

### 4. Обработка множественных изображений столов
**Проблема:** В типах `Table` есть поле `images?: string[]` (массив), но в БД у стола только одно поле `image_id`. Нужно уточнить, поддерживает ли API множественные изображения или это поле не используется.

**Что нужно сделать:**
- [ ] Проверить структуру API ответа для столов
- [ ] Если API не поддерживает множественные изображения, удалить поле `images` из типов
- [ ] Если API поддерживает (через отдельный endpoint или вложенный массив), обновить маппер

**Файлы для проверки:**
- `client-web/src/types/restaurant.ts`
- `client-web/src/utils/mappers.ts`
- `client-web/src/components/BookingForm.tsx` (использует `table.images`)

---

### 5. Улучшение обработки отсутствующих полей
**Проблема:** Некоторые поля (`rating`, `distance`, `primaryColor`) могут отсутствовать в API, используются дефолтные значения. Можно улучшить обработку.

**Что нужно сделать:**
- [ ] **rating**: Проверить, есть ли в API поле `averageRating` или `rating`. Если нет, скрыть отображение рейтинга или использовать дефолт
- [ ] **distance**: Это поле обычно вычисляется на фронтенде на основе геолокации пользователя. Добавить:
  - Запрос геолокации пользователя (с разрешением)
  - Вычисление расстояния между координатами пользователя и ресторана
  - Кэширование координат пользователя
- [ ] **primaryColor**: Проверить, есть ли в API поле `primaryColor`. Если нет, использовать дефолтный цвет из настроек или из логотипа

**Файлы для изменения:**
- `client-web/src/utils/mappers.ts`
- `client-web/src/pages/HomePage.tsx` (для distance)
- `client-web/src/components/RestaurantCard.tsx` (для rating и distance)

---

## Задачи по улучшению UX/UI

### 6. Оптимизация загрузки данных
**Проблема:** В `HomePage.tsx` для каждого ресторана делаются отдельные запросы для получения промо и залов, что может быть медленно.

**Что нужно сделать:**
- [ ] Проверить, можно ли получить промо и залы в одном запросе (если API поддерживает)
- [ ] Добавить кэширование данных ресторанов
- [ ] Реализовать пагинацию для списка ресторанов
- [ ] Добавить индикаторы загрузки для каждого ресторана

**Файлы для изменения:**
- `client-web/src/pages/HomePage.tsx`
- `client-web/src/services/api.ts`

---

### 7. Улучшение обработки ошибок API
**Проблема:** Ошибки API обрабатываются базово, можно улучшить пользовательский опыт.

**Что нужно сделать:**
- [ ] Добавить специфичные сообщения об ошибках для разных типов ошибок (404, 500, сетевые ошибки)
- [ ] Добавить retry логику для сетевых ошибок
- [ ] Добавить fallback UI для критических ошибок
- [ ] Логировать ошибки для отладки

**Файлы для изменения:**
- `client-web/src/services/api.ts`
- Все страницы, использующие API

---

### 8. Мобильная оптимизация
**Проблема:** Компоненты скопированы из `design-from-figma`, но нужно убедиться, что они корректно работают на мобильных устройствах.

**Что нужно сделать:**
- [ ] Протестировать все страницы на мобильных устройствах
- [ ] Проверить touch-события для интерактивной карты столов
- [ ] Оптимизировать размеры изображений для мобильных
- [ ] Проверить работу фильтров и поиска на мобильных

**Файлы для проверки:**
- Все страницы и компоненты

---

## Технические задачи

### 9. Обновление зависимостей
**Проблема:** После интеграции нужно убедиться, что все зависимости актуальны и совместимы.

**Что нужно сделать:**
- [ ] Проверить версии всех зависимостей на наличие уязвимостей
- [ ] Обновить зависимости до последних стабильных версий
- [ ] Протестировать после обновления

**Файлы для изменения:**
- `client-web/package.json`

---

### 10. Добавление тестов
**Проблема:** После интеграции нужно добавить тесты для критических компонентов.

**Что нужно сделать:**
- [ ] Добавить unit-тесты для мапперов (`mappers.ts`)
- [ ] Добавить unit-тесты для API сервисов
- [ ] Добавить интеграционные тесты для страниц
- [ ] Добавить E2E тесты для критических сценариев (бронирование, поиск)

**Файлы для создания:**
- `client-web/src/utils/__tests__/mappers.test.ts`
- `client-web/src/services/__tests__/api.test.ts`
- `client-web/src/pages/__tests__/`

---

## Документация

### 11. Обновление документации
**Проблема:** После интеграции нужно обновить документацию проекта.

**Что нужно сделать:**
- [ ] Обновить README с описанием новой структуры
- [ ] Добавить документацию по API endpoints
- [ ] Добавить документацию по типам данных
- [ ] Добавить инструкции по настройке переменных окружения

**Файлы для изменения:**
- `client-web/README.md`
- Создать `client-web/API.md`
- Создать `client-web/ENV.md`

---

## Приоритеты

1. **Высокий приоритет:**
   - Задача 1 (Координаты столов) - критично для функциональности бронирования
   - Задача 2 (recurrence_day_of_week массив) - может вызвать ошибки при работе с промо

2. **Средний приоритет:**
   - Задача 3 (Endpoint для изображений) - влияет на отображение контента
   - Задача 4 (Множественные изображения столов) - нужно уточнить требования
   - Задача 5 (Обработка отсутствующих полей) - улучшение UX

3. **Низкий приоритет:**
   - Задачи 6-11 - улучшения и оптимизации

---

## Примечания

- Все изменения должны быть протестированы с реальным API
- При изменении типов нужно обновить все места использования
- При изменении API endpoints нужно обновить документацию
- После выполнения критических задач можно удалить папку `design-from-figma`


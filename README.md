# Resto-Hub

Система управления ресторанами с клиентским и административным интерфейсами.

## Локальный запуск

Для запуска проекта на локальной машине см. [local-deployment/README.md](local-deployment/README.md)

## Сервисы

- **PostgreSQL** - База данных (порт 5432)
- **admin-api** - Админ API (порт 8082)
- **client-api** - Клиентский API (порт 8081)
- **admin-web** - Админ веб-интерфейс
- **client-web** - Клиентский веб-интерфейс
- **nginx** - Обратный прокси (порт 80)

## Переменные окружения

Все доменные URL настраиваются через переменные окружения. Вы можете переопределить их, создав файл `.env` в корне проекта или установив их в вашем окружении.

### Frontend Build Variables (Vite)
Эти переменные встраиваются во время сборки:
- `VITE_API_BASE_URL` - Базовый URL API
- `VITE_PARTNER_DOMAIN` - Домен партнера/админа

### Backend Runtime Variables
Эти переменные можно изменить во время выполнения:
- `ADMIN_WEB_URL` - URL админ веб-интерфейса для CORS
- `CLIENT_WEB_URL` - URL клиентского веб-интерфейса для CORS

### Nginx Domain Variables
Эти переменные настраивают имена серверов в nginx:
- `CLIENT_DOMAIN` - Имя клиентского домена
- `PARTNER_DOMAIN` - Имя домена партнера/админа
- `API_DOMAIN` - Имя домена API

**Примечание:** Значения по умолчанию для локальной разработки настроены в `local-deployment/README.md`. Для продакшена см. раздел "Развертывание в продакшене" ниже.

## Развертывание в продакшене

### Шаг 1: Создание файла .env

Создайте файл `.env` в корневой директории проекта со значениями доменов для продакшена:

```env
# Frontend build-time variables (встраиваются в сборку)
VITE_API_BASE_URL=https://api.restohub.kz
VITE_PARTNER_DOMAIN=https://partner.restohub.kz

# Backend runtime variables (для настройки CORS)
ADMIN_WEB_URL=https://partner.restohub.kz
CLIENT_WEB_URL=https://restohub.kz

# Nginx domain configuration
CLIENT_DOMAIN=restohub.kz
PARTNER_DOMAIN=partner.restohub.kz
API_DOMAIN=api.restohub.kz
```

**Важные примечания:**
- Используйте `https://` для frontend URL (переменные VITE_*) - они встраиваются в сборку
- Используйте `https://` для backend CORS URL (ADMIN_WEB_URL, CLIENT_WEB_URL)
- Используйте только имена доменов (без протокола) для nginx переменных (CLIENT_DOMAIN, PARTNER_DOMAIN, API_DOMAIN)

### Шаг 2: Настройка DNS

Убедитесь, что ваши DNS записи указывают на ваш сервер:

- `restohub.kz` → IP вашего сервера
- `partner.restohub.kz` → IP вашего сервера
- `api.restohub.kz` → IP вашего сервера

### Шаг 3: Настройка SSL/TLS

Перед развертыванием убедитесь, что у вас есть SSL сертификаты для ваших доменов. Вы можете использовать:
- Let's Encrypt (бесплатно, рекомендуется)
- Коммерческие SSL сертификаты

**Для Let's Encrypt с nginx:**
1. Установите certbot на ваш сервер
2. Сгенерируйте сертификаты: `certbot certonly --nginx -d restohub.kz -d partner.restohub.kz -d api.restohub.kz`
3. Обновите конфигурацию nginx для использования SSL (возможно, потребуется изменить nginx.conf.template или добавить SSL конфигурацию)

### Шаг 4: Обновление docker-compose.yml для продакшена

Возможно, потребуется настроить маппинг портов и добавить SSL конфигурацию. Например, если вы используете обратный прокси (например, Cloudflare или другой экземпляр nginx) перед Docker, вы можете:

1. Удалить маппинг порта 80 из сервиса nginx (если используется внешний обратный прокси)
2. Добавить маппинг SSL порта: `443:443`
3. Обновить конфигурацию nginx для обработки SSL termination

### Шаг 5: Сборка и развертывание

1. **Скопируйте ваш проект на продакшен сервер:**
   ```bash
   scp -r resto-hub user@your-server:/path/to/deployment/
   ```

2. **Подключитесь к серверу по SSH:**
   ```bash
   ssh user@your-server
   cd /path/to/deployment/resto-hub
   ```

3. **Создайте файл .env со значениями для продакшена** (см. Шаг 1)

4. **Соберите и запустите сервисы:**
   ```bash
   docker compose up -d --build
   ```

5. **Проверьте, что сервисы запущены:**
   ```bash
   docker compose ps
   docker compose logs
   ```

### Шаг 6: Проверка развертывания

Проверьте, что все сервисы доступны:

- https://restohub.kz - Клиентский веб-интерфейс
- https://partner.restohub.kz - Админ веб-интерфейс
- https://api.restohub.kz/client-api - Клиентский API
- https://api.restohub.kz/admin-api - Админ API

### Решение проблем

**Если сервисы не запускаются:**
- Проверьте логи: `docker compose logs [service-name]`
- Убедитесь, что файл .env находится в корне проекта
- Убедитесь, что все необходимые порты доступны

**Если домены не резолвятся:**
- Проверьте, что DNS записи корректны
- Проверьте настройки файрвола
- Убедитесь, что SSL сертификаты правильно настроены

**Если возникают ошибки CORS:**
- Проверьте, что ADMIN_WEB_URL и CLIENT_WEB_URL соответствуют вашим фактическим доменам
- Проверьте, что URL используют протокол `https://`
- Перезапустите backend сервисы после изменения переменных CORS

**Если frontend показывает неправильные API URL:**
- Пересоберите frontend контейнеры: `docker compose build client-web admin-web`
- Перезапустите сервисы: `docker compose up -d`

### Чеклист безопасности

Перед запуском в продакшене:

- [ ] Измените пароли базы данных по умолчанию
- [ ] Используйте надежные JWT секреты
- [ ] Включите HTTPS/SSL
- [ ] Настройте правила файрвола
- [ ] Настройте регулярные резервные копии
- [ ] Настройте ротацию логов
- [ ] Проверьте и ограничьте открытые порты
- [ ] Настройте мониторинг и алерты

## Примечания

- Миграции базы данных применяются автоматически при запуске admin-api
- Все сервисы общаются через Docker network
- Frontend приложения используют переменные окружения для всех доменных URL
- CORS настроен для разрешения запросов с настроенных доменов


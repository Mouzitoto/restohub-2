# Шаг 4.8: Бронирования и предзаказы

## Описание
Интерфейс для просмотра и управления бронированиями. Предзаказы блюд отображаются в таблице бронирований через колонку "Предзаказ блюд" и аккордеон с деталями. Подтверждение через WhatsApp бот.

## Задачи

### 1. Страница бронирований

#### 1.1. Компонент BookingsPage
**Маршрут:** `/bookings` (защищенный)

**Структура:**
- Заголовок: "Бронирования"
- Панель фильтров:
  - Селектор статуса
  - Период (dateFrom, dateTo)
  - Селектор стола
  - Поиск по телефону клиента
  - Кнопка "Сбросить фильтры"
- Таблица бронирований
- Пагинация

#### 1.2. Таблица бронирований
**Компонент:** BookingsTable

**Колонки:**
- Дата и время бронирования
- Клиент (имя, телефон)
- Стол (номер, зал)
- Количество персон
- **Предзаказ блюд** (количество предзаказанных блюд, если есть)
- Статус (badge с цветом)
- Действия (кнопка "Подробнее", "Отменить")

**Колонка "Предзаказ блюд":**
- Если у бронирования есть предзаказ блюд → отображается число (количество позиций в предзаказе)
- Если предзаказа нет → колонка пустая или отображается "-"
- Число отображается как badge или обычный текст
- При клике на строку бронирования с предзаказом → раскрывается аккордеон со списком блюд

**Аккордеон с предзаказанными блюдами:**
- Раскрывается при клике на строку бронирования, у которого есть предзаказ
- Располагается сразу под строкой бронирования (внутри таблицы)
- Отображает список предзаказанных блюд:
  - Каждое блюдо на отдельной строке
  - Название блюда
  - Количество
  - Цена за единицу
  - Итоговая цена (количество × цена)
  - Особые пожелания к блюду (если есть)
- Внизу аккордеона:
  - Итоговая стоимость всех предзаказанных блюд
  - Общее количество позиций
- При повторном клике на строку → аккордеон сворачивается
- Одновременно может быть раскрыт только один аккордеон (при раскрытии другого - предыдущий сворачивается)

**Цветовая индикация статусов:**
- PENDING: серый
- APPROVED: зеленый
- REJECTED: красный
- CANCELLED: оранжевый

**Логика загрузки:**
- GET запрос на `/admin-api/r/:id/booking` с фильтрами
- Ответ должен включать информацию о предзаказах для каждого бронирования:
  - Количество позиций в предзаказе
  - Список блюд с деталями (для отображения в аккордеоне)
- Автообновление каждые 30 секунд (опционально, для новых бронирований)

**UI состояния аккордеона:**
- **Свернут**: строка бронирования обычная, аккордеон скрыт
- **Развернут**: строка бронирования подсвечена (опционально), аккордеон виден под строкой
- **Loading**: при загрузке данных предзаказа показать skeleton loader в аккордеоне
- **Error**: при ошибке загрузки показать сообщение "Не удалось загрузить предзаказ"

#### 1.3. Детальная информация о бронировании
**Модальное окно:** BookingDetailModal

**Отображаемая информация:**
- Данные клиента:
  - Имя
  - Телефон (кликабельный, для звонка)
  - Email (если есть)
- Информация о бронировании:
  - Дата и время
  - Стол (номер, зал, этаж)
  - Количество персон
  - Особые пожелания
- Статус и история:
  - Текущий статус
  - Дата подтверждения номера (если есть)
  - Дата подтверждения менеджером (если есть)
- Действия:
  - Кнопка "Подтвердить" (если статус PENDING и номер подтвержден)
  - Кнопка "Отклонить" (если статус PENDING и номер подтвержден)
  - Кнопка "Отменить" (если статус PENDING, APPROVED)

**Логика действий:**
1. При клике на "Подтвердить":
   - Показать подтверждение
   - Отправить запрос на изменение статуса (через WhatsApp бот или напрямую, если реализовано)
2. При клике на "Отменить":
   - Показать модальное окно подтверждения
   - PUT запрос на `/admin-api/r/:id/booking/:bookingId/cancel`

### 2. Фильтрация по предзаказам

#### 2.1. Фильтр предзаказов
**В панели фильтров страницы бронирований:**
- Добавить чекбокс или переключатель "Только с предзаказом"
- При включении фильтра → показывать только бронирования, у которых есть предзаказ блюд
- Фильтр работает в комбинации с другими фильтрами (статус, период, стол и т.д.)

**Примечание:** Отдельная страница предзаказов (`/pre-orders`) больше не используется. Все предзаказы отображаются в разделе "Бронирования" через аккордеон.

### 3. Детальная информация о предзаказе (в модальном окне бронирования)

#### 3.1. Секция предзаказа в BookingDetailModal
**В модальном окне детальной информации о бронировании:**
- Если у бронирования есть предзаказ → добавить секцию "Предзаказ блюд"
- Отображать список блюд:
  - Название блюда
  - Количество
  - Цена за единицу
  - Общая стоимость позиции
  - Особые пожелания к блюду (если есть)
- Итоговая информация:
  - Общая стоимость всех блюд
  - Общее количество позиций
- Особые пожелания к предзаказу (если есть общие пожелания)

### 4. Интеграция с WhatsApp ботом

#### 4.1. WebSocket или Polling для обновлений
**Вариант 1: WebSocket (предпочтительно)**
- Подключение к WebSocket серверу при загрузке страницы
- Получение уведомлений о новых бронированиях/предзаказах
- Получение обновлений статусов в реальном времени

**Вариант 2: Polling**
- Периодические запросы (каждые 10-30 секунд)
- Проверка наличия новых или измененных записей
- Обновление списка при обнаружении изменений

#### 4.2. Уведомления о новых записях
**Логика:**
1. При получении уведомления:
   - Показать toast уведомление: "Новое бронирование от {clientName}"
   - Обновить счетчик непрочитанных (badge в навигации)
   - Обновить список (если открыта страница)
2. При клике на уведомление:
   - Перейти на страницу бронирований/предзаказов
   - Открыть детальную информацию

#### 4.3. Автоматическое обновление статусов
**Логика:**
1. При изменении статуса через WhatsApp бот:
   - Получить обновление через WebSocket/polling
   - Обновить статус в таблице
   - Показать уведомление: "Бронирование {id} подтверждено"
2. Визуальная индикация:
   - Анимация изменения статуса
   - Подсветка измененной строки

### 4. Управление статусами

#### 4.1. Изменение статуса вручную
**Доступ:** ADMIN и MANAGER

**Процесс:**
1. В детальном модальном окне:
   - Кнопки "Подтвердить" и "Отклонить" (если статус PENDING и номер подтвержден)
   - При клике:
     - Показать подтверждение
     - Отправить запрос на изменение статуса
     - Обновить статус в UI
     - Показать уведомление

**Примечание:** Изменение статуса обычно происходит через WhatsApp бот, но можно реализовать прямой endpoint для ручного изменения (если требуется).

#### 4.2. Отмена бронирования/предзаказа
**Процесс:**
1. Кнопка "Отменить" в таблице или детальном окне
2. Модальное окно подтверждения
3. PUT запрос на `/admin-api/r/:id/booking/:bookingId/cancel` или `/admin-api/r/:id/pre-order/:preOrderId/cancel`
4. Обновление статуса на CANCELLED (через booking_status_id)

### 5. Фильтры и поиск

#### 5.1. Панель фильтров
**Компонент:** BookingsFilters / PreOrdersFilters

**Фильтры:**
- **Статус**: Multi-select или dropdown
- **Период**: Date picker для dateFrom и dateTo
- **Стол**: Dropdown с загрузкой столов (только для бронирований)
- **Поиск по телефону**: Input с debounce
- **Привязка к бронированию**: Checkbox или dropdown (только для предзаказов)

**Логика:**
- При изменении фильтров:
  - Обновить query параметры URL
  - Отправить новый запрос с фильтрами
  - Обновить таблицу

#### 5.2. Поиск
**Компонент:** SearchInput

**Поля поиска:**
- По телефону клиента (LIKE)
- По имени клиента (LIKE, опционально)

**Логика:**
- Debounce 300ms
- Отправка запроса с параметром `clientPhone` или `clientName`

### 6. UX улучшения

#### 6.1. Индикация новых записей
- Badge в навигации с количеством новых бронирований/предзаказов
- Подсветка новых строк в таблице (опционально)
- Автоматическое скрытие индикации после просмотра

#### 6.2. Экспорт данных (опционально)
- Кнопка "Экспорт" в header таблицы
- Форматы: CSV, Excel
- Экспорт с примененными фильтрами
- Использование API `/admin-api/r/:id/analytics/export?type=booking`

#### 6.3. Статистика на странице
- Карточки с метриками:
  - Всего бронирований за период
  - Подтвержденных
  - Отклоненных
  - Отмененных
- Данные из API `/admin-api/r/:id/analytics/booking`

### 7. Интеграция с API

#### 7.1. Endpoints для бронирований
- `GET /admin-api/r/:id/booking` - список
- `GET /admin-api/r/:id/booking/:bookingId` - детальная информация
- `PUT /admin-api/r/:id/booking/:bookingId/cancel` - отмена

#### 7.2. Endpoints для предзаказов
- `GET /admin-api/r/:id/pre-order` - список
- `GET /admin-api/r/:id/pre-order/:preOrderId` - детальная информация
- `PUT /admin-api/r/:id/pre-order/:preOrderId/cancel` - отмена

#### 7.3. WebSocket/Polling
- WebSocket endpoint для получения обновлений (если реализовано)
- Или polling через периодические GET запросы

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница бронирований:
   - Список бронирований с фильтрацией
   - Детальная информация о бронировании

2. ✅ Страница предзаказов:
   - Список предзаказов с фильтрацией
   - Детальная информация о предзаказе

3. ✅ Интеграция с API:
   - Запросы к `/admin-api/r/:id/booking`
   - Запросы к `/admin-api/r/:id/pre-order`
   - Обработка ответов
   - Обработка ошибок

4. ✅ Интеграция с WhatsApp ботом:
   - Получение уведомлений
   - Обновление статусов

### Функциональные проверки:
1. ✅ Просмотр бронирований работает:
   - Список отображается корректно
   - Фильтрация работает
   - Детальная информация отображается

2. ✅ Просмотр предзаказов работает:
   - Список отображается корректно
   - Фильтрация работает
   - Детальная информация отображается

3. ✅ Интеграция с WhatsApp ботом работает:
   - Уведомления приходят
   - Статусы обновляются автоматически

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Интеграция с WhatsApp ботом работает
- ✅ Фильтрация и поиск работают
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


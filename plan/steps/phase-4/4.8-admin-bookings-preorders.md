# Шаг 4.8: Бронирования и предзаказы

## Описание
Интерфейс для просмотра и управления бронированиями. Предзаказы блюд отображаются в таблице бронирований через колонку "Предзаказ блюд" и аккордеон с деталями. Изменение статуса бронирования можно выполнить на этой странице или в WhatsApp боте.

## Задачи

### 1. Страница бронирований

#### 1.1. Компонент BookingsPage
**Маршрут:** `/bookings` (защищенный)

**Структура:**
- Заголовок: "Бронирования"
- Панель фильтров:
  - Селектор статуса
  - Период (dateFrom, dateTo)
  - Селектор стола
  - Поиск по телефону клиента
  - Кнопка "Сбросить фильтры"
- Таблица бронирований
- Пагинация

#### 1.2. Таблица бронирований
**Компонент:** BookingsTable

**Колонки:**
- Дата и время бронирования
- Клиент (имя, телефон)
- Стол (номер, зал)
- Количество персон
- **Предзаказ блюд** (количество предзаказанных блюд, если есть)
- Статус (badge с цветом)
- Действия (кнопка "Подробнее", "Подтвердить", "Отклонить", "Отменить")

**Логика отображения кнопок действий:**
- Кнопка "Подробнее": всегда видна, открывает модальное окно с детальной информацией
- Кнопка "Подтвердить": отображается только если статус PENDING и номер телефона подтвержден
- Кнопка "Отклонить": отображается только если статус PENDING и номер телефона подтвержден
- Кнопка "Отменить": отображается только если статус PENDING или APPROVED
- При клике на "Подтвердить": отправка запроса в WhatsApp бот, который отправит сообщение клиенту и поменяет статус бронирования в БД на APPROVED
- При клике на "Отклонить": показ модального окна подтверждения, затем отправка запроса в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на REJECTED
- При клике на "Отменить": показ модального окна подтверждения, затем отправка запроса в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на CANCELLED_BY_MANAGER

**Колонка "Предзаказ блюд":**
- Если у бронирования есть предзаказ блюд → отображается число (количество позиций в предзаказе)
- Если предзаказа нет → колонка пустая или отображается "-"
- Число отображается как badge или обычный текст
- При клике на строку бронирования с предзаказом → раскрывается аккордеон со списком блюд

**Аккордеон с предзаказанными блюдами:**
- Раскрывается при клике на строку бронирования, у которого есть предзаказ (`preOrderItemsCount > 0`)
- Располагается сразу под строкой бронирования (внутри таблицы)
- При первом раскрытии:
  - Показать состояние Loading (skeleton loader)
  - Отправить GET запрос на `/admin-api/r/:id/booking/:bookingId/pre-order-items`
  - После загрузки отобразить список предзаказанных блюд
- При повторном раскрытии (если данные уже загружены):
  - Отобразить кэшированные данные без повторного запроса
- Отображает список предзаказанных блюд:
  - Каждое блюдо на отдельной строке
  - Название блюда
  - Количество
  - Цена за единицу
  - Итоговая цена (количество × цена)
  - Особые пожелания к блюду (если есть)
- Внизу аккордеона:
  - Итоговая стоимость всех предзаказанных блюд
  - Общее количество позиций
- При повторном клике на строку → аккордеон сворачивается
- Одновременно может быть раскрыт только один аккордеон (при раскрытии другого - предыдущий сворачивается)

**Цветовая индикация статусов:**
- PENDING: серый
- APPROVED: зеленый
- REJECTED: красный
- CANCELLED_BY_CLIENT: оранжевый (отменено клиентом)
- CANCELLED_BY_MANAGER: оранжевый (отменено менеджером)

**Логика загрузки:**
- GET запрос на `/admin-api/r/:id/booking` с фильтрами
- Ответ должен включать для каждого бронирования:
  - Основную информацию о бронировании
  - `preOrderItemsCount` - количество позиций в предзаказе (0, если предзаказа нет)
- Автообновление каждые 30 секунд (опционально, для новых бронирований)

**Логика загрузки деталей предзаказа (при раскрытии аккордеона):**
- GET запрос на `/admin-api/r/:id/booking/:bookingId/pre-order-items` при клике на строку бронирования с предзаказом
- Ответ должен включать список блюд с деталями:
  - Название блюда
  - Количество
  - Цена за единицу
  - Итоговая цена (количество × цена)
  - Особые пожелания к блюду (если есть)
  - Итоговая стоимость всех предзаказанных блюд
  - Общее количество позиций

**UI состояния аккордеона:**
- **Свернут**: строка бронирования обычная, аккордеон скрыт
- **Развернут**: строка бронирования подсвечена (опционально), аккордеон виден под строкой
- **Loading**: при первой загрузке данных предзаказа показать skeleton loader в аккордеоне
- **Loaded**: отображение списка блюд с деталями
- **Error**: при ошибке загрузки показать сообщение "Не удалось загрузить предзаказ" с кнопкой "Повторить"

#### 1.3. Детальная информация о бронировании
**Модальное окно:** BookingDetailModal

**Отображаемая информация:**
- Данные клиента:
  - Имя
  - Телефон (кликабельный, для звонка)
  - Email (если есть)
- Информация о бронировании:
  - Дата и время
  - Стол (номер, зал, этаж)
  - Количество персон
  - Особые пожелания
- Статус и история:
  - Текущий статус
  - Дата подтверждения номера (если есть)
  - Дата подтверждения менеджером (если есть)
- Действия:
  - Кнопка "Подтвердить" (если статус PENDING и номер подтвержден)
  - Кнопка "Отклонить" (если статус PENDING и номер подтвержден)
  - Кнопка "Отменить" (если статус PENDING, APPROVED)

**Логика действий:**
1. При клике на "Подтвердить":
   - Показать подтверждение
   - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и поменяет статус бронирования в БД на APPROVED
2. При клике на "Отклонить":
   - Показать модальное окно подтверждения
   - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на REJECTED
3. При клике на "Отменить":
   - Показать модальное окно подтверждения
   - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на CANCELLED_BY_MANAGER

### 2. Фильтрация по предзаказам

#### 2.1. Фильтр предзаказов
**В панели фильтров страницы бронирований:**
- Добавить чекбокс или переключатель "Только с предзаказом"
- При включении фильтра → показывать только бронирования, у которых есть предзаказ блюд
- Фильтр работает в комбинации с другими фильтрами (статус, период, стол и т.д.)

**Примечание:** Отдельная страница предзаказов (`/pre-orders`) больше не используется. Все предзаказы отображаются в разделе "Бронирования" через аккордеон.

### 3. Детальная информация о предзаказе (в модальном окне бронирования)

#### 3.1. Секция предзаказа в BookingDetailModal
**В модальном окне детальной информации о бронировании:**
- Если у бронирования есть предзаказ → добавить секцию "Предзаказ блюд"
- Отображать список блюд:
  - Название блюда
  - Количество
  - Цена за единицу
  - Общая стоимость позиции
  - Особые пожелания к блюду (если есть)
- Итоговая информация:
  - Общая стоимость всех блюд
  - Общее количество позиций
- Особые пожелания к предзаказу (если есть общие пожелания)

### 4. Интеграция с WhatsApp ботом

#### 4.1. Взаимодействие через API WhatsApp бота
**Архитектура:**
- Взаимодействие с WhatsApp ботом происходит через API внутри WhatsApp бота (это наш собственный API, не SDK WhatsApp)
- При клике на кнопки действий (Подтвердить, Отклонить, Отменить) фронтенд вызывает API WhatsApp бота
- WhatsApp бот изменяет статус бронирования в БД и отправляет сообщение клиенту
- Сервис WhatsApp бота не сообщает фронтенду о новых бронированиях или изменениях статусов

**Процесс изменения статуса:**
1. Пользователь нажимает кнопку действия (Подтвердить, Отклонить, Отменить)
2. Фронтенд отправляет запрос в API WhatsApp бота
3. WhatsApp бот:
   - Изменяет статус бронирования в БД
   - Отправляет сообщение клиенту через WhatsApp
4. Фронтенд обновляет UI после успешного ответа от API WhatsApp бота

#### 4.2. Получение обновлений
**Логика:**
- WhatsApp бот изменяет статус бронирования в БД напрямую
- Для получения новых бронирований и обновлений статусов админка веб должна делать запросы к админке бэк
- Использовать GET запрос на `/admin-api/r/:id/booking` для получения актуального списка бронирований

**Автообновление (опционально):**
- Периодические запросы к `/admin-api/r/:id/booking` (каждые 30 секунд)
- При обнаружении изменений (новые бронирования, изменение статусов):
  - Обновить список в таблице
  - Показать уведомление о новых бронированиях (опционально)
  - Подсветить измененные строки (опционально)

### 4. Управление статусами

#### 4.1. Изменение статуса вручную
**Доступ:** ADMIN и MANAGER

**Процесс:**
1. В таблице бронирований:
   - Кнопка "Подтвердить" (если статус PENDING и номер подтвержден)
   - Кнопка "Отклонить" (если статус PENDING и номер подтвержден)
   - Кнопка "Отменить" (если статус PENDING или APPROVED)
   - При клике на "Подтвердить":
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и поменяет статус бронирования в БД на APPROVED
     - Обновить статус в UI
     - Показать уведомление
   - При клике на "Отклонить":
     - Показать подтверждение
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на REJECTED
     - Обновить статус в UI
     - Показать уведомление
   - При клике на "Отменить":
     - Показать подтверждение
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на CANCELLED_BY_MANAGER
     - Обновить статус в UI
     - Показать уведомление

2. В детальном модальном окне:
   - Кнопки "Подтвердить" и "Отклонить" (если статус PENDING и номер подтвержден)
   - Кнопка "Отменить" (если статус PENDING или APPROVED)
   - При клике на "Подтвердить":
     - Показать подтверждение
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и поменяет статус бронирования в БД на APPROVED
     - Обновить статус в UI
     - Показать уведомление
   - При клике на "Отклонить":
     - Показать подтверждение
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на REJECTED
     - Обновить статус в UI
     - Показать уведомление
   - При клике на "Отменить":
     - Показать подтверждение
     - Отправить запрос в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на CANCELLED_BY_MANAGER
     - Обновить статус в UI
     - Показать уведомление

**Примечание:** Изменение статуса на APPROVED, REJECTED и CANCELLED_BY_MANAGER происходит через WhatsApp бот, который отправляет сообщение клиенту и обновляет статус в БД. Клиент может отменить бронирование самостоятельно через WhatsApp бот, в этом случае статус изменится на CANCELLED_BY_CLIENT.

#### 4.2. Отмена бронирования/предзаказа
**Процесс:**
1. Кнопка "Отменить" в таблице или детальном окне
2. Модальное окно подтверждения
3. Отправка запроса в WhatsApp бот, который отправит сообщение клиенту и изменит статус бронирования в БД на CANCELLED_BY_MANAGER
4. Обновление статуса в UI после получения подтверждения от бота

### 5. Фильтры и поиск

#### 5.1. Панель фильтров
**Компонент:** BookingsFilters / PreOrdersFilters

**Фильтры:**
- **Статус**: Multi-select или dropdown
- **Период**: Date picker для dateFrom и dateTo
- **Стол**: Dropdown с загрузкой столов (только для бронирований)
- **Поиск по телефону**: Input с debounce
- **Привязка к бронированию**: Checkbox или dropdown (только для предзаказов)

**Логика:**
- При изменении фильтров:
  - Обновить query параметры URL
  - Отправить новый запрос с фильтрами
  - Обновить таблицу

#### 5.2. Поиск
**Компонент:** SearchInput

**Поля поиска:**
- По телефону клиента (LIKE)
- По имени клиента (LIKE, опционально)

**Логика:**
- Debounce 300ms
- Отправка запроса с параметром `clientPhone` или `clientName`

### 6. UX улучшения

#### 6.1. Индикация новых записей
- Badge в навигации с количеством новых бронирований/предзаказов
- Подсветка новых строк в таблице (опционально)
- Автоматическое скрытие индикации после просмотра

#### 6.2. Экспорт данных (опционально)
- Кнопка "Экспорт" в header таблицы
- Форматы: CSV, Excel
- Экспорт с примененными фильтрами
- Использование API `/admin-api/r/:id/analytics/export?type=booking`

#### 6.3. Статистика на странице
- Карточки с метриками:
  - Всего бронирований за период
  - Подтвержденных
  - Отклоненных
  - Отмененных
- Данные из API `/admin-api/r/:id/analytics/booking`

### 7. Интеграция с API

#### 7.1. Endpoints для бронирований
- `GET /admin-api/r/:id/booking` - список бронирований (возвращает `preOrderItemsCount` для каждого бронирования)
- `GET /admin-api/r/:id/booking/:bookingId` - детальная информация о бронировании
- `GET /admin-api/r/:id/booking/:bookingId/pre-order-items` - получение позиций предзаказа для бронирования
- `PUT /admin-api/r/:id/booking/:bookingId/cancel` - отмена

#### 7.2. Endpoints для предзаказов
- `GET /admin-api/r/:id/pre-order` - список
- `GET /admin-api/r/:id/pre-order/:preOrderId` - детальная информация
- `PUT /admin-api/r/:id/pre-order/:preOrderId/cancel` - отмена

#### 7.3. API WhatsApp бота
- Endpoints для изменения статусов бронирований (вызываются фронтендом)
- Детали API WhatsApp бота описаны в отдельной документации

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница бронирований:
   - Список бронирований с фильтрацией
   - Детальная информация о бронировании

2. ✅ Страница предзаказов:
   - Список предзаказов с фильтрацией
   - Детальная информация о предзаказе

3. ✅ Интеграция с API:
   - Запросы к `/admin-api/r/:id/booking`
   - Запросы к `/admin-api/r/:id/pre-order`
   - Обработка ответов
   - Обработка ошибок

4. ✅ Интеграция с WhatsApp ботом:
   - Вызовы API WhatsApp бота для изменения статусов
   - Получение обновлений через запросы к админке бэк

### Функциональные проверки:
1. ✅ Просмотр бронирований работает:
   - Список отображается корректно
   - Фильтрация работает
   - Детальная информация отображается

2. ✅ Просмотр предзаказов работает:
   - Список отображается корректно
   - Фильтрация работает
   - Детальная информация отображается

3. ✅ Интеграция с WhatsApp ботом работает:
   - API WhatsApp бота вызывается корректно
   - Статусы обновляются через запросы к админке бэк

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Интеграция с WhatsApp ботом работает
- ✅ Фильтрация и поиск работают
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


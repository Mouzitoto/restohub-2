# Шаг 4.4: Меню (блюда)

## Описание
Интерфейс для управления блюдами: создание, редактирование, загрузка фото, управление ценами.

## Задачи

### 1. Страница управления блюдами

#### 1.1. Компонент MenuItemsPage
**Маршрут:** `/menu/items` (защищенный)

**Структура страницы:**
- Заголовок: "Блюда меню"
- Панель фильтров и поиска:
  - Селектор категории (фильтр)
  - Поле поиска по названию
  - Кнопка "Сбросить фильтры"
- Кнопка "Добавить блюдо"
- Список блюд (таблица)
- Пагинация (если блюд много)

#### 1.2. Список блюд
**Компонент:** MenuItemList

**Отображение:**
- Таблица с поддержкой drag & drop для изменения порядка
- Для каждого блюда:
  - Иконка перетаскивания (drag handle) в начале строки
  - Изображение через компонент `ImagePreview` с `imageId={item.imageId}`
  - Название (жирным)
  - Описание (обрезанное, если длинное)
  - Цена:
    - Если есть скидка: зачеркнутая базовая цена + финальная цена (красным)
    - Если нет скидки: обычная цена
  - Категория (badge)
  - Характеристики: уровень остроты (иконки перца), сахар (иконка), скидка (badge)
  - Кнопки действий: "Редактировать", "Удалить"

**Логика загрузки:**
1. При загрузке страницы:
   - Загрузить список категорий для фильтра
   - Показать skeleton loaders
   - Отправить GET запрос на `/admin-api/r/:id/menu-item?limit=50&offset=0&sortBy=displayOrder&sortOrder=asc`
2. При применении фильтров:
   - Обновить query параметры
   - Отправить новый запрос с фильтрами
3. При поиске:
   - Debounce 300ms перед отправкой запроса
   - Отправить запрос с параметром `search`

**Пагинация:**
- Кнопки "Назад" и "Вперед"
- Отображение текущей страницы и общего количества
- При изменении страницы → обновить `offset` и отправить запрос

**Drag & Drop для изменения порядка:**
- Библиотека: react-beautiful-dnd или @dnd-kit/core
- При перетаскивании строки:
  - Визуальная индикация перемещения (highlight, shadow)
  - Обновление порядка в UI (оптимистичное обновление)
- При завершении перетаскивания:
  - Вычислить новые значения `displayOrder` для всех блюд на текущей странице
  - Отправить PUT запрос на `/admin-api/r/:id/menu-item/reorder`:
    ```json
    {
      "items": [
        { "id": 1, "displayOrder": 0 },
        { "id": 2, "displayOrder": 1 },
        { "id": 3, "displayOrder": 2 }
      ]
    }
    ```
- Обработка ответа:
  - **Успех (200 OK)**:
    - Обновить список блюд
    - Показать уведомление "Порядок блюд обновлен"
  - **Ошибка**:
    - Откатить изменения в UI (вернуть к исходному порядку)
    - Показать сообщение об ошибке
- Примечание: drag & drop работает только в пределах текущей страницы (без фильтров по категории)

### 2. Форма создания/редактирования блюда

#### 2.1. Компонент MenuItemFormModal
**Тип:** Модальное окно (полноэкранное или большое)

**Структура:**
- Заголовок: "Добавить блюдо" или "Редактировать блюдо"
- Форма с секциями:
  - "Основная информация"
  - "Цена и скидка"
  - "Характеристики"
  - "Изображение"
- Кнопки: "Отмена" и "Сохранить"

**Поля формы:**
```typescript
interface MenuItemForm {
  name: string;              // required, max 255
  description: string;        // optional, max 10000
  ingredients: string;        // optional, max 10000
  price: number;             // required, min: 0.01, precision: 2
  menuCategoryId: number;    // required
  discountPercent: number;    // optional, 0-100, default: 0
  spicinessLevel: number;    // optional, 0-5, default: 0
  hasSugar: boolean;         // optional, default: false
  imageId: number | null;    // optional
  displayOrder: number;       // optional, min: 0
}
```

**Валидация на фронтенде:**
- **name**:
  - Обязательное поле
  - Максимальная длина: 255 символов
  - Сообщение: "Название блюда обязательно"
- **description**:
  - Максимальная длина: 10000 символов
  - Счетчик символов
- **ingredients**:
  - Максимальная длина: 10000 символов
  - Счетчик символов
- **price**:
  - Обязательное поле
  - Минимальное значение: 0.01
  - Формат: decimal с 2 знаками после запятой
  - Сообщение: "Цена должна быть больше 0"
- **menuCategoryId**:
  - Обязательное поле
  - Должна быть выбрана категория из списка
  - Сообщение: "Выберите категорию"
- **discountPercent**:
  - Диапазон: 0-100
  - По умолчанию: 0
  - Сообщение: "Скидка должна быть от 0 до 100%"
- **spicinessLevel**:
  - Диапазон: 0-5
  - Визуализация: 5 иконок перца (заполненные/пустые)
  - По умолчанию: 0
- **hasSugar**:
  - Чекбокс
  - По умолчанию: false
- **imageId**:
  - Опционально
  - Устанавливается после загрузки изображения
- **displayOrder**:
  - Минимальное значение: 0
  - По умолчанию: последний порядок + 1

**Секция "Основная информация":**
- Поле "Название" (input text)
- Поле "Описание" (textarea)
- Поле "Ингредиенты" (textarea)
- Селектор "Категория" (dropdown с загрузкой категорий)

**Секция "Цена и скидка":**
- Поле "Цена" (input number, step: 0.01)
- Поле "Процент скидки" (input number, 0-100)
- Отображение финальной цены (readonly, вычисляется автоматически):
  - Если скидка > 0: показать базовую цену (зачеркнутую) и финальную цену (красным, крупнее)
  - Если скидка = 0: показать только цену

**Секция "Характеристики":**
- Уровень остроты: 5 иконок перца (кликабельные)
  - При клике → установить уровень (0-5)
  - Визуальная индикация выбранного уровня
- Чекбокс "Содержит сахар"
- Поле "Порядок отображения" (input number)

**Секция "Изображение":**
- Компонент ImageUpload (см. шаг 4.2)
- Отображение текущего изображения (если есть)
- Кнопка "Удалить изображение"

**Логика создания:**
1. При открытии модального окна:
   - Загрузить список категорий для селектора
   - Определить последний `displayOrder`
   - Очистить форму
2. При отправке формы:
   - Валидация всех полей
   - Расчет финальной цены для отображения
   - Отправить POST запрос на `/admin-api/r/:id/menu-item`
3. Обработка ответа:
   - **Успех (201 Created)**:
     - Закрыть модальное окно
     - Обновить список блюд
     - Показать уведомление "Блюдо создано"
   - **Ошибка (400 Bad Request)**:
     - Показать ошибки валидации под полями
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Нет доступа"

**Логика редактирования:**
- Аналогично созданию
- Заполнить форму данными блюда
- Отправить PUT запрос на `/admin-api/r/:id/menu-item/:itemId`

### 3. Загрузка фото блюд

#### 3.1. Компонент ImageUpload
**Компонент:** `ImageUpload` (общий компонент, см. раздел 6.2 в шаге 4.1)

**Использование:**
```typescript
<ImageUpload
  currentImageId={formData.imageId}
  onImageUploaded={(imageId) => setFormData({ ...formData, imageId })}
  onImageRemoved={() => setFormData({ ...formData, imageId: null })}
  type="dish"
  recommendedSize="800x600px - 1200x900px"
  aspectRatio={4/3}
  maxSize={5 * 1024 * 1024} // 5MB
  showCrop={true} // Опционально: включить кроп
/>
```

### 4. Расчет цены со скидкой

#### 4.1. Компонент PriceDisplay
**Логика расчета:**
```typescript
function calculateFinalPrice(price: number, discountPercent: number): number {
  return price * (1 - discountPercent / 100);
}
```

**Визуальное отображение:**
- Если `discountPercent > 0`:
  ```jsx
  <div>
    <span style={{ textDecoration: 'line-through', color: 'gray' }}>
      {price.toFixed(2)} ₸
    </span>
    <span style={{ color: 'red', fontSize: '1.2em', marginLeft: '10px' }}>
      {finalPrice.toFixed(2)} ₸
    </span>
    <Badge color="red">-{discountPercent}%</Badge>
  </div>
  ```
- Если `discountPercent === 0`:
  ```jsx
  <span>{price.toFixed(2)} ₸</span>
  ```

**В форме:**
- Автоматический пересчет при изменении `price` или `discountPercent`
- Отображение финальной цены в реальном времени

### 5. Удаление блюда

#### 5.1. Логика удаления
**Процесс:**
1. При клике на "Удалить":
   - Показать модальное окно подтверждения:
     - Заголовок: "Удалить блюдо?"
     - Текст: "Вы уверены, что хотите удалить блюдо '{name}'?"
     - Кнопки: "Отмена" и "Удалить"
2. При подтверждении:
   - Показать индикатор загрузки
   - Отправить DELETE запрос на `/admin-api/r/:id/menu-item/:itemId`
3. Обработка ответа:
   - **Успех (204 No Content)**:
     - Закрыть модальное окно
     - Удалить блюдо из списка
     - Показать уведомление "Блюдо удалено"
   - **Ошибка**:
     - Показать сообщение об ошибке

### 6. Изменение порядка блюд

#### 6.1. Drag & Drop функциональность
**Компонент:** MenuItemList с поддержкой drag & drop

**Логика:**
1. При перетаскивании блюда:
   - Визуальная индикация перемещения (highlight, shadow)
   - Обновление порядка в UI (оптимистичное обновление)
   - Курсор меняется на "grabbing" при захвате
2. При завершении перетаскивания:
   - Вычислить новые значения `displayOrder` для всех блюд на текущей странице
   - Отправить PUT запрос на `/admin-api/r/:id/menu-item/reorder`:
     ```json
     {
       "items": [
         { "id": 1, "displayOrder": 0 },
         { "id": 2, "displayOrder": 1 },
         { "id": 3, "displayOrder": 2 }
       ]
     }
     ```
3. Обработка ответа:
   - **Успех (200 OK)**:
     - Обновить список блюд
     - Показать уведомление "Порядок блюд обновлен"
   - **Ошибка**:
     - Откатить изменения в UI (вернуть к исходному порядку)
     - Показать сообщение об ошибке

**Ограничения:**
- Drag & drop работает только в пределах текущей страницы
- При активных фильтрах (по категории или поиску) drag & drop отключен
- Порядок сохраняется только для блюд на текущей странице

**Визуальная индикация:**
- Иконка перетаскивания (drag handle) в начале каждой строки
- При наведении на drag handle → курсор "grab"
- При перетаскивании → курсор "grabbing", строка подсвечивается
- Место вставки отображается визуально (линия или подсветка)

### 7. Фильтрация и поиск

#### 7.1. Фильтр по категориям
**Компонент:** CategoryFilter

**Логика:**
- Dropdown с загрузкой категорий из `/admin-api/menu-category`
- Опция "Все категории" (значение: null)
- При выборе категории:
  - Обновить query параметр `menuCategoryId`
  - Отправить новый запрос
  - Обновить список блюд

#### 7.2. Поиск по названию
**Компонент:** SearchInput

**Логика:**
- Input поле с debounce 300ms
- Иконка поиска
- Кнопка очистки (если есть текст)
- При вводе:
  - Debounce перед отправкой запроса
  - Отправить запрос с параметром `search`
  - Обновить список блюд

### 8. UX улучшения

#### 8.1. Визуальная индикация
- Иконки для характеристик:
  - Острота: иконки перца (1-5)
  - Сахар: иконка сахара/сладости
  - Скидка: badge с процентом
- Изображения блюд с fallback placeholder
- Индикатор загрузки при операциях

#### 8.2. Сортировка
- Селектор сортировки:
  - По названию
  - По цене
  - По порядку отображения
  - По дате создания
- Направление сортировки (asc/desc)

#### 8.3. Обработка состояний
- **Loading**: skeleton loaders
- **Empty**: сообщение "Блюда не найдены" с кнопкой "Добавить блюдо"
- **Error**: сообщение об ошибке с кнопкой "Повторить"
- **Success**: нормальное отображение списка

### 9. Интеграция с API

#### 9.1. Endpoints
- `GET /admin-api/r/:id/menu-item` - получение списка
- `POST /admin-api/r/:id/menu-item` - создание
- `GET /admin-api/r/:id/menu-item/:itemId` - получение одного блюда
- `PUT /admin-api/r/:id/menu-item/:itemId` - обновление
- `PUT /admin-api/r/:id/menu-item/reorder` - массовое обновление порядка
- `DELETE /admin-api/r/:id/menu-item/:itemId` - удаление
- `GET /admin-api/menu-category` - получение категорий для фильтра
- `POST /admin-api/image` - загрузка изображения

#### 9.2. Обработка ошибок
- Стандартизированная обработка всех HTTP статусов
- Отображение понятных сообщений
- Валидация на фронтенде перед отправкой запроса

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница блюд меню:
   - Список блюд с фильтрацией
   - Форма создания/редактирования
   - Загрузка изображений

2. ✅ Интеграция с API:
   - Запросы к `/admin-api/r/:id/menu-item`
   - Запросы к `/admin-api/r/:id/menu-item/reorder` для изменения порядка
   - Запросы к `/admin-api/image` для загрузки изображений
   - Обработка ответов
   - Обработка ошибок

3. ✅ Валидация:
   - Проверка обязательных полей
   - Валидация цен и процентов

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание блюда
   - Редактирование блюда
   - Удаление блюда

2. ✅ Загрузка изображений работает:
   - Изображения загружаются через `/admin-api/image`
   - Компонент `ImagePreview` отображает превью корректно
   - При клике на превью открывается модальное окно с оригинальным изображением

3. ✅ Расчет цены работает:
   - Финальная цена рассчитывается корректно
   - Отображение скидки работает

4. ✅ Drag & Drop работает:
   - Блюда можно перетаскивать для изменения порядка
   - Порядок сохраняется через API
   - Визуальная индикация работает корректно

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Валидация работает
- ✅ Загрузка изображений работает
- ✅ Drag & Drop для изменения порядка работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


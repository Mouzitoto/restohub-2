# Шаг 4.14: Управление пользователями

## Описание
Реализация интерфейса для управления пользователями системы (ADMIN и MANAGER) в admin-web. Доступ только для ADMIN.

## Задачи

### 1. Страница управления пользователями

#### 1.1. Компонент AdminUsersPage
**Маршрут:** `/admin/users` (только ADMIN)

**Структура страницы:**
- Заголовок: "Управление пользователями"
- Панель фильтров и поиска
- Кнопка "Создать пользователя"
- Таблица пользователей
- Пагинация

**Панель фильтров:**
- Поиск по email (input с debounce 300ms)
- Фильтр по роли (dropdown: "Все", "ADMIN", "MANAGER")
- Фильтр по статусу (dropdown: "Все", "Активен", "Неактивен")
- Кнопка "Сбросить фильтры"

**Таблица пользователей:**
- Колонки:
  - Email (с возможностью сортировки)
  - Роль (badge: "ADMIN" или "MANAGER")
  - Привязанные рестораны (только для MANAGER, список названий через запятую)
  - Статус (badge: "Активен" / "Неактивен")
  - Дата создания (с возможностью сортировки)
  - Действия (кнопки: "Редактировать", "Сбросить пароль", "Активировать/Деактивировать", "Удалить")

**Пагинация:**
- Отображение общего количества пользователей
- Кнопки "Предыдущая" / "Следующая"
- Отображение текущей страницы и общего количества страниц
- Селектор количества элементов на странице (10, 25, 50, 100)

**Логика загрузки данных:**
1. При загрузке страницы:
   - Проверить роль пользователя (должен быть ADMIN)
   - Если не ADMIN → редирект на `/dashboard` с сообщением об ошибке
   - Показать skeleton loaders для таблицы
   - Отправить GET запрос на `/admin-api/user?limit=50&offset=0`
2. При применении фильтров:
   - Обновить query параметры URL
   - Отправить запрос с новыми параметрами
3. При изменении страницы пагинации:
   - Обновить `offset` в запросе
   - Перезагрузить данные

**Примечание:** Список ролей для dropdown загружается при открытии модального окна создания/редактирования пользователя через GET запрос на `/admin-api/role`.

**Обработка ошибок:**
- 401 Unauthorized → редирект на `/login`
- 403 Forbidden → показать сообщение "Нет доступа к этой странице" и редирект на `/dashboard`
- 500 Server Error → показать сообщение "Ошибка сервера. Попробуйте позже"

### 2. Форма создания/редактирования пользователя

#### 2.1. Компонент UserFormModal
**Модальное окно:** Открывается при клике на "Создать пользователя" или "Редактировать"

**Структура формы:**
```typescript
interface UserForm {
  email: string;           // required, email format
  password: string;         // required при создании, optional при редактировании
  roleId: number;          // required (1=ADMIN, 2=MANAGER)
  restaurantIds: number[]; // optional, только для MANAGER
}
```

**Поля формы:**
- **Email** (text input):
  - Обязательное поле
  - Формат email (regex: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`)
  - Сообщение об ошибке: "Введите корректный email"
  - Проверка уникальности при отправке (если email уже существует → ошибка от сервера)

- **Пароль** (password input):
  - Обязательное поле при создании
  - Опциональное при редактировании (если не указан - не обновлять)
  - Минимальная длина: 8 символов
  - Сообщение об ошибке: "Пароль должен содержать минимум 8 символов"
  - Показывать индикатор силы пароля (опционально)

- **Роль** (dropdown):
  - Обязательное поле
  - Загрузка списка ролей через GET запрос на `/admin-api/role` при открытии модального окна
  - Отображение: `name` (например, "Администратор", "Менеджер") в dropdown, сохранение `id` в форме
  - При выборе роли с `code = "MANAGER"` → показать поле "Привязанные рестораны"
  - При редактировании: предзаполнить выбранной ролью пользователя

- **Привязанные рестораны** (multi-select, только для MANAGER):
  - Появляется только если выбрана роль "Менеджер"
  - Список всех активных ресторанов (загрузка через `/admin-api/r`)
  - Возможность выбрать несколько ресторанов
  - Поиск по названию ресторана в селекторе

**Валидация на фронтенде:**
- При отправке формы:
  - Валидация всех обязательных полей
  - Если валидация не прошла → показать ошибки под полями, НЕ отправлять запрос
  - Если валидация прошла → отправить запрос

**Логика:**
- **При открытии модального окна:**
  - Отправить GET запрос на `/admin-api/role` для загрузки списка ролей
  - Заполнить dropdown ролей полученными данными
  - При редактировании: загрузить данные пользователя через GET `/admin-api/user/:userId` и предзаполнить форму
  
- **Создание:**
  - POST запрос на `/admin-api/user`
  - Request body: `{ email, password, roleId, restaurantIds }`
  - При успехе: закрыть модальное окно, обновить список пользователей, показать уведомление "Пользователь успешно создан"
  
- **Редактирование:**
  - PUT запрос на `/admin-api/user/:userId`
  - Request body: `{ email?, password?, roleId?, restaurantIds? }` (только измененные поля)
  - При успехе: закрыть модальное окно, обновить список пользователей, показать уведомление "Пользователь успешно обновлен"

**UI состояния:**
- **Initial**: форма готова к заполнению
- **Loading**: кнопка "Сохранить" disabled, отображается spinner
- **Error**: под формой или под полями отображаются сообщения об ошибках
- **Success**: закрытие модального окна и обновление списка

### 3. Сброс пароля

#### 3.1. Компонент ResetPasswordModal
**Модальное окно:** Открывается при клике на "Сбросить пароль"

**Структура формы:**
- Новый пароль (password input)
- Подтверждение пароля (password input)
- Кнопки: "Отмена" и "Сбросить"

**Валидация:**
- **Новый пароль:**
  - Обязательное поле
  - Минимальная длина: 8 символов
  - Сообщение об ошибке: "Пароль должен содержать минимум 8 символов"
  
- **Подтверждение пароля:**
  - Обязательное поле
  - Должен совпадать с новым паролем
  - Сообщение об ошибке: "Пароли не совпадают"

**Логика:**
1. При отправке формы:
   - Валидация полей
   - Если валидация не прошла → показать ошибки, НЕ отправлять запрос
   - Если валидация прошла:
     - Показать индикатор загрузки
     - Отправить PUT запрос на `/admin-api/user/:userId/password`:
       ```json
       {
         "password": "новый_пароль"
       }
       ```
2. Обработка ответа:
   - **Успех (200 OK)**: закрыть модальное окно, показать уведомление "Пароль успешно изменен"
   - **Ошибка (400 Bad Request)**: показать сообщение об ошибке из response body
   - **Ошибка (404 Not Found)**: показать сообщение "Пользователь не найден"
   - **Ошибка (403 Forbidden)**: показать сообщение "Нет доступа"

**UI состояния:**
- **Initial**: форма готова к заполнению
- **Loading**: кнопка "Сбросить" disabled, отображается spinner
- **Error**: под формой отображается сообщение об ошибке
- **Success**: закрытие модального окна и уведомление

### 4. Активация/деактивация пользователя

#### 4.1. Логика активации/деактивации
**Действие:** При клике на кнопку "Активировать" или "Деактивировать"

**Логика:**
1. Показать подтверждение (confirm dialog):
   - Для деактивации: "Вы уверены, что хотите деактивировать пользователя? Пользователь будет принудительно разлогинен из всех устройств."
   - Для активации: "Вы уверены, что хотите активировать пользователя?"
2. При подтверждении:
   - Отправить PUT запрос на `/admin-api/user/:userId/activate`:
     ```json
     {
       "isActive": true/false
     }
     ```
3. Обработка ответа:
   - **Успех (200 OK)**: обновить список пользователей, показать уведомление "Пользователь успешно активирован/деактивирован"
   - **Ошибка (400 Bad Request)**: показать сообщение об ошибке (например, "Нельзя деактивировать самого себя")
   - **Ошибка (404 Not Found)**: показать сообщение "Пользователь не найден"
   - **Ошибка (403 Forbidden)**: показать сообщение "Нет доступа"

### 5. Удаление пользователя

#### 5.1. Логика удаления
**Действие:** При клике на кнопку "Удалить"

**Логика:**
1. Показать подтверждение (confirm dialog):
   - "Вы уверены, что хотите удалить пользователя? Это действие нельзя отменить. Пользователь будет принудительно разлогинен из всех устройств."
   - Кнопки: "Отмена" и "Удалить"
2. При подтверждении:
   - Показать индикатор загрузки
   - Отправить DELETE запрос на `/admin-api/user/:userId`
3. Обработка ответа:
   - **Успех (204 No Content)**: обновить список пользователей, показать уведомление "Пользователь успешно удален"
   - **Ошибка (400 Bad Request)**: показать сообщение об ошибке (например, "Нельзя удалить самого себя")
   - **Ошибка (404 Not Found)**: показать сообщение "Пользователь не найден"
   - **Ошибка (403 Forbidden)**: показать сообщение "Нет доступа"

### 6. Интеграция с навигацией

#### 6.1. Пункт меню "Управление пользователями"
**Расположение:** В навигации (Sidebar) для ADMIN

**Логика отображения:**
- Пункт меню "Управление пользователями" (`/admin/users`) виден только для ADMIN
- Для MANAGER этот пункт скрыт
- Активный пункт подсвечивается при нахождении на странице

### 7. Валидация на фронтенде

#### 7.1. Email
- Обязательное поле
- Формат email (regex: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`)
- Сообщение об ошибке: "Введите корректный email"
- Проверка уникальности при отправке (ошибка от сервера)

#### 7.2. Password
- Обязательное поле при создании
- Опциональное при редактировании
- Минимальная длина: 8 символов
- Сообщение об ошибке: "Пароль должен содержать минимум 8 символов"

#### 7.3. Подтверждение пароля
- Обязательное поле (только в форме сброса пароля)
- Должен совпадать с новым паролем
- Сообщение об ошибке: "Пароли не совпадают"

#### 7.4. RoleId
- Обязательное поле
- Должен быть выбран один из вариантов (1 или 2)

#### 7.5. RestaurantIds
- Опциональное поле
- Только для MANAGER
- Массив ID ресторанов

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие компоненты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ AdminUsersPage:
   - Страница со списком пользователей
   - Фильтры и поиск
   - Таблица пользователей
   - Пагинация

2. ✅ UserFormModal:
   - Форма создания пользователя
   - Форма редактирования пользователя
   - Валидация всех полей

3. ✅ ResetPasswordModal:
   - Форма сброса пароля
   - Валидация пароля и подтверждения

4. ✅ Интеграция с навигацией:
   - Пункт меню "Управление пользователями" для ADMIN

### Функциональные проверки:
1. ✅ Страница управления пользователями работает:
   - Отображение списка пользователей
   - Фильтрация по роли и статусу
   - Поиск по email
   - Пагинация
   - Сортировка

2. ✅ Загрузка списка ролей работает:
   - GET запрос на `/admin-api/role` при открытии модального окна
   - Отображение ролей в dropdown списке
   - Обработка ошибок

3. ✅ Создание пользователя работает:
   - Валидация всех полей
   - Создание ADMIN пользователя
   - Создание MANAGER пользователя с привязкой к ресторанам
   - Обработка ошибок

4. ✅ Редактирование пользователя работает:
   - Загрузка данных пользователя
   - Обновление email, пароля, роли
   - Обновление привязки к ресторанам
   - Обработка ошибок

5. ✅ Сброс пароля работает:
   - Валидация пароля и подтверждения
   - Отправка запроса на сброс пароля
   - Обработка ошибок

6. ✅ Активация/деактивация работает:
   - Подтверждение действия
   - Отправка запроса
   - Обновление статуса в таблице
   - Обработка ошибок

7. ✅ Удаление пользователя работает:
   - Подтверждение действия
   - Отправка запроса на удаление
   - Обновление списка пользователей
   - Обработка ошибок

8. ✅ Доступ только для ADMIN:
   - MANAGER не может получить доступ к странице
   - Редирект на `/dashboard` с сообщением об ошибке

9. ✅ Валидация работает:
   - Валидация email
   - Валидация пароля (минимум 8 символов)
   - Валидация подтверждения пароля
   - Ошибки отображаются под полями

### Критерии готовности:
- ✅ Все компоненты управления пользователями созданы и работают
- ✅ Валидация всех полей работает на фронтенде
- ✅ Интеграция с API работает корректно
- ✅ Обработка ошибок работает
- ✅ Доступ только для ADMIN работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда:
- Все компоненты управления пользователями работают
- Валидация и обработка ошибок работают корректно
- Доступ только для ADMIN работает
- Все функциональные проверки пройдены успешно


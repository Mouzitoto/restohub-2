# Шаг 4.6: Залы (rooms)

## Описание
Интерфейс для управления залами (помещениями), загрузка планов помещений.

## Задачи

### 1. Страница управления залами

#### 1.1. Компонент RoomsPage
**Маршрут:** `/rooms` (защищенный)

**Структура:**
- Заголовок: "Залы"
- Фильтр по этажу (dropdown)
- Кнопка "Добавить зал"
- Список залов

#### 1.2. Список залов
**Отображение:**
- Grid или таблица
- Для каждого зала:
  - Название
  - Этаж (отображается как цветная метка/badge с названием этажа)
  - Превью плана (если есть)
  - Количество столов (опционально)
  - Кнопки: "Редактировать", "Удалить"

**Фильтрация:**
- Селектор этажа
- GET запрос с параметром `floorId`

#### 1.3. Форма создания/редактирования
**Модальное окно:** RoomFormModal

**Поля:**
```typescript
interface RoomForm {
  name: string;           // required, max 255
  floorId: number;        // required
  description: string;     // optional, max 10000
  imageId: number | null; // optional (план помещения, превью генерируется автоматически)
}
```

**Секции:**
- Основная информация (название, этаж, описание)
- План помещения (ImageUpload компонент)

**Валидация:**
- `name`: обязательное, max 255
- `floorId`: обязательное, должен существовать
- `description`: max 10000

**Логика:**
- Загрузка списка этажей для селектора
- POST `/admin-api/r/:id/room` (создание)
- PUT `/admin-api/r/:id/room/:roomId` (редактирование)

#### 1.4. Загрузка планов помещений
**Компонент:** `ImageUpload` (общий компонент, см. раздел 6.2 в шаге 4.1)

**Использование:**
```typescript
<ImageUpload
  currentImageId={formData.imageId}
  onImageUploaded={(imageId) => setFormData({ ...formData, imageId })}
  onImageRemoved={() => setFormData({ ...formData, imageId: null })}
  type="room"
  recommendedSize="минимум 1920x1080px"
  maxSize={5 * 1024 * 1024} // 5MB
/>
```

#### 1.5. Удаление зала
**Процесс:**
1. При загрузке списка залов:
   - Для каждого зала проверить наличие активных столов
   - Отправить GET запрос на `/admin-api/r/:id/table?roomId=:roomId&limit=1` для каждого зала
   - Если есть активные столы → кнопка "Удалить" неактивна (disabled) или скрыта
   - Визуальная индикация: иконка/тултип "Нельзя удалить: в зале есть активные столы"
2. При клике на "Удалить" (если кнопка активна):
   - Показать модальное окно подтверждения:
     - Заголовок: "Удалить зал?"
     - Текст: "Вы уверены, что хотите удалить зал '{name}'?"
     - Кнопки: "Отмена" и "Удалить"
3. При подтверждении:
   - Показать индикатор загрузки
   - Отправить DELETE запрос на `/admin-api/r/:id/room/:roomId`
4. Обработка ответа:
   - **Успех (204 No Content)**:
     - Закрыть модальное окно
     - Удалить зал из списка
     - Показать уведомление "Зал удален"
   - **Ошибка (400 Bad Request)**:
     - Показать сообщение "Нельзя удалить зал: в зале есть активные столы"
     - Закрыть модальное окно
   - **Ошибка (404 Not Found)**:
     - Показать сообщение "Зал не найден"
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Нет доступа"

### 2. Интеграция с API
- `GET /admin-api/r/:id/floor` - список этажей для фильтра
- `GET /admin-api/r/:id/room` - список залов
- `POST /admin-api/r/:id/room` - создание
- `GET /admin-api/r/:id/room/:roomId` - получение
- `PUT /admin-api/r/:id/room/:roomId` - обновление
- `DELETE /admin-api/r/:id/room/:roomId` - удаление
- `POST /admin-api/image` - загрузка плана

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница залов:
   - Список залов с фильтрацией
   - Форма создания/редактирования
   - Загрузка планов помещений

2. ✅ Интеграция с API:
   - Запросы к `/admin-api/r/:id/room`
   - Запросы к `/admin-api/image` для загрузки планов
   - Обработка ответов
   - Обработка ошибок

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание зала
   - Редактирование зала
   - Удаление зала

2. ✅ Загрузка планов работает:
   - Планы загружаются через `/admin-api/image`
   - Компонент `ImagePreview` отображает превью корректно
   - При клике на превью открывается модальное окно с оригинальным изображением

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Валидация работает
- ✅ Загрузка планов работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


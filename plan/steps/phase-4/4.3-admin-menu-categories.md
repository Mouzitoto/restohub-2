# Шаг 4.3: Категории меню

## Описание
Интерфейс для управления категориями блюд: создание, редактирование, порядок отображения.

## Задачи

### 1. Страница управления категориями

#### 1.1. Компонент MenuCategoriesPage
**Маршрут:** `/menu/categories` (защищенный)

**Структура страницы:**
- Заголовок: "Категории меню"
- Примечание: "Категории меню являются глобальными и используются всеми ресторанами"
- Кнопка "Создать категорию" (только для ADMIN, скрыта для MANAGER)
- Список категорий (сортировка по `displayOrder`)
- Для каждой категории:
  - Название
  - Описание (если есть)
  - Порядковый номер
  - Кнопки действий: "Редактировать" (ADMIN), "Удалить" (ADMIN)

#### 1.2. Список категорий
**Компонент:** CategoryList

**Отображение:**
- Таблица или карточки с категориями
- Сортировка по умолчанию: `displayOrder ASC`
- Для каждой категории:
  - Название (жирным)
  - Описание (если есть, серым текстом, обрезанное если длинное)
  - Порядковый номер (`displayOrder`)
  - Количество блюд в категории (опционально, из отдельного запроса)
  - Иконка drag handle (для изменения порядка)

**Логика загрузки:**
1. При загрузке страницы:
   - Показать skeleton loader
   - Отправить GET запрос на `/admin-api/menu-category?sortBy=displayOrder&sortOrder=asc`
   - Для MANAGER: категории доступны только для просмотра
2. При получении данных:
   - Отобразить список категорий
   - Если список пуст → показать сообщение "Категории не найдены. Создайте первую категорию." (только для ADMIN)
3. При ошибке:
   - Показать сообщение об ошибке
   - Кнопка "Повторить запрос"

**Обработка ошибок:**
- 401 Unauthorized → редирект на `/login`
- 403 Forbidden → показать сообщение "Только администратор может управлять категориями"

### 2. Форма создания/редактирования категории

#### 2.1. Компонент CategoryFormModal
**Тип:** Модальное окно

**Структура:**
- Заголовок: "Создать категорию" или "Редактировать категорию"
- Форма с полями
- Кнопки: "Отмена" и "Сохранить"

**Поля формы:**
```typescript
interface CategoryForm {
  name: string;           // required, max 255
  description: string;     // optional, max 10000
  displayOrder: number;   // optional, min: 0, default: последний порядок + 1
}
```

**Валидация на фронтенде:**
- **name**:
  - Обязательное поле
  - Максимальная длина: 255 символов
  - Не может быть пустой строкой (после trim)
  - Сообщение: "Название категории обязательно"
- **description**:
  - Максимальная длина: 10000 символов
  - Счетчик символов (опционально)
- **displayOrder**:
  - Минимальное значение: 0
  - По умолчанию: последний `displayOrder + 1` (при создании)
  - При редактировании: текущее значение

**Логика создания:**
1. При открытии модального окна (создание):
   - Загрузить список категорий для определения последнего `displayOrder`
   - Установить `displayOrder = max(displayOrder) + 1` (глобально)
   - Очистить форму
2. При открытии модального окна (редактирование):
   - Заполнить форму данными категории
3. При отправке формы:
   - Валидация полей
   - Если валидация не прошла → показать ошибки под полями
   - Если валидация прошла:
     - Показать индикатор загрузки
     - Отправить POST запрос на `/admin-api/menu-category`:
       ```json
       {
         "name": "Горячие блюда",
         "description": "Основные горячие блюда",
         "displayOrder": 1
       }
       ```
4. Обработка ответа:
   - **Успех (201 Created)**:
     - Закрыть модальное окно
     - Обновить список категорий
     - Показать уведомление "Категория создана"
   - **Ошибка (400 Bad Request)**:
     - Показать ошибки валидации под полями
     - Если дубликат названия → сообщение "Категория с таким названием уже существует"
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Только администратор может создавать категории"
     - Закрыть модальное окно

**Логика редактирования:**
1. При клике на "Редактировать":
   - Открыть модальное окно с заполненной формой
2. При отправке формы:
   - Отправить PUT запрос на `/admin-api/menu-category/:categoryId`
3. Обработка ответа:
   - Аналогично созданию
   - При успехе: "Категория обновлена"

### 3. Изменение порядка категорий

#### 3.1. Drag & Drop функциональность
**Библиотека:** react-beautiful-dnd или @dnd-kit/core

**Логика:**
1. При перетаскивании категории:
   - Визуальная индикация перемещения (highlight, shadow)
   - Обновление порядка в UI (оптимистичное обновление)
2. При завершении перетаскивания:
   - Вычислить новые значения `displayOrder` для всех категорий
   - Отправить PUT запрос на `/admin-api/menu-category/reorder`:
     ```json
     {
       "categories": [
         { "id": 1, "displayOrder": 0 },
         { "id": 2, "displayOrder": 1 },
         { "id": 3, "displayOrder": 2 }
       ]
     }
     ```
3. Обработка ответа:
   - **Успех (200 OK)**:
     - Обновить список категорий
     - Показать уведомление "Порядок категорий обновлен"
   - **Ошибка**:
     - Откатить изменения в UI (вернуть к исходному порядку)
     - Показать сообщение об ошибке

**Альтернатива (без drag & drop):**
- Кнопки "Вверх" и "Вниз" для каждой категории
- При клике → обменять `displayOrder` с соседней категорией

### 4. Удаление категории

#### 4.1. Логика удаления
**Доступ:** Только ADMIN

**Процесс:**
1. При клике на "Удалить":
   - Показать модальное окно подтверждения:
     - Заголовок: "Удалить категорию?"
     - Текст: "Вы уверены, что хотите удалить категорию '{name}'?"
     - Дополнительно: проверить наличие блюд в категории:
       - Если есть блюда → показать предупреждение: "В этой категории есть блюда. Удаление категории скроет её из меню, но блюда останутся в системе."
     - Кнопки: "Отмена" и "Удалить"
2. При подтверждении:
   - Показать индикатор загрузки
   - Отправить DELETE запрос на `/admin-api/menu-category/:categoryId`
3. Обработка ответа:
   - **Успех (204 No Content)**:
     - Закрыть модальное окно
     - Удалить категорию из списка (или пометить как неактивную)
     - Показать уведомление "Категория удалена"
   - **Ошибка (400 Bad Request)**:
     - Показать сообщение: "Невозможно удалить категорию. В категории есть активные блюда."
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Только администратор может удалять категории"
   - **Ошибка (404 Not Found)**:
     - Показать сообщение "Категория не найдена"

### 5. Проверка наличия блюд в категории

#### 5.1. Предварительная проверка
**Логика:**
1. Перед удалением (опционально):
   - Отправить GET запрос на `/admin-api/r/:id/menu-item?categoryId=:categoryId&limit=1`
   - Если есть блюда:
     - Показать предупреждение в модальном окне подтверждения
     - Разрешить удаление, но с предупреждением
2. Серверная проверка:
   - Сервер проверяет наличие активных блюд перед удалением
   - Если есть активные блюда → вернуть ошибку 400

### 6. UX улучшения

#### 6.1. Визуальная индикация
- Порядковый номер отображается рядом с названием категории
- При drag & drop: визуальная обратная связь (highlight, анимация)
- Индикатор загрузки при операциях (создание, редактирование, удаление, изменение порядка)

#### 6.2. Модальные окна
- Анимация открытия/закрытия
- Закрытие по клику вне модального окна (опционально)
- Закрытие по Escape
- Блокировка прокрутки фона при открытом модальном окне

#### 6.3. Уведомления
- Toast уведомления для успешных операций
- Toast уведомления для ошибок
- Автоматическое скрытие через 3-5 секунд

#### 6.4. Обработка состояний
- **Loading**: skeleton loaders для списка
- **Empty**: сообщение "Категории не найдены" с кнопкой "Создать категорию"
- **Error**: сообщение об ошибке с кнопкой "Повторить"
- **Success**: нормальное отображение списка

### 7. Интеграция с API

#### 7.1. Endpoints
- `GET /admin-api/menu-category` - получение списка
- `POST /admin-api/menu-category` - создание (только ADMIN)
- `GET /admin-api/menu-category/:categoryId` - получение одной категории
- `PUT /admin-api/menu-category/:categoryId` - обновление (только ADMIN)
- `DELETE /admin-api/menu-category/:categoryId` - удаление (только ADMIN)
- `PUT /admin-api/menu-category/reorder` - массовое изменение порядка (только ADMIN)

#### 7.2. Обработка ошибок
- Стандартизированная обработка всех HTTP статусов
- Отображение понятных сообщений пользователю
- Логирование ошибок для отладки (опционально)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница категорий меню:
   - Список категорий
   - Форма создания/редактирования
   - Drag & drop для изменения порядка

2. ✅ Интеграция с API:
   - Запросы к `/admin-api/menu-category`
   - Обработка ответов
   - Обработка ошибок

3. ✅ Валидация:
   - Проверка обязательных полей
   - Проверка перед удалением

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание категории
   - Редактирование категории
   - Удаление категории
   - Изменение порядка

2. ✅ UX работает:
   - Drag & drop работает
   - Модальные окна работают
   - Подтверждение удаления работает

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Валидация работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


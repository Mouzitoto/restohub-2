# Шаг 4.2: Управление рестораном

## Описание
Интерфейс для редактирования информации о ресторане и настройки дизайна персональной страницы.

## Задачи

### 1. Страница редактирования информации о ресторане

#### 1.1. Компонент RestaurantEditPage
**Маршрут:** `/restaurant` (защищенный, для MANAGER) или `/admin/restaurants/:id` (для ADMIN)

**Структура страницы:**
- Заголовок: "Редактирование ресторана"
- Форма на одной странице со следующими секциями (вертикально расположенными):
  - "Основная информация"
  - "Дизайн страницы"
  - "Управление подпиской" (только для ADMIN)
- Кнопка "Сохранить" (sticky внизу или в header)
- Кнопка "Предпросмотр" (в header)

#### 1.2. Форма основной информации
**Секция на странице:** "Основная информация"

**Поля формы:**
```typescript
interface RestaurantForm {
  name: string;              // required, max 255
  address: string;           // optional, max 500
  phone: string;             // optional, phone format
  whatsapp: string;        // optional, phone format
  instagram: string;        // optional, instagram link format
  description: string;      // optional, TEXT
  latitude: number;         // optional, decimal
  longitude: number;       // optional, decimal
  workingHours: string;    // optional, TEXT
  managerLanguageCode: string; // optional, default: 'ru', max 10, допустимые значения: 'ru', 'en', 'kz' и т.д.
  isActive: boolean;        // required, default: true
}
```

**Валидация на фронтенде:**
- **name**: 
  - Обязательное поле
  - Максимальная длина: 255 символов
  - Сообщение: "Название ресторана обязательно"
- **address**:
  - Максимальная длина: 500 символов
- **phone**:
  - Формат: `+7XXXXXXXXXX` или `8XXXXXXXXXX`
  - Regex: `/^(\+7|8)\d{10}$/`
  - Сообщение: "Введите корректный номер телефона"
- **whatsapp**:
  - Формат телефона (аналогично phone)
- **instagram**:
  - Формат: должен начинаться с `https://instagram.com/` или `https://www.instagram.com/`
  - Regex: `/^https?:\/\/(www\.)?instagram\.com\/[\w.]+$/`
  - Сообщение: "Введите корректную ссылку на Instagram"
- **description**:
  - Максимальная длина: 10000 символов
- **latitude/longitude**:
  - Диапазон: latitude [-90, 90], longitude [-180, 180]
  - Формат: decimal с точностью до 8 знаков после запятой
- **managerLanguageCode**:
  - Опциональное поле
  - По умолчанию: `'ru'`
  - Формат: код языка ISO 639-1 (2 буквы в нижнем регистре)
  - Regex: `/^[a-z]{2}$/`
  - Допустимые значения: `'ru'`, `'en'`, `'kz'` и т.д.
  - Сообщение: "Введите корректный код языка (например: ru, en, kz)"

**Компонент карты для геолокации:**
- Библиотека: Leaflet или Google Maps
- Интерактивная карта с маркером
- При клике на карту → обновление координат (latitude, longitude)
- Поиск по адресу → автоматическое определение координат
- Отображение текущих координат (если есть)

**Логика загрузки данных:**
1. При загрузке страницы:
   - Отправить GET запрос на `/admin-api/r/:id` (для MANAGER) или `/admin-api/r/:id` (для ADMIN)
   - Заполнить форму данными ресторана
   - Загрузить карту с текущими координатами
2. При получении данных:
   - Заполнить все поля формы
   - Установить маркер на карте
   - Загрузить текущие изображения (логотип, фон)

**Логика сохранения:**
1. При клике на "Сохранить":
   - Валидация всех полей на фронтенде
   - Если валидация не прошла → показать ошибки под полями
   - Если валидация прошла:
     - Показать индикатор загрузки
     - Отправить PUT запрос на `/admin-api/r/:id`:
       ```json
       {
         "name": "Ресторан",
         "address": "ул. Примерная, 1",
         "phone": "+79991234567",
         "whatsapp": "+79991234567",
         "instagram": "https://instagram.com/restaurant",
         "description": "Описание ресторана",
         "latitude": 55.7558,
         "longitude": 37.6173,
         "workingHours": "Пн-Вс: 10:00 - 22:00",
         "managerLanguageCode": "ru",
         "isActive": true
       }
       ```
2. Обработка ответа:
   - **Успех (200 OK)**:
     - Показать уведомление "Изменения сохранены"
     - Обновить данные в форме (если сервер вернул обновленные данные)
   - **Ошибка (400 Bad Request)**:
     - Показать ошибки валидации под соответствующими полями
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Нет доступа к редактированию этого ресторана"
   - **Ошибка (404 Not Found)**:
     - Показать сообщение "Ресторан не найден"

#### 1.3. Секция "Дизайн страницы"
**Структура:**
- Подсекции (вертикально расположенные):
  - "Логотип ресторана"
  - "Фоновое изображение"

#### 1.4. Загрузка изображений (логотип и фон)
**Компонент:** `ImageUpload` (общий компонент, см. раздел 6.2 в шаге 4.1)

**Для логотипа:**
```typescript
<ImageUpload
  currentImageId={formData.logoImageId}
  onImageUploaded={(imageId) => setFormData({ ...formData, logoImageId: imageId })}
  onImageRemoved={() => setFormData({ ...formData, logoImageId: null })}
  type="logo"
  recommendedSize="200x200px - 500x500px"
  maxSize={5 * 1024 * 1024} // 5MB
/>
```

**Для фона:**
```typescript
<ImageUpload
  currentImageId={formData.bgImageId}
  onImageUploaded={(imageId) => setFormData({ ...formData, bgImageId: imageId })}
  onImageRemoved={() => setFormData({ ...formData, bgImageId: null })}
  type="background"
  recommendedSize="минимум 1920x1080px"
  maxSize={5 * 1024 * 1024} // 5MB
/>
```

#### 1.5. Отображение текущих изображений
**Для логотипа:**
- Использовать компонент `ImagePreview` с `imageId={logoImageId}`
- Кнопка "Удалить" → установить `logoImageId = null` в форме
- Placeholder: "Логотип не загружен"

**Для фона:**
- Использовать компонент `ImagePreview` с `imageId={bgImageId}`
- Кнопка "Удалить" → установить `bgImageId = null` в форме
- Placeholder: "Фоновое изображение не загружено"

#### 1.6. Секция "Управление подпиской" (только для ADMIN)
**Условия отображения:**
- Видна только для ADMIN (`role === 'ADMIN'`)
- Скрыта для MANAGER

**Структура:**
- Заголовок секции: "Управление подпиской"
- Информация о текущей подписке (если есть)
- Форма для управления подпиской

**Отображение текущей подписки:**
- Тарифный план (название, описание, цена)
- Дата начала: `startDate`
- Дата окончания: `endDate`
- Дней осталось: `daysRemaining`
- Статус: `isActive` (badge с цветом)
- Предупреждение: `isExpiringSoon` (если `daysRemaining <= 7`)
- Если подписки нет → показать сообщение "Подписка не активирована"

**Форма управления подпиской:**
```typescript
interface SubscriptionForm {
  subscriptionTypeId?: number;  // optional
  startDate?: string;           // optional, date format YYYY-MM-DD
  endDate?: string;             // optional, date format YYYY-MM-DD
  isActive?: boolean;           // optional
  description?: string;         // optional, max 10000
}
```

**Поля формы:**

**При создании новой подписки (если подписки нет):**
- **Тип подписки** (dropdown, **обязательное**):
  - Загрузить список типов подписки из API (если есть endpoint)
  - Или использовать список из констант/конфигурации
  - Валидация: обязательное поле
- **Дата начала** (date picker, опционально):
  - Формат: YYYY-MM-DD
  - По умолчанию: текущая дата (CURRENT_DATE)
  - Валидация: дата не должна быть в будущем
- **Дата окончания** (date picker, **обязательное**):
  - Формат: YYYY-MM-DD
  - Валидация: `endDate >= startDate` (если указана `startDate`)
  - Валидация: дата должна быть в будущем
  - Сообщение: "Дата окончания обязательна и должна быть в будущем"
- **Статус активности** (checkbox, опционально):
  - По умолчанию: `true` (активна)
- **Описание** (textarea, опционально):
  - Максимальная длина: 10000 символов
  - Используется для указания причины создания подписки

**При обновлении существующей подписки:**
- **Тип подписки** (dropdown, опционально):
  - Загрузить список типов подписки из API
  - Предзаполнить текущим значением
  - Оставить пустым, если тип не меняется
- **Дата начала** (date picker, опционально):
  - Формат: YYYY-MM-DD
  - Предзаполнить текущим значением
  - Валидация: дата не должна быть в будущем (при изменении)
- **Дата окончания** (date picker, опционально):
  - Формат: YYYY-MM-DD
  - Предзаполнить текущим значением
  - Валидация: `endDate >= startDate` (если указаны обе даты)
  - Валидация: дата должна быть в будущем (при изменении)
- **Статус активности** (checkbox, опционально):
  - Предзаполнить текущим значением `isActive`
  - "Активна" / "Неактивна"
- **Описание** (textarea, опционально):
  - Максимальная длина: 10000 символов
  - Используется для указания причины продления/отмены

**Логика загрузки данных:**
1. При загрузке страницы (только для ADMIN):
   - Отправить GET запрос на `/admin-api/r/:id/subscription`
   - Если подписка найдена:
     - Заполнить информацию о текущей подписке
     - Показать форму для обновления (все поля опциональны)
   - Если подписки нет (404 или `isActive = false`):
     - Показать форму для создания новой подписки
     - Обязательные поля: `subscriptionTypeId`, `endDate` (или `startDate` и `endDate`)

**Логика сохранения:**
1. При клике на "Сохранить подписку" или "Создать подписку":
   - Валидация всех полей на фронтенде
   - **При создании:** обязательные поля: `subscriptionTypeId`, `endDate`
   - **При обновлении:** все поля опциональны
   - Если валидация не прошла → показать ошибки под полями
   - Если валидация прошла:
     - Показать индикатор загрузки
     - Отправить PUT запрос на `/admin-api/r/:id/subscription`:
       ```json
       {
         "subscriptionTypeId": 1,
         "startDate": "2024-01-01",
         "endDate": "2024-02-29",
         "isActive": true,
         "description": "Создание подписки" // или "Продление подписки"
       }
       ```
     - **Примечание:** API автоматически создаст подписку, если её нет, или обновит существующую
2. Обработка ответа:
   - **Успех (200 OK)**:
     - Если подписки не было → показать уведомление "Подписка создана"
     - Если подписка была → показать уведомление "Подписка обновлена"
     - Обновить информацию о подписке
     - Переключить форму в режим "обновления" (если была в режиме "создания")
   - **Ошибка (400 Bad Request)**:
     - Показать ошибки валидации под полями
     - Проверить `exceptionName` в response body для конкретных ошибок
   - **Ошибка (403 Forbidden)**:
     - Показать сообщение "Только администратор может управлять подпиской"
   - **Ошибка (404 Not Found)**:
     - Показать сообщение "Ресторан не найден"

**Валидация на фронтенде:**

**При создании новой подписки:**
- **subscriptionTypeId**: 
  - Обязательное поле
  - Сообщение: "Выберите тип подписки"
- **endDate**: 
  - Обязательное поле
  - Если указана `startDate` → `endDate >= startDate`
  - Дата должна быть в будущем
  - Сообщение: "Дата окончания обязательна и должна быть в будущем"
- **startDate**:
  - Опциональное поле
  - Если не указана → использовать текущую дату на бэкенде
  - Если указана → не должна быть в будущем
  - Сообщение: "Дата начала не должна быть в будущем"

**При обновлении существующей подписки:**
- **endDate**: 
  - Опциональное поле
  - Если указана `startDate` → `endDate >= startDate`
  - Если изменяется → дата должна быть в будущем
  - Сообщение: "Дата окончания должна быть позже даты начала и в будущем"
- **startDate**:
  - Опциональное поле
  - Если изменяется → не должна быть в будущем

**Общие правила:**
- **description**:
  - Максимальная длина: 10000 символов
  - Сообщение: "Описание не должно превышать 10000 символов"

**Кнопки действий:**
- **Если подписки нет:**
  - "Создать подписку" - создать новую подписку
- **Если подписка есть:**
  - "Сохранить подписку" - сохранить изменения
  - "Отменить подписку" (опционально) - установить `isActive = false` с подтверждением

### 2. Предпросмотр персональной страницы

#### 2.1. Кнопка "Предпросмотр"
**Расположение:** В header страницы редактирования

**Логика:**
1. При клике:
   - Открыть новую вкладку с URL: `/client-api/r/:id` (публичная страница ресторана)
   - Или открыть модальное окно с iframe:
     ```html
     <iframe src="/client-api/r/:id" width="100%" height="600px" />
     ```

**Альтернатива:** Встроенный preview в правой панели (split view)

### 3. Управление изображениями

#### 3.1. Удаление изображений
**Логика:**
1. При клике на "Удалить":
   - Показать подтверждение: "Вы уверены, что хотите удалить это изображение?"
   - При подтверждении:
     - Установить `logoImageId = null` или `bgImageId = null` в форме
     - Компонент `ImagePreview` автоматически покажет placeholder
     - Изображение не удаляется из БД сразу, только отвязывается от ресторана
     - При сохранении формы → изображение отвяжется на сервере

#### 3.2. Замена изображений
- При загрузке нового изображения:
  - Если уже есть изображение → автоматически заменить
  - Старое изображение отвязывается, новое привязывается

### 4. Сохранение настроек

#### 4.1. Кнопка "Сохранить"
**Расположение:** Sticky внизу страницы или в header

**Логика:**
1. При клике:
   - Валидация всех полей (включая изображения)
   - Если валидация не прошла → прокрутить к первой ошибке
   - Если валидация прошла:
     - Показать индикатор загрузки (disabled кнопка, spinner)
     - Отправить PUT запрос на `/admin-api/r/:id` со всеми данными формы
2. Обработка ответа:
   - **Успех (200 OK)**:
     - Показать toast уведомление "Настройки сохранены"
     - Скрыть индикатор загрузки
   - **Ошибка**:
     - Показать сообщение об ошибке
     - Скрыть индикатор загрузки

#### 4.2. Автосохранение (опционально)
- Автоматическое сохранение изменений каждые 30 секунд (debounce)
- Индикатор "Сохранено" в углу экрана
- Отключить при наличии ошибок валидации

#### 4.3. Обработка ошибок
- **400 Bad Request**: Показать ошибки валидации под полями
- **401 Unauthorized**: Редирект на `/login`
- **403 Forbidden**: Показать сообщение "Нет доступа"
- **404 Not Found**: Показать сообщение "Ресторан не найден"
- **500 Server Error**: Показать сообщение "Ошибка сервера. Попробуйте позже"


# Шаг 4.7: Столы

## Описание
Интерфейс для управления столами, визуальный редактор карты расположения, загрузка фото.

## Задачи

### 1. Страница управления столами

#### 1.1. Компонент TablesPage
**Маршрут:** `/tables` (защищенный)

**Структура:**
- Заголовок: "Столы"
- Табы/секции:
  - "Список столов"
  - "Карта расположения"
- Фильтры: этаж, зал

#### 1.2. Список столов
**Отображение:**
- Таблица с колонками:
  - Номер стола
  - Зал
  - Этаж
  - Количество мест
  - Характеристики (иконки)
  - Фото через компонент `ImagePreview` с `imageId={table.imageId}`
  - Действия

**Фильтрация:**
- По этажу (dropdown)
- По залу (dropdown, зависит от этажа)
- По характеристикам (чекбоксы)

**Логика:**
- GET запрос на `/admin-api/r/:id/table` с фильтрами

#### 1.3. Форма создания/редактирования
**Модальное окно:** TableFormModal

**Поля:**
```typescript
interface TableForm {
  tableNumber: string;        // required, max 50
  roomId: number;             // required
  capacity: number;            // required, 1-100
  hasWindow: boolean;          // optional, default: false
  hasAirConditioning: boolean; // optional, default: false
  isSmoking: boolean;         // optional, default: false
  imageId: number | null;     // optional
}
```

**Секции:**
- Основная информация (номер, зал, количество мест)
- Характеристики (чекбоксы)
- Фото стола (ImageUpload)

**Валидация:**
- `tableNumber`: обязательное, max 50, уникальность в зале
- `roomId`: обязательное
- `capacity`: обязательное, 1-100

#### 1.4. Визуальный редактор карты

#### 1.4.1. Компонент TableMapEditor
**Библиотека:** react-konva или fabric.js для Canvas, или SVG с react-draggable

**Структура:**
- Левая панель: список залов (селектор)
- Центральная область: карта зала с планом помещения (фон)
- Правая панель: список столов зала (для добавления на карту)

**Функциональность:**
1. Загрузка плана зала:
   - GET запрос на `/admin-api/r/:id/room/:roomId` для получения `imageId`
   - Отображение плана как фона карты
2. Отображение столов:
   - Каждый стол → иконка/прямоугольник на карте
   - Позиция из координат (если есть в БД, опционально)
   - Визуальная индикация характеристик (цвет, иконки)
3. Drag & drop:
   - Перетаскивание столов на карту
   - Изменение позиции существующих столов
   - Сохранение координат (x, y) в БД (если реализовано)
4. Zoom и Pan:
   - Колесико мыши для zoom
   - Перетаскивание для pan
   - Кнопки управления zoom
5. Сетка (опционально):
   - Включение/выключение сетки
   - Привязка к сетке при перемещении

**Логика сохранения координат:**
- При перемещении стола:
  - Оптимистичное обновление в UI
  - Debounce 500ms перед отправкой
  - PUT запрос на `/admin-api/r/:id/table/:tableId` с координатами (если поле есть в БД)

#### 1.4.2. Режимы просмотра
- **Режим редактирования:**
  - Возможность перемещать столы
  - Отображение инструментов
  - Кнопка "Сохранить изменения"
- **Режим просмотра:**
  - Только просмотр (как видит клиент)
  - Нет возможности редактировать
  - Переключение через кнопку

#### 1.5. Загрузка фото столов
**Компонент:** `ImageUpload` (общий компонент, см. раздел 6.2 в шаге 4.1)

**Использование:**
```typescript
<ImageUpload
  currentImageId={formData.imageId}
  onImageUploaded={(imageId) => setFormData({ ...formData, imageId })}
  onImageRemoved={() => setFormData({ ...formData, imageId: null })}
  type="table"
  recommendedSize="800x600px - 1200x900px"
  maxSize={5 * 1024 * 1024} // 5MB
/>
```

**Особенности:**
- Рекомендуемые размеры: 800x600px
- Одно изображение на стол

#### 1.6. Удаление стола
**Процесс:**
1. Модальное окно подтверждения
2. Проверка наличия активных бронирований (предупреждение, опционально)
3. DELETE запрос на `/admin-api/r/:id/table/:tableId`

### 2. Интеграция с API
- `GET /admin-api/r/:id/table` - список столов
- `GET /admin-api/r/:id/table/map` - карта столов (иерархическая структура)
- `POST /admin-api/r/:id/table` - создание
- `GET /admin-api/r/:id/table/:tableId` - получение
- `PUT /admin-api/r/:id/table/:tableId` - обновление
- `DELETE /admin-api/r/:id/table/:tableId` - удаление
- `GET /admin-api/r/:id/room` - список залов для фильтра
- `GET /admin-api/r/:id/room/:roomId` - получение зала с планом
- `POST /admin-api/image` - загрузка фото

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница столов:
   - Список столов с фильтрацией
   - Форма создания/редактирования
   - Визуальный редактор карты

2. ✅ Интеграция с API:
   - Запросы к `/admin-api/r/:id/table`
   - Запросы к `/admin-api/image` для загрузки фото
   - Обработка ответов
   - Обработка ошибок

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание стола
   - Редактирование стола
   - Удаление стола

2. ✅ Визуальный редактор работает:
   - Drag & drop работает
   - Координаты сохраняются
   - Переключение между залами работает

3. ✅ Загрузка фото работает:
   - Фото загружаются через `/admin-api/image`
   - Компонент `ImagePreview` отображает превью корректно
   - При клике на превью открывается модальное окно с оригинальным изображением

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Визуальный редактор работает
- ✅ Загрузка фото работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.


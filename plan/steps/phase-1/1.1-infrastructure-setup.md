# Шаг 1.1: Настройка инфраструктуры

## Описание
Настройка базовой инфраструктуры проекта: структура монорепо, Docker окружение для всех сервисов, база данных PostgreSQL, и инициализация всех компонентов системы.

## Технологический стек

### Backend
- **Java 21** - язык программирования
- **Spring Boot** (последняя стабильная версия) - framework
- **Maven** - система сборки
- **Spring Data JPA** - работа с БД через ORM
- **Liquibase** - миграции базы данных (native SQL)

### Frontend
- **React** - фреймворк (best practices для проектов подобной сложности)
- **Vite** - инструмент для инициализации и сборки (современная альтернатива Create React App)
- **TypeScript** - для масштабируемости и типобезопасности
- **React Router** - маршрутизация

### Инфраструктура
- **Docker** и **docker-compose** (без тире для Windows)
- **PostgreSQL** (последняя стабильная версия)

## Задачи

### 1. Создание структуры монорепо
- Создать корневую структуру проекта:
  ```
  resto-hub/
  ├── client-api/        # Spring Boot API для клиентов
  ├── client-web/        # React приложение для клиентов
  ├── admin-api/         # Spring Boot API для админов/менеджеров
  ├── admin-web/         # React приложение для админов/менеджеров
  ├── database/           # Миграции и скрипты БД
  ├── docker-compose.yml  # Docker конфигурация
  └── .gitignore
  ```
- Настроить `.gitignore` для монорепо

### 2. Настройка Docker и docker-compose
- Создать `docker-compose.yml` в корне проекта
- **Примечание**: Docker Compose содержит все сервисы системы. Локально поднимаются только те сервисы, которые не разрабатываются в данный момент.
  - Пример: если ведется разработка client-api и client-web локально, то admin-api и admin-web запускаются через docker-compose
  - Пример: если ведется разработка admin-api и admin-web локально, то client-api и client-web запускаются через docker-compose
- Настроить все сервисы в docker-compose.yml:
  - **postgres** - PostgreSQL контейнер (последняя стабильная версия, порт 5432) - всегда в Docker
  - **client-api** - Spring Boot приложение (Java 21, порт 8081)
  - **admin-api** - Spring Boot приложение (Java 21, порт 8082)
  - **client-web** - React приложение (Node.js, порт 3000)
  - **admin-web** - React приложение (Node.js, порт 3001)
  - **seed** - сервис для запуска seed скриптов (одноразовый запуск)
- Настроить volumes:
  - Данные PostgreSQL (персистентность)
  - Миграции базы данных (для Liquibase)
  - Исходный код для сервисов в Docker (для возможности hot-reload в контейнерах, опционально)
- Настроить networking между всеми сервисами
- Настроить health checks для сервисов
- Порты по умолчанию:
  - client-api: 8081
  - admin-api: 8082
  - client-web: 3000
  - admin-web: 3001
  - postgres: 5432

### 3. Настройка PostgreSQL базы данных
- Использовать официальный Docker образ PostgreSQL (последняя стабильная версия)
- Настроить переменные окружения:
  - POSTGRES_DB
  - POSTGRES_USER
  - POSTGRES_PASSWORD
  - POSTGRES_PORT: 5432
- Настроить volume для персистентности данных
- Настроить автоматическое применение миграций через Liquibase при старте Spring Boot приложений

### 4. Настройка базовой структуры компонентов

#### client-api (Spring Boot)
- Инициализация Spring Boot проекта (Java 21, Maven)
- **Независимый pom.xml** (без parent POM, микросервисная архитектура)
- Базовая структура пакетов:
  ```
  com.restohub.clientapi/
  ├── controller/
  ├── service/
  ├── repository/
  ├── entity/
  ├── dto/
  ├── config/
  └── RestoHubClientApiApplication.java
  ```
- Настройка Spring Data JPA (только для чтения Entity, не для генерации схемы)
- Настройка подключения к PostgreSQL
- Настройка **Liquibase** для автоматического применения миграций при старте
- Базовая конфигурация CORS
- **Rate Limiter** для защиты от DDoS атак (Spring Cloud Gateway Rate Limiter или Bucket4j)
- **Circuit Breaker** (опционально, Spring Cloud Circuit Breaker / Resilience4j) - для защиты от каскадных сбоев при вызовах внешних сервисов
- **Health checks** через Spring Boot Actuator
- Application properties/yml для конфигурации
- `.env` файл в корне client-api/
- **Без версионирования API** (фронты под нашим управлением)

#### admin-api (Spring Boot)
- Инициализация Spring Boot проекта (Java 21, Maven)
- **Независимый pom.xml** (без parent POM, микросервисная архитектура)
- Базовая структура пакетов (аналогично client-api)
- Настройка Spring Data JPA (только для чтения Entity, не для генерации схемы)
- Настройка подключения к PostgreSQL
- Настройка **Liquibase** для автоматического применения миграций при старте
- **OAuth2.0** для аутентификации и авторизации
- **Ролевая политика** через `@PreAuthorize(hasRole("ADMIN"))` и `@PreAuthorize(hasRole("MANAGER"))`
- Базовая конфигурация CORS
- **Health checks** через Spring Boot Actuator
- Application properties/yml для конфигурации
- `.env` файл в корне admin-api/

#### client-web (React)
- Инициализация React проекта через **Vite** (TypeScript template)
- **Независимый проект** (микросервисная архитектура)
- Настройка структуры папок:
  ```
  client-web/
  ├── src/
  │   ├── components/
  │   ├── pages/
  │   ├── services/
  │   ├── hooks/
  │   ├── utils/
  │   ├── types/
  │   └── App.tsx
  ├── public/
  ├── package.json
  ├── tsconfig.json
  └── vite.config.ts
  ```
- Настройка роутинга (React Router)
- Настройка работы с API (fetch/axios)
- `.env` файл в корне client-web/ (переменные с префиксом `VITE_`)

#### admin-web (React)
- Инициализация React проекта через **Vite** (TypeScript template)
- **Независимый проект** (микросервисная архитектура)
- Аналогичная структура как в client-web
- `.env` файл в корне admin-web/ (переменные с префиксом `VITE_`)

#### database/
- Структура для миграций (Liquibase):
  ```
  database/
  ├── liquibase/
  │   ├── changelog/
  │   │   └── db.changelog-master.xml
  │   └── changesets/
  │       └── V1__initial_schema.sql
  ├── seed/
  │   └── seed-data.sql    # Seed данные с IF NOT EXISTS
  └── README.md
  ```

### 5. Хранение файлов
- На первом этапе: хранение файлов (фото блюд, столов, логотипы) в БД в виде **BLOB** (тип `bytea` в PostgreSQL)
- **Хранение в двух вариантах:**
  - **Оригинал** - полный размер изображения
  - **Превью** - уменьшенная версия для быстрой загрузки (размеры будут определены позже)
- Структура таблиц для хранения изображений:
  - `menu_item_images` - фотографии блюд (поля: `original_image_data` типа `bytea`, `preview_image_data` типа `bytea`)
  - `table_images` - фотографии столов (поля: `original_image_data` типа `bytea`, `preview_image_data` типа `bytea`)
  - Для логотипов и фонов ресторанов - аналогичная структура (поля в таблице `restaurants`: `logo_original_image_data`, `logo_preview_image_data`, `background_original_image_data`, `background_preview_image_data`)
- Подготовить структуру для будущей миграции на S3 (абстракция для хранения файлов через интерфейс)
- При загрузке изображения: автоматическая генерация превью из оригинала

### 6. Переменные окружения
- Создать `.env.example` файлы в каждом компоненте
- Настроить загрузку переменных окружения из `.env` файлов
- Для Spring Boot: использовать Spring Boot Configuration Processor или `@ConfigurationProperties`
- Для React (Vite): использовать переменные с префиксом `VITE_` вместо `REACT_APP_`

### 7. Управление окружением
- Управление сервисами осуществляется напрямую через docker-compose команды
- Примеры команд:
  - `docker compose up -d` - запуск всех сервисов
  - `docker compose up -d postgres` - запуск только PostgreSQL
  - `docker compose up -d admin-api admin-web` - запуск конкретных сервисов
  - `docker compose down` - остановка всех сервисов
  - `docker compose logs [service]` - просмотр логов
  - `docker compose exec [service] [command]` - выполнение команд в контейнере

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные файлы и структура:
1. ✅ Корневая структура монорепо:
   - `resto-hub/` (корневая директория)
   - `client-api/` (директория Spring Boot приложения)
   - `client-web/` (директория React приложения)
   - `admin-api/` (директория Spring Boot приложения)
   - `admin-web/` (директория React приложения)
   - `database/` (директория для миграций и скриптов)
   - `.gitignore` (в корне проекта)
   - `docker-compose.yml` (в корне проекта)

2. ✅ Docker конфигурация:
   - `docker-compose.yml` с настройками всех сервисов
   - Все сервисы корректно настроены (postgres, client-api, admin-api, client-web, admin-web, seed)
   - Настроены volumes для персистентности данных
   - Настроен networking между сервисами
   - Настроены health checks

3. ✅ Структура client-api:
   - `pom.xml` (независимый, без parent POM)
   - Базовая структура пакетов (controller, service, repository, entity, dto, config)
   - `application.properties` или `application.yml`
   - `.env` и `.env.example`
   - Настроен Liquibase
   - Настроен Spring Data JPA
   - Настроен CORS
   - Настроен Rate Limiter
   - Настроен Spring Boot Actuator (health checks)

4. ✅ Структура admin-api:
   - `pom.xml` (независимый, без parent POM)
   - Базовая структура пакетов (аналогично client-api)
   - `application.properties` или `application.yml`
   - `.env` и `.env.example`
   - Настроен Liquibase
   - Настроен Spring Data JPA
   - Настроен OAuth2.0
   - Настроен Spring Boot Actuator (health checks)

5. ✅ Структура client-web:
   - Инициализирован проект через Vite (TypeScript template)
   - Структура папок (components, pages, services, hooks, utils, types)
   - Настроен React Router
   - Настроена работа с API
   - `.env` и `.env.example` (с префиксом `VITE_`)

6. ✅ Структура admin-web:
   - Инициализирован проект через Vite (TypeScript template)
   - Структура папок (аналогично client-web)
   - `.env` и `.env.example` (с префиксом `VITE_`)

7. ✅ Структура database:
   - `database/liquibase/changelog/db.changelog-master.xml`
   - `database/liquibase/changesets/` (директория для SQL миграций)
   - `database/seed/seed-data.sql`
   - `database/README.md`

### Функциональные проверки:
1. ✅ PostgreSQL контейнер запускается и работает
   - Подключение к БД через порт 5432
   - Данные сохраняются после перезапуска контейнера

2. ✅ Spring Boot приложения запускаются:
   - `client-api` запускается на порту 8081
   - `admin-api` запускается на порту 8082
   - Health checks доступны через Actuator
   - Приложения подключаются к PostgreSQL
   - Liquibase применяет миграции при старте

3. ✅ React приложения запускаются:
   - `client-web` запускается на порту 3000
   - `admin-web` запускается на порту 3001
   - Приложения корректно работают с переменными окружения

4. ✅ Docker Compose команды работают:
   - `docker compose up -d` запускает все сервисы
   - `docker compose up -d postgres` запускает только PostgreSQL
   - `docker compose down` останавливает все сервисы
   - Логи доступны через `docker compose logs`

### Критерии готовности:
- ✅ Все сервисы могут быть запущены через docker-compose
- ✅ Все сервисы могут быть запущены локально (для разработки)
- ✅ База данных доступна и работает
- ✅ Миграции применяются автоматически при старте Spring Boot приложений
- ✅ Health checks работают для всех сервисов
- ✅ Переменные окружения настроены и работают
- ✅ Структура проекта соответствует описанной в задачах

**Шаг считается выполненным**, когда все артефакты созданы и все функциональные проверки пройдены успешно.


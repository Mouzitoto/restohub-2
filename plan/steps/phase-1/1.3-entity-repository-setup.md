# Шаг 1.3: Создание Entity и Repository

## Описание
Создание Entity классов и Repository интерфейсов для всех сущностей базы данных в обоих Spring Boot приложениях (client-api и admin-api). Entity классы отражают существующую схему БД, созданную через миграции Liquibase.

## Технологии
- **Spring Data JPA** - ORM для работы с БД
- **JPA Annotations** - @Entity, @Table, @Column, @Id, @ManyToOne, @OneToMany, @ManyToMany
- **Spring Data Repository** - интерфейсы Repository для доступа к данным

## Задачи

### 1. Принципы создания Entity классов
- **Entity классы отражают существующую схему БД**, не генерируют её
- Все Entity классы должны соответствовать таблицам, созданным через миграции Liquibase
- Использовать аннотации JPA для маппинга полей и связей
- Настроить связи между Entity (@OneToMany, @ManyToOne, @ManyToMany)
- **Важно**: Репозитории не используют автоматическую фильтрацию по `is_active`
- В методах репозиториев явно указывать условия для `is_active` когда необходимо

### 2. Структура Entity классов
- Все Entity классы должны содержать:
  - Аудит поля: `createdAt`, `updatedAt`, `isActive`, `deletedAt` (где применимо)
  - Правильные аннотации JPA
  - Правильные связи с другими Entity
  - Геттеры и сеттеры (или использовать Lombok @Getter/@Setter)
  - Конструкторы (no-args конструктор обязателен для JPA)

### 3. Создание Entity классов для всех сущностей

#### Entity для client-api и admin-api:
1. **Role** - роли пользователей
2. **User** - пользователи системы
3. **UserRestaurant** - маппинг пользователей к ресторанам (many-to-many)
4. **Image** - единая таблица для всех изображений
5. **Restaurant** - рестораны
6. **SubscriptionType** - типы подписок
7. **RestaurantSubscription** - подписки ресторанов
8. **MenuCategory** - категории блюд
9. **MenuItem** - блюда меню
10. **Floor** - этажи ресторана
11. **Room** - помещения на этажах
12. **Table** - столы
13. **BookingStatus** - статусы бронирований и предзаказов
14. **Client** - клиенты ресторанов
15. **Booking** - бронирования
16. **BookingHistory** - история изменений статусов бронирований
17. **BookingPreOrder** - предзаказы блюд к бронированию
18. **PromotionType** - типы промо-событий
19. **Promotion** - промо-события ресторанов

### 4. Настройка связей между Entity
- **One-to-Many**: Restaurant -> Floor, Restaurant -> Promotion
- **Many-to-One**: MenuItem -> MenuCategory, MenuItem -> Restaurant, Table -> Room, Room -> Floor, Booking -> BookingStatus, Booking -> Client, BookingHistory -> Booking, BookingHistory -> BookingStatus, BookingHistory -> User, BookingPreOrder -> Booking, BookingPreOrder -> MenuItem
- **Many-to-Many**: User <-> Restaurant (через UserRestaurant)
- **Независимые**: MenuCategory (глобальные категории, не привязаны к ресторанам)
- **One-to-One**: Restaurant -> Image (logo_image_id, bg_image_id), MenuItem -> Image, Table -> Image

### 5. Создание Repository интерфейсов
- Для каждой Entity создать интерфейс Repository, расширяющий `JpaRepository<Entity, Long>`
- Настроить кастомные методы запросов где необходимо
- **Важно**: Все методы должны явно указывать условия для `is_active` когда необходимо
- Примеры кастомных методов:
  - `findAllByIsActiveTrue()` - получить все активные записи
  - `findByIdAndIsActiveTrue(Long id)` - получить активную запись по ID
  - `findByRestaurantIdAndIsActiveTrue(Long restaurantId)` - получить активные записи по ресторану

### 6. Настройка базовых репозиториев
- Создать базовые методы для работы с soft delete
- Методы для восстановления удаленных записей
- Методы для мягкого удаления (установка `is_active = false` и `deleted_at = NOW()`)

### 7. Общие Entity компоненты
- Создать базовый класс или интерфейс для аудит полей (если используется)
- Настроить автоматическое обновление `updated_at` через JPA listeners или Hibernate events

### 8. Валидация Entity
- Добавить валидацию полей через Bean Validation (@NotNull, @Size, @Email и т.д.)
- Настроить валидацию на уровне Entity для обеспечения целостности данных

### 9. Тестирование Entity и Repository
- Создать базовые тесты для проверки маппинга Entity к таблицам БД
- Проверить работу связей между Entity
- Проверить работу Repository методов
- Проверить работу soft delete

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные Entity классы:
1. ✅ Все 19 Entity классов созданы в обоих приложениях (client-api и admin-api):
   - `Role.java`
   - `User.java`
   - `UserRestaurant.java`
   - `Image.java`
   - `Restaurant.java`
   - `SubscriptionType.java`
   - `RestaurantSubscription.java`
   - `MenuCategory.java`
   - `MenuItem.java`
   - `Floor.java`
   - `Room.java`
   - `Table.java`
   - `BookingStatus.java`
   - `Client.java`
   - `Booking.java`
   - `BookingHistory.java`
   - `BookingPreOrder.java`
   - `PromotionType.java`
   - `Promotion.java`

2. ✅ Все Entity классы содержат:
   - Правильные аннотации JPA (@Entity, @Table, @Id, @Column)
   - Все поля из схемы БД
   - Правильные типы данных
   - Аудит поля (createdAt, updatedAt, isActive, deletedAt где применимо)
   - Правильные связи с другими Entity (@ManyToOne, @OneToMany, @ManyToMany)

### Созданные Repository интерфейсы:
1. ✅ Все 19 Repository интерфейсов созданы в обоих приложениях:
   - `RoleRepository.java`
   - `UserRepository.java`
   - `UserRestaurantRepository.java`
   - `ImageRepository.java`
   - `RestaurantRepository.java`
   - `SubscriptionTypeRepository.java`
   - `RestaurantSubscriptionRepository.java`
   - `MenuCategoryRepository.java`
   - `MenuItemRepository.java`
   - `FloorRepository.java`
   - `RoomRepository.java`
   - `TableRepository.java`
   - `BookingStatusRepository.java`
   - `ClientRepository.java`
   - `BookingRepository.java`
   - `BookingHistoryRepository.java`
   - `BookingPreOrderRepository.java`
   - `PromotionTypeRepository.java`
   - `PromotionRepository.java`

2. ✅ Все Repository интерфейсы:
   - Расширяют `JpaRepository<Entity, Long>`
   - Содержат кастомные методы для работы с `is_active` где необходимо
   - Методы явно указывают условия для `is_active`

### Функциональные проверки:
1. ✅ Entity классы корректно маппятся к таблицам БД:
   - Все поля соответствуют колонкам в БД
   - Типы данных соответствуют типам в БД
   - Связи работают корректно

2. ✅ Repository методы работают:
   - Базовые методы JpaRepository работают (save, findById, findAll, delete)
   - Кастомные методы работают корректно
   - Методы с условиями `is_active` работают правильно

3. ✅ Связи между Entity работают:
   - @ManyToOne связи работают
   - @OneToMany связи работают
   - @ManyToMany связи работают (через промежуточную таблицу)

4. ✅ Soft delete работает:
   - Мягкое удаление устанавливает `is_active = false` и `deleted_at = NOW()`
   - Восстановление работает корректно
   - Запросы с условием `is_active = true` возвращают только активные записи

### Критерии готовности:
- ✅ Все Entity классы созданы и соответствуют схеме БД
- ✅ Все Repository интерфейсы созданы и работают
- ✅ Связи между Entity настроены корректно
- ✅ Аудит поля работают (createdAt, updatedAt обновляются автоматически)
- ✅ Soft delete работает корректно
- ✅ Entity и Repository протестированы и работают без ошибок
- ✅ Оба приложения (client-api и admin-api) содержат одинаковые Entity и Repository

**Шаг считается выполненным**, когда:
- Все Entity классы созданы в обоих приложениях
- Все Repository интерфейсы созданы и работают
- Связи между Entity настроены корректно
- Все функциональные проверки пройдены успешно
- Entity и Repository готовы для использования в следующих фазах разработки


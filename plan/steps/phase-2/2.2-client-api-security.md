# Шаг 2.2: Безопасность Client API

## Описание
Настройка безопасности для client-api: CORS, rate limiting, circuit breaker. Client-api является публичным API без аутентификации пользователей.

## Технологии
- **Spring Cloud Gateway Rate Limiter** или **Bucket4j** - для rate limiting
- **Spring Cloud Circuit Breaker (Resilience4j)** - для circuit breaker
- **Spring Security** - для настройки CORS
- **Spring Cloud Sleuth** - для traceId в логах
- **MDC (Mapped Diagnostic Context)** - для traceId в логах

## Задачи

### 1. CORS настройка
- Настроить CORS для client-web
- Разрешить запросы с домена client-web
- Настроить разрешенные методы (GET, POST, PUT, DELETE и т.д.)
- Настроить разрешенные заголовки
- Настроить credentials если необходимо

### 2. Rate Limiting
- Настроить rate limiting для защиты от DDoS атак
- Использовать Spring Cloud Gateway Rate Limiter или Bucket4j
- Настроить лимиты:
  - Общий лимит на IP адрес
  - Лимит на конкретные endpoints (например, более строгий для `/api/bookings`)
- При превышении лимита: возвращать ошибку с HTTP статусом 429 (Too Many Requests)
- Лимиты настраиваются через конфигурацию (application.yml)

### 3. Circuit Breaker
- Настроить circuit breaker для защиты от каскадных сбоев
- Использовать Spring Cloud Circuit Breaker (Resilience4j)
- Настроить circuit breaker для:
  - Вызовов к базе данных
  - Вызовов к внешним сервисам (если будут в будущем)
- Настроить параметры:
  - Порог ошибок для открытия circuit breaker
  - Время ожидания перед попыткой восстановления
  - Количество попыток восстановления
- При открытом circuit breaker: возвращать ошибку с информативным сообщением

### 4. Единый формат ошибок (Error Response)
- Создать глобальный exception handler (@ControllerAdvice)
- Все ошибки возвращаются в едином формате:
  ```json
  {
    "exceptionName": "RESTAURANT_NOT_FOUND",
    "message": "Ресторан с ID 123 не найден",
    "timestamp": "2024-01-01T12:00:00Z",
    "traceId": "abc123..."
  }
  ```
- HTTP статусы: 4xx для клиентских ошибок, 5xx для серверных ошибок
- Фронт реагирует как на HTTP статусы, так и на exceptionName в response body

### 5. Spring Cloud Sleuth и MDC
- Настроить Spring Cloud Sleuth для генерации traceId
- Настроить MDC для добавления traceId в логи
- traceId должен быть доступен в:
  - Error response (через @ControllerAdvice)
  - Логах приложения (через MDC)

### 6. Безопасность endpoints
- Все endpoints client-api являются публичными (без аутентификации)
- Не требуется JWT токены или сессии
- Endpoints доступны для всех клиентов

### 7. Валидация входных данных
- Использовать Bean Validation (@NotNull, @Size, @Email и т.д.)
- Валидация на уровне Controller через @Valid
- При ошибках валидации: возвращать ошибку в едином формате с exceptionName = "VALIDATION_ERROR"

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ CORS конфигурация:
   - `CorsConfig` класс или настройка в `SecurityConfig`
   - CORS настроен для client-web
   - Разрешенные методы и заголовки настроены

2. ✅ Rate Limiting конфигурация:
   - Rate limiter настроен (Spring Cloud Gateway Rate Limiter или Bucket4j)
   - Лимиты настроены через application.yml
   - Rate limiter применяется ко всем endpoints или выборочно

3. ✅ Circuit Breaker конфигурация:
   - Circuit breaker настроен (Resilience4j)
   - Параметры circuit breaker настроены через application.yml
   - Circuit breaker применяется к вызовам БД и внешним сервисам

4. ✅ Глобальный Exception Handler:
   - `@ControllerAdvice` класс
   - Единый формат error response
   - traceId в error response
   - Обработка ошибок валидации

5. ✅ Настройка Spring Cloud Sleuth и MDC:
   - Sleuth настроен для генерации traceId
   - MDC настроен для добавления traceId в логи
   - traceId доступен в логах и error response

### Функциональные проверки:
1. ✅ CORS работает:
   - Запросы с client-web проходят успешно
   - Запросы с других доменов блокируются (если настроено)
   - Preflight запросы (OPTIONS) работают корректно

2. ✅ Rate Limiting работает:
   - При превышении лимита возвращается HTTP 429
   - Лимиты применяются корректно
   - Разные лимиты для разных endpoints работают

3. ✅ Circuit Breaker работает:
   - При превышении порога ошибок circuit breaker открывается
   - При открытом circuit breaker возвращается ошибка
   - После восстановления circuit breaker закрывается

4. ✅ Единый формат ошибок работает:
   - Все ошибки возвращаются в едином формате
   - traceId присутствует в error response
   - HTTP статусы корректны (4xx, 5xx)

5. ✅ Валидация работает:
   - Ошибки валидации возвращаются в едином формате
   - exceptionName = "VALIDATION_ERROR" для ошибок валидации

6. ✅ traceId в логах:
   - traceId присутствует в логах через MDC
   - traceId корректно передается между запросами

### Критерии готовности:
- ✅ CORS настроен и работает для client-web
- ✅ Rate limiting настроен и работает
- ✅ Circuit breaker настроен и работает
- ✅ Единый формат ошибок работает для всех endpoints
- ✅ traceId доступен в логах и error response
- ✅ Валидация входных данных работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда:
- CORS настроен и работает
- Rate limiting защищает от DDoS атак
- Circuit breaker защищает от каскадных сбоев
- Единый формат ошибок работает
- traceId доступен в логах и error response
- Все функциональные проверки пройдены успешно


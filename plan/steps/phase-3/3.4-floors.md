# Шаг 3.4: Этажи

## Описание
Реализация CRUD операций для этажей ресторана.

## Задачи

### 1. CRUD для этажей (floors)

#### 1.1. POST `/admin-api/r/:id/floor` - создание этажа
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Request Body:**
```json
{
  "floorNumber": "string (required, max: 50, примеры: \"1\", \"Крыша\", \"Подвал\", \"Веранда\", \"1Б\")"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorNumber": "1",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Проверка существования ресторана с `is_active = true`
3. Валидация `floorNumber`
4. Проверка уникальности номера этажа в рамках ресторана: `SELECT * FROM floors WHERE restaurant_id = :id AND floor_number = :floorNumber AND is_active = true`
5. Создание записи в таблице `floors`
6. Установка `restaurant_id = :id`, `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
7. Возврат созданного этажа

**Ошибки:**
- 400 Bad Request: невалидные данные, номер этажа уже существует для ресторана
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.2. GET `/admin-api/r/:id/floor` - список этажей ресторана
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `limit` - integer (optional, default: 100, min: 1, max: 200)
- `offset` - integer (optional, default: 0, min: 0)
- `sortBy` - string (optional, default: "floorNumber") - поле для сортировки: "floorNumber", "createdAt"
- `sortOrder` - string (optional, default: "asc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "restaurantId": 1,
      "floorNumber": "1",
      "roomsCount": 3,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 5,
    "limit": 100,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Построение запроса: `SELECT * FROM floors WHERE restaurant_id = :id AND is_active = true`
3. Для каждого этажа подсчитать количество активных залов:
   - `SELECT COUNT(*) FROM rooms WHERE floor_id = :floorId AND is_active = true`
   - Добавить поле `roomsCount` в ответ
4. Применение сортировки (по умолчанию по `floor_number ASC`)
5. Применение пагинации
6. Возврат списка с пагинацией

#### 1.3. GET `/admin-api/r/:id/floor/:floorId` - получение этажа
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `floorId` - long (required) - ID этажа

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorNumber": "1",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск этажа: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :id AND is_active = true`
3. Возврат этажа

**Ошибки:**
- 404 Not Found: этаж не найден, неактивен или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.4. PUT `/admin-api/r/:id/floor/:floorId` - обновление этажа
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `floorId` - long (required) - ID этажа

**Request Body:**
```json
{
  "floorNumber": "string (optional, max: 50, примеры: \"1\", \"Крыша\", \"Подвал\", \"Веранда\", \"1Б\")"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorNumber": "Крыша",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск этажа: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :id AND is_active = true`
3. Валидация `floorNumber` (если изменяется)
4. Проверка уникальности номера этажа (если изменяется)
5. Обновление только переданных полей
6. Установка `updated_at = NOW()`
7. Возврат обновленного этажа

**Ошибки:**
- 400 Bad Request: невалидные данные, номер этажа уже существует
- 404 Not Found: этаж не найден, неактивен или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.5. DELETE `/admin-api/r/:id/floor/:floorId` - удаление этажа
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `floorId` - long (required) - ID этажа

**Response 204 No Content**

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск этажа: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :id AND is_active = true`
3. Проверка использования этажа:
   - Проверка наличия активных помещений на этаже: `SELECT COUNT(*) FROM rooms WHERE floor_id = :floorId AND is_active = true`
   - Если есть активные помещения → вернуть ошибку 400
4. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`
5. Каскадное мягкое удаление связанных помещений (если настроено в БД)

**Ошибки:**
- 404 Not Found: этаж не найден, неактивен или не принадлежит ресторану
- 400 Bad Request: этаж используется (есть активные помещения на этаже)
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 2. Валидация полей этажа

#### 2.1. Правила валидации

**floorNumber** (номер этажа):
- Обязательное поле (`@NotNull`)
- Тип: VARCHAR(50) или TEXT
- Максимальная длина: 50 символов (`@Size(max = 50)`)
- Не может быть пустой строкой (после trim) (`@NotBlank`)
- Валидатор: `@NotNull`, `@NotBlank`, `@Size(max = 50)`
- Кастомная проверка уникальности: номер должен быть уникальным в рамках ресторана
- Примеры значений: "1", "Крыша", "Подвал", "Веранда", "1Б", "-1"

#### 2.2. Кастомные валидаторы

**@UniqueFloorNumber** - проверка уникальности номера этажа в рамках ресторана:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = UniqueFloorNumberValidator.class)
public @interface UniqueFloorNumber {
    String message() default "Floor number already exists for this restaurant";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `FloorRepository.findByRestaurantIdAndFloorNumberAndIsActiveTrue(restaurantId, floorNumber)`
- Возвращает ошибку, если этаж с таким номером уже существует для ресторана

#### 2.3. Логика проверки существования связанных сущностей

**Проверка ресторана:**
1. При создании/обновлении этажа:
   - Выполнить запрос: `SELECT * FROM restaurants WHERE id = :restaurantId AND is_active = true`
   - Если ресторан не найден или неактивен → вернуть ошибку 404

**Проверка принадлежности этажа к ресторану:**
1. При получении/обновлении/удалении этажа:
   - Выполнить запрос: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :restaurantId AND is_active = true`
   - Если этаж не найден или не принадлежит ресторану → вернуть ошибку 404

### 3. Логика soft delete

#### 3.1. Поведение при удалении
- Установка `is_active = false` и `deleted_at = NOW()`
- Этаж скрывается из всех GET запросов (фильтр `is_active = true`)
- Каскадное мягкое удаление связанных помещений (если настроено в БД)

#### 3.2. Проверка использования перед удалением
- Проверка наличия активных помещений на этаже
- Если есть активные помещения → вернуть ошибку 400 с сообщением "Floor has active rooms"
- Если активных помещений нет → разрешить удаление

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Floor Controller:
   - `POST /admin-api/r/:id/floor` endpoint
   - `GET /admin-api/r/:id/floor` endpoint
   - `PUT /admin-api/r/:id/floor/:floorId` endpoint
   - `DELETE /admin-api/r/:id/floor/:floorId` endpoint

2. ✅ Floor Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка доступа к ресторану

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка уникальности номера этажа

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание этажа
   - Получение списка этажей
   - Обновление этажа
   - Мягкое удаление этажа

2. ✅ Проверка доступа работает:
   - Менеджер может работать только со своими ресторанами
   - ADMIN может работать с любыми ресторанами

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Уникальность номера этажа проверяется

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Проверка доступа через интерцептор работает
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


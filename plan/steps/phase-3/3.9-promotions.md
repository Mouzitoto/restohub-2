# Шаг 3.9: Акции

## Описание
Реализация CRUD операций для промо-событий ресторанов (акции, тематические вечера, новинки).

## Задачи

### 1. CRUD для промо-событий (promotions)

#### 1.1. POST `/admin-api/r/:id/promotion` - создание промо-события
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Request Body:**
```json
{
  "title": "string (required, max 255)",
  "description": "string (optional, TEXT, max 10000)",
  "promotionTypeId": "long (required, должен существовать в promotion_types и is_active = true)",
  "startDate": "date (required, format: YYYY-MM-DD)",
  "endDate": "date (optional, format: YYYY-MM-DD, должна быть >= startDate, может быть null для бесконечных повторяющихся событий)",
  "imageId": "long (optional, должен существовать в images и is_active = true)",
  "isRecurring": "boolean (optional, default: false)",
  "recurrenceType": "string (optional, если isRecurring=true: WEEKLY, MONTHLY, DAILY)",
  "recurrenceDayOfWeek": "integer (optional, если recurrenceType=WEEKLY: 1=понедельник, 2=вторник, ..., 7=воскресенье)"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "promotionType": {
    "id": 1,
    "code": "PROMOTION",
    "name": "Акция"
  },
  "title": "Скидка 20% на все блюда",
  "description": "Специальное предложение",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "imageId": 123,
  "isRecurring": false,
  "recurrenceType": null,
  "recurrenceDayOfWeek": null,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Проверка существования ресторана с `is_active = true`
3. Валидация всех полей
4. Проверка существования и активности типа промо-события: `SELECT * FROM promotion_types WHERE id = :promotionTypeId AND is_active = true`
5. Проверка дат: если `endDate` указана, то `endDate >= startDate`
6. Валидация повторяющихся событий:
   - Если `isRecurring = true`, то `recurrenceType` обязателен и должен быть одним из: WEEKLY, MONTHLY, DAILY
   - Если `recurrenceType = WEEKLY`, то `recurrenceDayOfWeek` обязателен и должен быть в диапазоне 1-7
   - Если `isRecurring = false`, то `recurrenceType` и `recurrenceDayOfWeek` должны быть null
7. Проверка существования и активности изображения (если указано)
8. Создание записи в таблице `promotions`
9. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
10. Возврат созданного промо-события

**Ошибки:**
- 400 Bad Request: невалидные данные, тип промо-события не найден или неактивен, неверные даты, изображение не найдено или неактивно
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.2. GET `/admin-api/r/:id/promotion` - список промо-событий ресторана
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `limit` - integer (optional, default: 50, min: 1, max: 100)
- `offset` - integer (optional, default: 0, min: 0)
- `promotionTypeId` - long (optional) - фильтр по типу промо-события
- `isActive` - boolean (optional) - фильтр по активности
- `startDateFrom` - date (optional, format: YYYY-MM-DD) - фильтр по дате начала (>=)
- `startDateTo` - date (optional, format: YYYY-MM-DD) - фильтр по дате начала (<=)
- `endDateFrom` - date (optional, format: YYYY-MM-DD) - фильтр по дате окончания (>=)
- `endDateTo` - date (optional, format: YYYY-MM-DD) - фильтр по дате окончания (<=)
- `isCurrent` - boolean (optional) - фильтр по текущим акциям (CURRENT_DATE >= start_date AND CURRENT_DATE <= end_date)
- `sortBy` - string (optional, default: "startDate") - поле для сортировки: "startDate", "endDate", "title", "createdAt"
- `sortOrder` - string (optional, default: "desc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "restaurantId": 1,
      "promotionType": {
        "id": 1,
        "code": "PROMOTION",
        "name": "Акция"
      },
      "title": "Скидка 20% на все блюда",
      "description": "Специальное предложение",
      "startDate": "2024-01-01",
      "endDate": "2024-01-31",
      "imageId": 123,
      "isRecurring": false,
      "recurrenceType": null,
      "recurrenceDayOfWeek": null,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 20,
    "limit": 50,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Построение запроса: `SELECT p.*, pt.code, pt.name FROM promotions p JOIN promotion_types pt ON p.promotion_type_id = pt.id WHERE p.restaurant_id = :id AND p.is_active = true`
3. Применение фильтров:
   - По типу: `AND p.promotion_type_id = :promotionTypeId` (если указано)
   - По активности: `AND p.is_active = :isActive` (если указано)
   - По датам: `AND p.start_date >= :startDateFrom AND p.start_date <= :startDateTo` и т.д. (если указано)
   - По текущим: `AND CURRENT_DATE >= p.start_date AND CURRENT_DATE <= p.end_date` (если `isCurrent = true`)
4. Применение сортировки
5. Применение пагинации
6. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.3. GET `/admin-api/r/:id/promotion/:promotionId` - получение промо-события
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `promotionId` - long (required) - ID промо-события

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "promotionType": {
    "id": 1,
    "code": "PROMOTION",
    "name": "Акция"
  },
  "title": "Скидка 20% на все блюда",
  "description": "Специальное предложение",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "imageId": 123,
  "isRecurring": false,
  "recurrenceType": null,
  "recurrenceDayOfWeek": null,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск промо-события: `SELECT p.*, pt.* FROM promotions p JOIN promotion_types pt ON p.promotion_type_id = pt.id WHERE p.id = :promotionId AND p.restaurant_id = :id AND p.is_active = true`
3. Возврат промо-события

**Ошибки:**
- 404 Not Found: промо-событие не найдено, неактивно или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.4. PUT `/admin-api/r/:id/promotion/:promotionId` - обновление промо-события
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `promotionId` - long (required) - ID промо-события

**Request Body:**
```json
{
  "title": "string (optional, max 255)",
  "description": "string (optional, TEXT, max 10000)",
  "promotionTypeId": "long (optional, должен существовать и быть активным)",
  "startDate": "date (optional, format: YYYY-MM-DD)",
  "endDate": "date (optional, format: YYYY-MM-DD, должна быть >= startDate, может быть null для бесконечных повторяющихся событий)",
  "imageId": "long | null (optional)",
  "isRecurring": "boolean (optional)",
  "recurrenceType": "string (optional, если isRecurring=true: WEEKLY, MONTHLY, DAILY)",
  "recurrenceDayOfWeek": "integer (optional, если recurrenceType=WEEKLY: 1=понедельник, 2=вторник, ..., 7=воскресенье)"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "promotionType": {
    "id": 1,
    "code": "PROMOTION",
    "name": "Акция"
  },
  "title": "Скидка 20% на все блюда",
  "description": "Специальное предложение",
  "startDate": "2024-01-01",
  "endDate": "2024-02-29",
  "imageId": 123,
  "isRecurring": false,
  "recurrenceType": null,
  "recurrenceDayOfWeek": null,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-15T00:00:00Z",
  "deletedAt": null
}
```
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск промо-события с проверкой принадлежности к ресторану
3. Валидация всех переданных полей
4. Проверка существования и активности типа промо-события (если изменяется `promotionTypeId`)
5. Проверка дат: если указаны обе даты, то `endDate >= startDate`; если `endDate` устанавливается в null, проверить что это допустимо
6. Валидация повторяющихся событий (если изменяется `isRecurring` или связанные поля):
   - Если `isRecurring = true`, то `recurrenceType` обязателен и должен быть одним из: WEEKLY, MONTHLY, DAILY
   - Если `recurrenceType = WEEKLY`, то `recurrenceDayOfWeek` обязателен и должен быть в диапазоне 1-7
   - Если `isRecurring = false`, то `recurrenceType` и `recurrenceDayOfWeek` должны быть null
7. Проверка существования и активности изображения (если изменяется `imageId`)
8. Обновление только переданных полей
9. Установка `updated_at = NOW()`
10. Возврат обновленного промо-события

**Ошибки:**
- 400 Bad Request: невалидные данные, тип промо-события не найден или неактивен, неверные даты, изображение не найдено или неактивно
- 404 Not Found: промо-событие не найдено, неактивно или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.5. DELETE `/admin-api/r/:id/promotion/:promotionId` - удаление промо-события
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `promotionId` - long (required) - ID промо-события

**Response 204 No Content**

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск промо-события с проверкой принадлежности к ресторану
3. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`

**Ошибки:**
- 404 Not Found: промо-событие не найдено, неактивно или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 2. Валидация полей промо-события

#### 2.1. Правила валидации

**title** (заголовок):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 255)`

**description** (описание):
- Опциональное поле (`nullable = true`)
- Тип: TEXT
- Максимальная длина на уровне валидации: 10000 символов (`@Size(max = 10000)`)

**promotionTypeId** (ID типа промо-события):
- Обязательное поле (`@NotNull`)
- Тип: BIGINT
- Кастомная валидация:
  - Должно существовать в таблице `promotion_types`
  - Тип должен быть активным (`is_active = true`)
  - Кастомный валидатор: `@ValidPromotionTypeId` - проверка через сервис

**startDate** (дата начала):
- Обязательное поле (`@NotNull`)
- Тип: DATE
- Формат: YYYY-MM-DD
- Валидатор: `@NotNull`, `@PastOrPresent` (дата не должна быть в прошлом при создании, или разрешить для продления)

**endDate** (дата окончания):
- Опциональное поле (`nullable = true`)
- Тип: DATE
- Формат: YYYY-MM-DD
- Валидация: если указана, то `endDate >= startDate` (кастомная проверка)
- Может быть null для бесконечных повторяющихся событий
- Валидатор: `@Future` (если указана, дата должна быть в будущем или >= startDate)

**imageId** (ID изображения):
- Опциональное поле (`nullable = true`)
- Тип: BIGINT
- Кастомная валидация: `@ValidImageId`

**isRecurring** (флаг повторяющегося события):
- Опциональное поле (`nullable = true`, default: false)
- Тип: BOOLEAN
- Валидатор: стандартный boolean

**recurrenceType** (тип повторения):
- Опциональное поле (`nullable = true`)
- Тип: VARCHAR(50)
- Допустимые значения: WEEKLY, MONTHLY, DAILY
- Обязателен, если `isRecurring = true`
- Должен быть null, если `isRecurring = false`
- Кастомная валидация: `@ValidRecurrenceType`

**recurrenceDayOfWeek** (день недели для WEEKLY):
- Опциональное поле (`nullable = true`)
- Тип: INTEGER
- Диапазон: 1-7 (1=понедельник, 2=вторник, ..., 7=воскресенье)
- Обязателен, если `recurrenceType = WEEKLY`
- Должен быть null, если `recurrenceType != WEEKLY` или `isRecurring = false`
- Кастомная валидация: `@Min(1)`, `@Max(7)`

#### 2.2. Кастомные валидаторы

**@ValidPromotionTypeId** - валидация существования и активности типа промо-события:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidPromotionTypeIdValidator.class)
public @interface ValidPromotionTypeId {
    String message() default "Promotion type not found or inactive";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `PromotionTypeRepository.findByIdAndIsActiveTrue(promotionTypeId)`

**@ValidDateRange** - валидация диапазона дат:
```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidDateRangeValidator.class)
public @interface ValidDateRange {
    String message() default "End date must be after or equal to start date";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка на уровне класса DTO: если `endDate` указана, то `endDate >= startDate`

**@ValidRecurrenceType** - валидация типа повторения:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidRecurrenceTypeValidator.class)
public @interface ValidRecurrenceType {
    String message() default "Invalid recurrence type";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка допустимых значений: WEEKLY, MONTHLY, DAILY
- Проверка соответствия с `isRecurring`: если `isRecurring = true`, то `recurrenceType` обязателен; если `isRecurring = false`, то `recurrenceType` должен быть null

**@ValidRecurrenceDayOfWeek** - валидация дня недели:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidRecurrenceDayOfWeekValidator.class)
public @interface ValidRecurrenceDayOfWeek {
    String message() default "Recurrence day of week is required for WEEKLY type";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка: если `recurrenceType = WEEKLY`, то `recurrenceDayOfWeek` обязателен и в диапазоне 1-7

#### 2.3. Логика проверки существования связанных сущностей

**Проверка типа промо-события:**
1. При создании/обновлении промо-события:
   - Выполнить запрос: `SELECT * FROM promotion_types WHERE id = :promotionTypeId AND is_active = true`
   - Если тип не найден или неактивен → вернуть ошибку 400

**Проверка принадлежности промо-события к ресторану:**
1. При получении/обновлении/удалении промо-события:
   - Выполнить запрос: `SELECT * FROM promotions WHERE id = :promotionId AND restaurant_id = :restaurantId AND is_active = true`
   - Если промо-событие не найдено или не принадлежит ресторану → вернуть ошибку 404

### 3. Загрузка изображений

#### 3.1. Процесс загрузки
- Загрузка изображения через `/admin-api/image` (см. шаг 3.1)
- Автоматическая генерация превью при загрузке
- Сохранение `image_id` в поле `image_id` промо-события
- Одно изображение на промо-событие

#### 3.2. Отвязка изображения
- Установка `imageId = null` через PUT запрос
- Изображение остается в таблице `images` (не удаляется автоматически)

### 4. Логика soft delete

#### 4.1. Поведение при удалении
- Установка `is_active = false` и `deleted_at = NOW()`
- Промо-событие скрывается из всех GET запросов
- Промо-событие остается в БД для истории

#### 4.2. Фильтрация по активности
- По умолчанию возвращаются только активные промо-события (`is_active = true`)
- Опциональный фильтр `isActive` позволяет получить все промо-события (включая неактивные)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Promotion Controller:
   - `POST /admin-api/r/:id/promotion` endpoint
   - `GET /admin-api/r/:id/promotion` endpoint
   - `GET /admin-api/r/:id/promotion/:promotionId` endpoint
   - `PUT /admin-api/r/:id/promotion/:promotionId` endpoint
   - `DELETE /admin-api/r/:id/promotion/:promotionId` endpoint

2. ✅ Promotion Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка доступа к ресторану

3. ✅ Валидация:
- Валидация обязательных полей
   - Проверка дат
   - Проверка существования типа промо-события

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание промо-события
   - Получение списка промо-событий
   - Получение промо-события по ID
   - Обновление промо-события
   - Мягкое удаление промо-события

2. ✅ Проверка доступа работает:
   - Менеджер может работать только со своими ресторанами
   - ADMIN может работать с любыми ресторанами

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Даты валидируются
   - Проверка существования типа промо-события

4. ✅ Загрузка изображений работает:
   - Изображения загружаются через `/admin-api/image`
   - Превью генерируется автоматически

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Проверка доступа через интерцептор работает
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Загрузка изображений работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.

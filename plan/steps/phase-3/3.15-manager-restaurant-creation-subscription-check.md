# Шаг 3.15: Создание ресторанов менеджерами и проверка подписки

## Описание
Реализация функционала, позволяющего менеджерам самостоятельно создавать рестораны. Рестораны автоматически привязываются к менеджерам при создании. В client-api добавлен интерцептор для проверки активной подписки на всех endpoints ресторанов с кэшированием через Caffeine на 10 минут. Все изменения покрыты тестами (unit, integration, E2E) для backend и frontend.

## Задачи

### 1. Изменения в Admin API

#### 1.1. Обновление DTO для создания ресторана
**Файл:** `admin-api/src/main/java/com/restohub/adminapi/dto/CreateRestaurantRequest.java`
- Добавлено опциональное поле `userId` (Long)
- Поле необязательное, валидация не требуется
- Используется только для ADMIN при создании ресторана для конкретного менеджера

#### 1.2. Изменение прав доступа на создание ресторана
**Файл:** `admin-api/src/main/java/com/restohub/adminapi/controller/RestaurantController.java`
- Изменен `@PreAuthorize("hasRole('ADMIN')")` на `@PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")` для метода `createRestaurant`
- Теперь и ADMIN, и MANAGER могут создавать рестораны

#### 1.3. Обновление логики создания ресторана
**Файл:** `admin-api/src/main/java/com/restohub/adminapi/service/RestaurantService.java`
- В методе `createRestaurant` добавлена логика привязки ресторана к пользователю:
  - Получение роли текущего пользователя из `SecurityContextHolder`
  - **Если роль ADMIN:**
    - Если `request.getUserId()` указан - привязать ресторан к указанному пользователю через `users_2_restaurants`
    - Если `request.getUserId()` не указан - не привязывать (как было раньше)
  - **Если роль MANAGER:**
    - Игнорировать `request.getUserId()` (если указан)
    - Получить текущего пользователя из `SecurityContextHolder` по email
    - Автоматически создать запись в `users_2_restaurants` для текущего менеджера
- Использование `UserRestaurantRepository` для создания связи
- Использование `UserRepository` для получения пользователя по ID (для ADMIN) или email (для MANAGER)

### 2. Изменения в Client API

#### 2.1. Добавление зависимостей для кэширования
**Файл:** `client-api/pom.xml`
- Добавлена зависимость `org.springframework.boot:spring-boot-starter-cache` для интеграции Spring Cache
- Добавлена зависимость `com.github.ben-manes.caffeine:caffeine` для кэширования

#### 2.2. Настройка кэша Caffeine
**Файл:** `client-api/src/main/java/com/restohub/clientapi/config/CacheConfig.java`
- Создан конфигурационный класс с `@Configuration` и `@EnableCaching`
- Настроен `CaffeineCacheManager` с кэшем для подписок:
  - Имя кэша: `subscriptionCache`
  - TTL: 10 минут
  - Максимальный размер: 10000 записей

#### 2.3. Создание сервиса для проверки подписки
**Файл:** `client-api/src/main/java/com/restohub/clientapi/service/SubscriptionCheckService.java`
- Создан сервис с методом `hasActiveSubscription(Long restaurantId): boolean`
- Логика проверки:
  - Проверка существования ресторана с `is_active = true`
  - Поиск активной подписки: `is_active = true AND CURRENT_DATE >= start_date AND CURRENT_DATE <= end_date`
  - Использование `RestaurantSubscriptionRepository` для запроса
- Добавлена аннотация `@Cacheable("subscriptionCache")` на метод для кэширования результата
- Ключ кэша: `restaurantId`
- При отсутствии подписки возвращается `false` (не кэшируется отсутствие, только наличие)

#### 2.4. Создание интерцептора для проверки подписки
**Файл:** `client-api/src/main/java/com/restohub/clientapi/config/RestaurantSubscriptionInterceptor.java`
- Создан интерцептор, реализующий `HandlerInterceptor`
- Логика интерцептора:
  - Проверка пути запроса: начинается с `/client-api/restaurants` или `/client-api/r`
  - Извлечение `restaurantId` из path variable (например, `/restaurants/{id}`, `/r/{id}`, `/r/{id}/menu`)
  - Использование `SubscriptionCheckService` для проверки активной подписки
  - Если подписка неактивна или ресторан не найден:
    - Возврат HTTP 404 с JSON ответом: `{"exceptionName": "RESTAURANT_NOT_FOUND", "message": "Ресторан не найден или неактивен"}`
    - Установка `Content-Type: application/json`
  - Если подписка активна - пропуск запроса дальше
- Обработка различных паттернов путей:
  - `/restaurants` (список) - пропускать (фильтрация будет в контроллере)
  - `/restaurants/{id}` - проверять подписку для `{id}`
  - `/restaurants/{id}/*` - проверять подписку для `{id}`
  - `/r/{id}` - проверять подписку для `{id}`
  - `/r/{id}/*` - проверять подписку для `{id}`

#### 2.5. Регистрация интерцептора
**Файл:** `client-api/src/main/java/com/restohub/clientapi/config/WebMvcConfig.java`
- Добавлен `RestaurantSubscriptionInterceptor` в `addInterceptors`
- Зарегистрирован для паттернов: `/client-api/restaurants/**` и `/client-api/r/**`
- Порядок: интерцептор выполняется после rate limiting, но перед обработкой контроллера

### 3. Изменения в Admin Web (Frontend)

#### 3.1. Обновление страницы управления ресторанами
**Файл:** `admin-web/src/pages/admin/AdminRestaurantsPage.tsx`
- Обновлена проверка роли: теперь и ADMIN, и MANAGER могут видеть и создавать рестораны
- Изменено условие `if (role !== 'ADMIN')` на `if (role !== 'ADMIN' && role !== 'MANAGER')`
- Менеджеры теперь могут видеть кнопку "Создать ресторан" и создавать рестораны

### 4. Тестирование

#### 4.1. Тесты для Admin API (Backend)

**Unit тесты для RestaurantService:**
- `createRestaurant_AsManager_AutoLinksToManager()`: менеджер создает ресторан, проверка автоматической привязки
- `createRestaurant_AsAdmin_WithUserId_LinksToUser()`: ADMIN создает ресторан с userId, проверка привязки
- `createRestaurant_AsAdmin_WithoutUserId_NoLink()`: ADMIN создает ресторан без userId, проверка отсутствия привязки
- `createRestaurant_AsManager_InvalidUserId_IgnoresUserId()`: менеджер с userId игнорирует userId

**Integration тесты для RestaurantController:**
- Тест создания ресторана менеджером (HTTP 201, привязка)
- Тест создания ресторана ADMIN с userId (HTTP 201, привязка к указанному пользователю)
- Тест создания ресторана без аутентификации (HTTP 401)
- Тест создания ресторана менеджером с несуществующим userId (игнорируется)

#### 4.2. Тесты для Client API (Backend)

**Unit тесты для SubscriptionCheckService:**
- `hasActiveSubscription_WithActiveSubscription_ReturnsTrue()`: активная подписка возвращает true
- `hasActiveSubscription_WithExpiredSubscription_ReturnsFalse()`: истекшая подписка возвращает false
- `hasActiveSubscription_WithoutSubscription_ReturnsFalse()`: нет подписки возвращает false
- `hasActiveSubscription_WithInactiveSubscription_ReturnsFalse()`: неактивная подписка возвращает false
- `hasActiveSubscription_RestaurantNotFound_ReturnsFalse()`: ресторан не найден возвращает false
- `hasActiveSubscription_CachesResult()`: проверка работы кэша

**Unit тесты для RestaurantSubscriptionInterceptor:**
- `preHandle_WithActiveSubscription_ReturnsTrue()`: активная подписка пропускает запрос
- `preHandle_WithoutSubscription_Returns404()`: нет подписки возвращает 404 с правильным JSON
- `preHandle_ListEndpoint_ReturnsTrue()`: список ресторанов пропускается
- `preHandle_NonRestaurantPath_ReturnsTrue()`: другие пути пропускаются
- `preHandle_RestaurantPathWithSubPath_ChecksSubscription()`: проверка подписки для подпутей
- `preHandle_ShortPath_RestaurantId()`: проверка работы с коротким путем `/r/{id}`

**Integration тесты для Client API:**
- GET ресторана с активной подпиской (HTTP 200)
- GET ресторана без подписки (HTTP 404)
- GET меню ресторана с активной подпиской (HTTP 200)
- GET меню ресторана без подписки (HTTP 404)
- GET ресторана через короткий путь `/r/{id}` с активной подпиской
- GET ресторана через короткий путь `/r/{id}` без подписки (HTTP 404)
- GET списка ресторанов пропускается интерцептором

#### 4.3. Тесты для Admin Web (Frontend)

**Unit тесты для AdminRestaurantsPage:**
- Тест отображения кнопки создания для менеджера
- Тест создания ресторана менеджером (POST без userId)
- Тест создания ресторана ADMIN с userId
- Тест создания ресторана ADMIN без userId

**Integration тесты для Admin Web:**
- E2E тест: менеджер создает ресторан и видит его в списке
- E2E тест: ADMIN создает ресторан для менеджера

#### 4.4. E2E тесты
- E2E тест: менеджер регистрируется, создает ресторан, ресторан привязан
- E2E тест: ресторан без подписки недоступен клиентам, после активации подписки доступен

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:

1. ✅ Обновлен DTO `CreateRestaurantRequest`:
   - Добавлено поле `userId` (опциональное)

2. ✅ Обновлен `RestaurantController`:
   - Изменен `@PreAuthorize` на `hasAnyRole('ADMIN', 'MANAGER')`

3. ✅ Обновлен `RestaurantService`:
   - Добавлена логика привязки ресторана к пользователю
   - Метод `linkRestaurantToUser()` для обработки привязки

4. ✅ Добавлены зависимости в `client-api/pom.xml`:
   - `spring-boot-starter-cache`
   - `caffeine`

5. ✅ Создан `CacheConfig`:
   - Настроен Caffeine кэш с TTL 10 минут

6. ✅ Создан `SubscriptionCheckService`:
   - Метод `hasActiveSubscription()` с кэшированием
   - Проверка активной подписки по датам

7. ✅ Создан `RestaurantSubscriptionInterceptor`:
   - Проверка подписки для всех путей ресторанов
   - Возврат 404 для ресторанов без подписки

8. ✅ Обновлен `WebMvcConfig` в client-api:
   - Зарегистрирован интерцептор проверки подписки

9. ✅ Обновлен `AdminRestaurantsPage`:
   - Менеджеры могут видеть и создавать рестораны

10. ✅ Созданы тесты:
    - Unit тесты для `RestaurantService` (4 теста)
    - Integration тесты для `RestaurantController` (4 теста)
    - Unit тесты для `SubscriptionCheckService` (6 тестов)
    - Unit тесты для `RestaurantSubscriptionInterceptor` (6 тестов)
    - Integration тесты для Client API (7 тестов)
    - Unit тесты для `AdminRestaurantsPage` (4 теста)
    - Integration тесты для Admin Web (2 теста)
    - E2E тесты (2 шаблона)

### Функциональные проверки:

1. ✅ Создание ресторана менеджером работает:
   - Менеджер может создать ресторан через API
   - Ресторан автоматически привязывается к менеджеру
   - `userId` игнорируется, если указан менеджером

2. ✅ Создание ресторана ADMIN работает:
   - ADMIN может создать ресторан с указанием `userId`
   - ADMIN может создать ресторан без `userId`
   - Ресторан привязывается только если указан `userId`

3. ✅ Проверка подписки в client-api работает:
   - Интерцептор проверяет подписку для всех путей ресторанов
   - Рестораны без подписки возвращают 404
   - Рестораны с активной подпиской пропускаются
   - Список ресторанов пропускается интерцептором

4. ✅ Кэширование работает:
   - Результаты проверки подписки кэшируются на 10 минут
   - Кэшируются только положительные результаты (наличие подписки)

5. ✅ Frontend работает:
   - Менеджеры видят кнопку "Создать ресторан"
   - Менеджеры могут создавать рестораны
   - ADMIN может создавать рестораны

6. ✅ Все тесты проходят:
   - Unit тесты для backend
   - Integration тесты для backend
   - Unit тесты для frontend
   - Integration тесты для frontend

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Логика привязки ресторана к пользователю работает корректно
- ✅ Интерцептор проверки подписки работает для всех путей
- ✅ Кэширование работает корректно
- ✅ Frontend обновлен для поддержки менеджеров
- ✅ Все тесты созданы и проходят
- ✅ Документация обновлена

**Шаг считается выполненным**, когда:
- Менеджеры могут создавать рестораны самостоятельно
- Рестораны автоматически привязываются к менеджерам
- Рестораны без подписки недоступны клиентам через client-api
- Кэширование работает корректно
- Все тесты проходят успешно
- Документация обновлена


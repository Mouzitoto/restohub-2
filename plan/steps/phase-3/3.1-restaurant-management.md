# Шаг 3.1: Управление ресторанами

## Описание
Реализация CRUD операций для ресторанов, настройка персональной страницы и контактной информации.

## Задачи

### 1. CRUD операции для ресторанов

#### 1.1. POST `/admin-api/r` - создание ресторана
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Request Body:**
```json
{
  "name": "string (required, max 255)",
  "address": "string (required, max 500)",
  "phone": "string (required, max 50, формат: +7XXXXXXXXXX или 8XXXXXXXXXX)",
  "whatsapp": "string (optional, max 50, формат: +7XXXXXXXXXX или 8XXXXXXXXXX)",
  "instagram": "string (optional, max 255, URL или username)",
  "description": "string (optional, TEXT)",
  "latitude": "decimal (optional, -90 to 90)",
  "longitude": "decimal (optional, -180 to 180)",
  "workingHours": "string (optional, max 1000)",
  "managerLanguageCode": "string (optional, default: 'ru', max 10, допустимые значения: 'ru', 'en', 'kz' и т.д.)",
  "logoImageId": "long (optional, должен существовать в images и is_active = true)",
  "bgImageId": "long (optional, должен существовать в images и is_active = true)"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "name": "string",
  "address": "string",
  "phone": "string",
  "whatsapp": "string | null",
  "instagram": "string | null",
  "description": "string | null",
  "latitude": "decimal | null",
  "longitude": "decimal | null",
  "workingHours": "string | null",
  "managerLanguageCode": "string",
  "logoImageId": "long | null",
  "bgImageId": "long | null",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Валидация всех полей согласно правилам
2. Проверка существования и активности изображений (если указаны `logoImageId` или `bgImageId`)
3. Создание записи в таблице `restaurants`
4. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
5. Возврат созданного ресторана

**Ошибки:**
- 400 Bad Request: невалидные данные, изображение не найдено или неактивно
- 403 Forbidden: пользователь не ADMIN

#### 1.2. GET `/admin-api/r` - список ресторанов
**Доступ:** ADMIN и MANAGER

**Query параметры:**
- `limit` - integer (optional, default: 50, min: 1, max: 100) - количество результатов
- `offset` - integer (optional, default: 0, min: 0) - смещение для пагинации
- `search` - string (optional, max: 255) - поиск по названию или адресу (LIKE)
- `isActive` - boolean (optional, default: true) - фильтр по активности (только для ADMIN)
- `sortBy` - string (optional, default: "createdAt") - поле для сортировки: "name", "createdAt", "updatedAt"
- `sortOrder` - string (optional, default: "desc") - порядок сортировки: "asc" или "desc"

**Логика доступа:**
- **ADMIN**: возвращает все рестораны с `is_active = true` (или согласно `isActive` параметру)
- **MANAGER**: возвращает только рестораны из таблицы `users_2_restaurants` для текущего пользователя с `is_active = true`

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "string",
      "address": "string",
      "phone": "string",
      "logoImageId": "long | null",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 100,
    "limit": 50,
    "offset": 0,
    "hasMore": true
  }
}
```

**Логика:**
1. Определение роли пользователя из JWT токена
2. Построение запроса с учетом доступа:
   - ADMIN: `SELECT * FROM restaurants WHERE is_active = :isActive`
   - MANAGER: `SELECT r.* FROM restaurants r JOIN users_2_restaurants u2r ON r.id = u2r.restaurant_id WHERE u2r.user_id = :userId AND r.is_active = true`
3. Применение фильтров (search, isActive)
4. Применение сортировки
5. Применение пагинации (LIMIT/OFFSET)
6. Подсчет общего количества записей (для пагинации)
7. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры

#### 1.3. GET `/admin-api/r/:id` - получение ресторана
**Доступ:** ADMIN и MANAGER

**Path параметры:**
- `id` - long (required) - ID ресторана

**Логика доступа:**
- **ADMIN**: доступ к любому ресторану
- **MANAGER**: доступ только через интерцептор `/r/*` (проверка принадлежности к ресторану)

**Response 200 OK:**
```json
{
  "id": 1,
  "name": "string",
  "address": "string",
  "phone": "string",
  "whatsapp": "string | null",
  "instagram": "string | null",
  "description": "string | null",
  "latitude": "decimal | null",
  "longitude": "decimal | null",
  "workingHours": "string | null",
  "managerLanguageCode": "string",
  "logoImageId": "long | null",
  "bgImageId": "long | null",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана по ID с `is_active = true`
3. Возврат полной информации о ресторане

**Ошибки:**
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.4. PUT `/admin-api/r/:id` - обновление ресторана
**Доступ:** ADMIN и MANAGER

**Path параметры:**
- `id` - long (required) - ID ресторана

**Request Body:**
```json
{
  "name": "string (optional, max 255)",
  "address": "string (optional, max 500)",
  "phone": "string (optional, max 50)",
  "whatsapp": "string (optional, max 50)",
  "instagram": "string (optional, max 255)",
  "description": "string (optional, TEXT)",
  "latitude": "decimal (optional)",
  "longitude": "decimal (optional)",
  "workingHours": "string (optional, max 1000)",
  "managerLanguageCode": "string (optional, max 10, допустимые значения: 'ru', 'en', 'kz' и т.д.)",
  "logoImageId": "long | null (optional)",
  "bgImageId": "long | null (optional)",
  "isActive": "boolean (optional, только для ADMIN)"
}
```

**Логика доступа:**
- **ADMIN**: доступ к любому ресторану, может изменять `isActive`
- **MANAGER**: доступ только через интерцептор `/r/*`, не может изменять `isActive`

**Response 200 OK:**
```json
{
  "id": 1,
  "name": "string",
  "address": "string",
  "phone": "string",
  "whatsapp": "string | null",
  "instagram": "string | null",
  "description": "string | null",
  "latitude": "decimal | null",
  "longitude": "decimal | null",
  "workingHours": "string | null",
  "managerLanguageCode": "string",
  "logoImageId": "long | null",
  "bgImageId": "long | null",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана по ID с `is_active = true`
3. Валидация всех переданных полей
4. Проверка существования и активности изображений (если указаны)
5. Обновление только переданных полей (PATCH-логика)
6. Установка `updated_at = NOW()`
7. Если MANAGER пытается изменить `isActive` - игнорировать или вернуть ошибку
8. Возврат обновленного ресторана

**Ошибки:**
- 400 Bad Request: невалидные данные, изображение не найдено или неактивно
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.5. DELETE `/admin-api/r/:id` - удаление ресторана
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Response 204 No Content**

**Логика:**
1. Поиск ресторана по ID с `is_active = true`
2. Проверка использования ресторана:
   - Проверка активных подписок (`restaurant_subscriptions` с `is_active = true`)
   - Проверка активных бронирований (`bookings` с `booking_status_id != (SELECT id FROM booking_statuses WHERE code = 'CANCELLED')`)
   - Проверка активных предзаказов (`pre_orders` с `booking_status_id != (SELECT id FROM booking_statuses WHERE code = 'CANCELLED')`)
3. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`
4. Каскадное мягкое удаление связанных сущностей (если настроено в БД):
   - `menu_items` → `is_active = false`, `deleted_at = NOW()`
   - `floors` → `is_active = false`, `deleted_at = NOW()`
   - `rooms` → `is_active = false`, `deleted_at = NOW()`
   - `tables` → `is_active = false`, `deleted_at = NOW()`
   - `promotions` → `is_active = false`, `deleted_at = NOW()`

**Ошибки:**
- 404 Not Found: ресторан не найден или уже удален
- 400 Bad Request: ресторан используется (есть активные подписки/бронирования/предзаказы)
- 403 Forbidden: пользователь не ADMIN

### 2. Валидация полей ресторана

#### 2.1. Правила валидации для каждого поля

**name** (название):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 255)`

**address** (адрес):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 500 символов (`@Size(max = 500)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 500)`

**phone** (телефон):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 50 символов (`@Size(max = 50)`)
- Формат: `+7XXXXXXXXXX` или `8XXXXXXXXXX` (10 цифр после +7 или 8)
- Кастомный валидатор: `@Phone` - проверка формата через regex `^(\+7|8)[0-9]{10}$`
- Нормализация: приведение к формату `+7XXXXXXXXXX` при сохранении

**whatsapp** (WhatsApp номер):
- Опциональное поле (`nullable = true`)
- Максимальная длина: 50 символов (`@Size(max = 50)`)
- Формат: `+7XXXXXXXXXX` или `8XXXXXXXXXX` (10 цифр после +7 или 8)
- Кастомный валидатор: `@Phone` (если указано)
- Нормализация: приведение к формату `+7XXXXXXXXXX` при сохранении

**instagram** (Instagram):
- Опциональное поле (`nullable = true`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Может быть URL (`https://instagram.com/username`) или username (`username`)
- Кастомный валидатор: `@Instagram` - проверка формата (если указано)
- Нормализация: если указан username без URL, добавить префикс `https://instagram.com/`

**description** (описание):
- Опциональное поле (`nullable = true`)
- Тип: TEXT (без ограничения длины в БД)
- Максимальная длина на уровне валидации: 10000 символов (`@Size(max = 10000)`)

**latitude** (широта):
- Опциональное поле (`nullable = true`)
- Тип: DECIMAL(10, 8)
- Диапазон: от -90 до 90 (`@Min(-90)`, `@Max(90)`)
- Валидатор: `@DecimalMin("-90")`, `@DecimalMax("90")`

**longitude** (долгота):
- Опциональное поле (`nullable = true`)
- Тип: DECIMAL(11, 8)
- Диапазон: от -180 до 180 (`@Min(-180)`, `@Max(180)`)
- Валидатор: `@DecimalMin("-180")`, `@DecimalMax("180")`

**workingHours** (рабочие часы):
- Опциональное поле (`nullable = true`)
- Максимальная длина: 1000 символов (`@Size(max = 1000)`)
- Текстовое поле для свободного формата (например: "Пн-Пт: 10:00-22:00, Сб-Вс: 12:00-00:00")

**managerLanguageCode** (код языка для общения с менеджером):
- Опциональное поле (`nullable = true`)
- Максимальная длина: 10 символов (`@Size(max = 10)`)
- По умолчанию: `'ru'` (если не указано)
- Допустимые значения: `'ru'`, `'en'`, `'kz'` и т.д. (коды языков ISO 639-1)
- Валидатор: `@Pattern(regexp = "^[a-z]{2}$")` - проверка формата кода языка (2 буквы в нижнем регистре)
- Используется WhatsApp ботом для выбора языка при отправке уведомлений менеджеру ресторана

**logoImageId** (ID логотипа):
- Опциональное поле (`nullable = true`)
- Тип: BIGINT
- Кастомная валидация:
  - Если указано, должно существовать в таблице `images`
  - Изображение должно быть активным (`is_active = true`)
  - Кастомный валидатор: `@ValidImageId` - проверка через сервис

**bgImageId** (ID фонового изображения):
- Опциональное поле (`nullable = true`)
- Тип: BIGINT
- Кастомная валидация:
  - Если указано, должно существовать в таблице `images`
  - Изображение должно быть активным (`is_active = true`)
  - Кастомный валидатор: `@ValidImageId` - проверка через сервис

**isActive** (статус активности):
- Опциональное поле для обновления (только для ADMIN)
- Тип: BOOLEAN
- По умолчанию: `true` при создании
- MANAGER не может изменять это поле

#### 2.2. Кастомные валидаторы

**@Phone** - валидация номера телефона:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PhoneValidator.class)
public @interface Phone {
    String message() default "Invalid phone number format";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Regex: `^(\+7|8)[0-9]{10}$`
- Нормализация: приведение к `+7XXXXXXXXXX`

**@Instagram** - валидация Instagram ссылки/username:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = InstagramValidator.class)
public @interface Instagram {
    String message() default "Invalid Instagram format";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Принимает: `username`, `@username`, `https://instagram.com/username`, `https://www.instagram.com/username`
- Нормализация: приведение к `https://instagram.com/username`

**@ValidImageId** - валидация существования и активности изображения:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidImageIdValidator.class)
public @interface ValidImageId {
    String message() default "Image not found or inactive";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `ImageRepository.findByIdAndIsActiveTrue(imageId)`
- Возвращает ошибку, если изображение не найдено или неактивно

#### 2.3. Логика проверки существования связанных сущностей

**Проверка изображений:**
1. При создании/обновлении ресторана с `logoImageId` или `bgImageId`:
   - Выполнить запрос: `SELECT * FROM images WHERE id = :imageId AND is_active = true`
   - Если изображение не найдено или неактивно → вернуть ошибку 400 с сообщением "Image not found or inactive"
   - Если изображение найдено и активно → продолжить

**Проверка принадлежности к ресторану (для MANAGER):**
1. Интерцептор `/r/*` проверяет доступ:
   - Извлечь `restaurantId` из path параметра `:id`
   - Извлечь `userId` из JWT токена
   - Выполнить запрос: `SELECT * FROM users_2_restaurants WHERE user_id = :userId AND restaurant_id = :restaurantId`
   - Если запись не найдена и роль не ADMIN → вернуть ошибку 403 Forbidden
   - Если запись найдена или роль ADMIN → продолжить выполнение запроса

### 5. API для работы с изображениями

#### 5.1. Загрузка изображения
- **POST** `/admin-api/image`
  - Content-Type: `multipart/form-data`
  - Тело запроса:
    - `file` - файл изображения (обязательно)
    - `type` - тип изображения: `LOGO` или `BACKGROUND` (опционально, для автоматической привязки к ресторану)
  - Процесс:
    1. Валидация файла (формат, размер)
    2. Загрузка изображения в таблицу `images`
    3. Автоматическая генерация превью из оригинала
    4. Сохранение `image_data` (BYTEA) и `preview_data` (BYTEA) в таблицу `images`
    5. Сохранение `mime_type` и `file_size`
    6. Возврат `image_id` в ответе
  - Ответ:
    ```json
    {
      "id": 123,
      "mimeType": "image/jpeg",
      "fileSize": 1024000
    }
    ```
  - Обработка ошибок:
    - Неверный формат файла (400)
    - Превышен размер файла (400)
    - Ошибка обработки изображения (500)

#### 5.2. Получение изображения
- **GET** `/admin-api/image?id=123&isPreview=true`
  - Query параметры:
    - `id` - ID изображения из таблицы `images` (обязательно)
    - `isPreview` - получить превью (`true`) или оригинал (`false`, по умолчанию)
  - Response:
    - Content-Type: `image/jpeg`, `image/png` и т.д. (из `mime_type`)
    - Body: бинарные данные изображения (BYTEA)
  - Обработка ошибок:
    - Изображение не найдено (404)
    - Изображение удалено (404, если `is_active = false`)

#### 5.3. Удаление изображения
- **DELETE** `/admin-api/image/:id`
  - Мягкое удаление: установка `is_active = false` и `deleted_at = NOW()`
  - Проверка использования изображения:
    - Если изображение используется в `restaurants.logo_image_id` или `restaurants.bg_image_id` - вернуть ошибку
    - Перед удалением нужно сначала отвязать изображение от ресторана
  - Обработка ошибок:
    - Изображение не найдено (404)
    - Изображение используется (400) - нельзя удалить, пока используется

#### 5.4. Привязка изображения к ресторану
- При обновлении ресторана через **PUT** `/admin-api/r/:id`:
  - В теле запроса передать `logo_image_id` или `bg_image_id`
  - Проверка существования изображения в таблице `images`
  - Проверка `is_active = true` для изображения
  - Сохранение `image_id` в соответствующее поле ресторана
- Отвязка изображения:
  - Установить `logo_image_id = null` или `bg_image_id = null` через PUT запрос

#### 5.5. Обработка и оптимизация изображений
- Автоматическая генерация превью при загрузке:
  - Размеры превью будут определены позже
  - Сохранение превью в `preview_data` (BYTEA)
- Валидация форматов:
  - Поддерживаемые форматы: JPEG, PNG, WebP
  - Максимальный размер файла: настраивается через конфигурацию
- Оптимизация:
  - Сжатие изображений (опционально)
  - Изменение размера при необходимости


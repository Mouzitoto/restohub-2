# Шаг 3.5: Залы (rooms)

## Описание
Реализация CRUD операций для помещений (залов) на этажах ресторана, загрузка планов помещений.

## Задачи

### 1. CRUD для помещений (rooms)

#### 1.1. POST `/admin-api/r/:id/room` - создание помещения
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Request Body:**
```json
{
  "name": "string (required, max 255)",
  "description": "string (optional, TEXT, max 10000)",
  "floorId": "long (required, должен существовать в floors и is_active = true)",
  "imageId": "long (optional, должен существовать в images и is_active = true)"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorId": 1,
  "name": "string",
  "description": "string | null",
  "imageId": 123,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Проверка существования ресторана с `is_active = true`
3. Валидация всех полей
4. Проверка существования и активности этажа: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :id AND is_active = true`
5. Проверка существования и активности изображения (если указано `imageId`)
6. Создание записи в таблице `rooms`
7. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
8. Возврат созданного помещения

**Ошибки:**
- 400 Bad Request: невалидные данные, этаж не найден или неактивен, изображение не найдено или неактивно
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.2. GET `/admin-api/r/:id/room` - список помещений ресторана
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `limit` - integer (optional, default: 100, min: 1, max: 200)
- `offset` - integer (optional, default: 0, min: 0)
- `floorId` - long (optional) - фильтр по этажу
- `sortBy` - string (optional, default: "name") - поле для сортировки: "name", "createdAt"
- `sortOrder` - string (optional, default: "asc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "restaurantId": 1,
      "floorId": 1,
      "name": "string",
      "description": "string | null",
      "imageId": 123,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 20,
    "limit": 100,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Построение запроса: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE f.restaurant_id = :id AND r.is_active = true`
3. Применение фильтра по этажу (если указано `floorId`)
4. Применение сортировки
5. Применение пагинации
6. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.3. GET `/admin-api/r/:id/room/:roomId` - получение помещения
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `roomId` - long (required) - ID помещения

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorId": 1,
  "name": "string",
  "description": "string | null",
  "imageId": 123,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск помещения: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE r.id = :roomId AND f.restaurant_id = :id AND r.is_active = true`
3. Возврат помещения

**Ошибки:**
- 404 Not Found: помещение не найдено, неактивно или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.4. PUT `/admin-api/r/:id/room/:roomId` - обновление помещения
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `roomId` - long (required) - ID помещения

**Request Body:**
```json
{
  "name": "string (optional, max 255)",
  "description": "string (optional, TEXT, max 10000)",
  "floorId": "long (optional, должен существовать и быть активным)",
  "imageId": "long | null (optional)"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "floorId": 1,
  "name": "string",
  "description": "string | null",
  "imageId": 123,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск помещения с проверкой принадлежности к ресторану
3. Валидация всех переданных полей
4. Проверка существования и активности этажа (если изменяется `floorId`)
5. Проверка существования и активности изображения (если изменяется `imageId`)
6. Обновление только переданных полей
7. Установка `updated_at = NOW()`
8. Возврат обновленного помещения

**Ошибки:**
- 400 Bad Request: невалидные данные, этаж не найден или неактивен, изображение не найдено или неактивно
- 404 Not Found: помещение не найдено, неактивно или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.5. DELETE `/admin-api/r/:id/room/:roomId` - удаление помещения
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `roomId` - long (required) - ID помещения

**Response 204 No Content**

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск помещения с проверкой принадлежности к ресторану
3. Проверка использования помещения:
   - Проверка наличия активных столов в помещении: `SELECT COUNT(*) FROM tables WHERE room_id = :roomId AND is_active = true`
   - Если есть активные столы → вернуть ошибку 400
4. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`
5. Каскадное мягкое удаление связанных столов (если настроено в БД)

**Ошибки:**
- 404 Not Found: помещение не найдено, неактивно или не принадлежит ресторану
- 400 Bad Request: помещение используется (есть активные столы в помещении)
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 2. Валидация полей помещения

#### 2.1. Правила валидации

**name** (название):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 255)`

**description** (описание):
- Опциональное поле (`nullable = true`)
- Тип: TEXT
- Максимальная длина на уровне валидации: 10000 символов (`@Size(max = 10000)`)

**floorId** (ID этажа):
- Обязательное поле (`@NotNull`)
- Тип: BIGINT
- Кастомная валидация:
  - Должно существовать в таблице `floors`
  - Этаж должен быть активным (`is_active = true`)
  - Этаж должен принадлежать ресторану
  - Кастомный валидатор: `@ValidFloorId` - проверка через сервис

**imageId** (ID изображения плана):
- Опциональное поле (`nullable = true`)
- Тип: BIGINT
- Кастомная валидация: `@ValidImageId`
- Примечание: превью изображения генерируется автоматически из основного изображения

#### 2.2. Кастомные валидаторы

**@ValidFloorId** - валидация существования и активности этажа:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidFloorIdValidator.class)
public @interface ValidFloorId {
    String message() default "Floor not found, inactive, or does not belong to restaurant";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `FloorRepository.findByIdAndRestaurantIdAndIsActiveTrue(floorId, restaurantId)`

#### 2.3. Логика проверки существования связанных сущностей

**Проверка этажа:**
1. При создании/обновлении помещения:
   - Выполнить запрос: `SELECT * FROM floors WHERE id = :floorId AND restaurant_id = :restaurantId AND is_active = true`
   - Если этаж не найден, неактивен или не принадлежит ресторану → вернуть ошибку 400

**Проверка принадлежности помещения к ресторану:**
1. При получении/обновлении/удалении помещения:
   - Выполнить запрос через JOIN: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE r.id = :roomId AND f.restaurant_id = :restaurantId AND r.is_active = true`
   - Если помещение не найдено или не принадлежит ресторану → вернуть ошибку 404

### 3. Загрузка планов помещений

#### 3.1. Процесс загрузки
- Загрузка изображения через `/admin-api/image` (см. шаг 3.1)
- При загрузке автоматически генерируется превью
- Сохранение `image_id` в поле `image_id` помещения
- Превью доступно через `/admin-api/image?id={imageId}&isPreview=true`
- ID должен быть активным (`is_active = true`)

#### 3.2. Отвязка изображений
- Установка `imageId = null` через PUT запрос
- Изображение остается в таблице `images` (не удаляется автоматически)

### 4. Логика soft delete

#### 4.1. Поведение при удалении
- Установка `is_active = false` и `deleted_at = NOW()`
- Помещение скрывается из всех GET запросов
- Каскадное мягкое удаление связанных столов (если настроено в БД)

#### 4.2. Проверка использования перед удалением
- Проверка наличия активных столов в помещении
- Если есть активные столы → вернуть ошибку 400 с сообщением "Room has active tables"
- Если активных столов нет → разрешить удаление

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Room Controller:
   - `POST /admin-api/r/:id/room` endpoint
   - `GET /admin-api/r/:id/room` endpoint (с фильтрацией по `floor_id`)
   - `PUT /admin-api/r/:id/room/:roomId` endpoint
   - `DELETE /admin-api/r/:id/room/:roomId` endpoint

2. ✅ Room Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка доступа к ресторану

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка существования этажа

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание помещения
   - Получение списка помещений (с фильтрацией по этажу)
   - Обновление помещения
   - Мягкое удаление помещения

2. ✅ Проверка доступа работает:
   - Менеджер может работать только со своими ресторанами
   - ADMIN может работать с любыми ресторанами

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Проверка существования этажа

4. ✅ Загрузка планов работает:
   - Планы помещений загружаются через `/admin-api/image`
   - Превью генерируется автоматически

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Проверка доступа через интерцептор работает
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Загрузка планов помещений работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


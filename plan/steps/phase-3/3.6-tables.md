# Шаг 3.6: Столы

## Описание
Реализация CRUD операций для столов ресторана, настройка характеристик столов и загрузка фотографий.

## Задачи

### 1. CRUD для столов

#### 1.1. POST `/admin-api/r/:id/table` - создание стола
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Request Body:**
```json
{
  "tableNumber": "string (required, max 50)",
  "roomId": "long (required, должен существовать в rooms и is_active = true)",
  "capacity": "integer (required, min: 1, max: 100)",
  "hasWindow": "boolean (optional, default: false)",
  "hasAirConditioning": "boolean (optional, default: false)",
  "isSmoking": "boolean (optional, default: false)",
  "imageId": "long (optional, должен существовать в images и is_active = true)",
  "depositAmount": "string (optional, текст с минимальной суммой депозита)",
  "depositNote": "string (optional, примечание о депозите, например 'только на напитки')"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "roomId": 1,
  "tableNumber": "1",
  "capacity": 4,
  "hasWindow": true,
  "hasAirConditioning": true,
  "isSmoking": false,
  "imageId": 123,
  "depositAmount": "5000 руб.",
  "depositNote": "только на напитки",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Проверка существования ресторана с `is_active = true`
3. Валидация всех полей
4. Проверка существования и активности помещения: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE r.id = :roomId AND f.restaurant_id = :id AND r.is_active = true`
5. Проверка уникальности номера стола в рамках помещения: `SELECT * FROM tables WHERE room_id = :roomId AND table_number = :tableNumber AND is_active = true`
6. Проверка существования и активности изображения (если указано)
7. Создание записи в таблице `tables`
8. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
9. Возврат созданного стола

**Ошибки:**
- 400 Bad Request: невалидные данные, помещение не найдено или неактивно, номер стола уже существует, изображение не найдено или неактивно
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.2. GET `/admin-api/r/:id/table` - список столов ресторана
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `limit` - integer (optional, default: 50, min: 1, max: 100)
- `offset` - integer (optional, default: 0, min: 0)
- `roomId` - long (optional) - фильтр по помещению
- `floorId` - long (optional) - фильтр по этажу
- `minCapacity` - integer (optional) - минимальное количество мест
- `maxCapacity` - integer (optional) - максимальное количество мест
- `hasWindow` - boolean (optional) - фильтр по наличию окна
- `hasAirConditioning` - boolean (optional) - фильтр по наличию кондиционера
- `isSmoking` - boolean (optional) - фильтр по разрешению курения
- `sortBy` - string (optional, default: "tableNumber") - поле для сортировки: "tableNumber", "capacity", "createdAt"
- `sortOrder` - string (optional, default: "asc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "restaurantId": 1,
      "roomId": 1,
      "tableNumber": "1",
      "capacity": 4,
      "hasWindow": true,
      "hasAirConditioning": true,
      "isSmoking": false,
      "imageId": 123,
      "depositAmount": "5000 руб.",
      "depositNote": "только на напитки",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 50,
    "limit": 50,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Построение запроса через JOIN: `SELECT t.* FROM tables t JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE f.restaurant_id = :id AND t.is_active = true`
3. Применение фильтров:
   - По помещению: `AND t.room_id = :roomId` (если указано)
   - По этажу: `AND r.floor_id = :floorId` (если указано)
   - По количеству мест: `AND t.capacity >= :minCapacity AND t.capacity <= :maxCapacity` (если указано)
   - По характеристикам: `AND t.has_window = :hasWindow` и т.д. (если указано)
4. Применение сортировки
5. Применение пагинации
6. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.3. GET `/admin-api/r/:id/table/:tableId` - получение стола
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `tableId` - long (required) - ID стола

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "roomId": 1,
  "tableNumber": "1",
  "capacity": 4,
  "hasWindow": true,
  "hasAirConditioning": true,
  "isSmoking": false,
  "imageId": 123,
  "depositAmount": "5000 руб.",
  "depositNote": "только на напитки",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск стола: `SELECT t.* FROM tables t JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE t.id = :tableId AND f.restaurant_id = :id AND t.is_active = true`
3. Возврат стола

**Ошибки:**
- 404 Not Found: стол не найден, неактивен или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.4. PUT `/admin-api/r/:id/table/:tableId` - обновление стола
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `tableId` - long (required) - ID стола

**Request Body:**
```json
{
  "tableNumber": "string (optional, max 50)",
  "roomId": "long (optional, должен существовать и быть активным)",
  "capacity": "integer (optional, min: 1, max: 100)",
  "hasWindow": "boolean (optional)",
  "hasAirConditioning": "boolean (optional)",
  "isSmoking": "boolean (optional)",
  "imageId": "long | null (optional)",
  "depositAmount": "string | null (optional, текст с минимальной суммой депозита)",
  "depositNote": "string | null (optional, примечание о депозите)"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "roomId": 1,
  "tableNumber": "1",
  "capacity": 4,
  "hasWindow": true,
  "hasAirConditioning": true,
  "isSmoking": false,
  "imageId": 123,
  "depositAmount": "5000 руб.",
  "depositNote": "только на напитки",
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск стола с проверкой принадлежности к ресторану
3. Валидация всех переданных полей
4. Проверка существования и активности помещения (если изменяется `roomId`)
5. Проверка уникальности номера стола (если изменяется `tableNumber` или `roomId`)
6. Проверка существования и активности изображения (если изменяется `imageId`)
7. Обновление только переданных полей
8. Установка `updated_at = NOW()`
9. Возврат обновленного стола

**Ошибки:**
- 400 Bad Request: невалидные данные, помещение не найдено или неактивно, номер стола уже существует, изображение не найдено или неактивно
- 404 Not Found: стол не найден, неактивен или не принадлежит ресторану
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

#### 1.5. DELETE `/admin-api/r/:id/table/:tableId` - удаление стола
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана
- `tableId` - long (required) - ID стола

**Response 204 No Content**

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск стола с проверкой принадлежности к ресторану
3. Проверка использования стола:
   - Проверка наличия активных бронирований: `SELECT COUNT(*) FROM bookings WHERE table_id = :tableId AND booking_status_id NOT IN (SELECT id FROM booking_statuses WHERE code IN ('CANCELLED', 'REJECTED'))`
   - Если есть активные бронирования → вернуть ошибку 400 (опционально)
4. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`

**Ошибки:**
- 404 Not Found: стол не найден, неактивен или не принадлежит ресторану
- 400 Bad Request: стол используется (есть активные бронирования, если проверка включена)
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 2. Валидация полей стола

#### 2.1. Правила валидации

**tableNumber** (номер стола):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 50 символов (`@Size(max = 50)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 50)`
- Кастомная проверка уникальности: номер должен быть уникальным в рамках помещения

**roomId** (ID помещения):
- Обязательное поле (`@NotNull`)
- Тип: BIGINT
- Кастомная валидация:
  - Должно существовать в таблице `rooms`
  - Помещение должно быть активным (`is_active = true`)
  - Помещение должно принадлежать ресторану (через этаж)
  - Кастомный валидатор: `@ValidRoomId` - проверка через сервис

**capacity** (количество мест):
- Обязательное поле (`@NotNull`)
- Тип: INTEGER
- Диапазон: от 1 до 100 (`@Min(1)`, `@Max(100)`)
- Валидатор: `@NotNull`, `@Min(1)`, `@Max(100)`

**hasWindow** (окно):
- Опциональное поле (default: false)
- Тип: BOOLEAN

**hasAirConditioning** (кондиционер):
- Опциональное поле (default: false)
- Тип: BOOLEAN

**isSmoking** (курение разрешено):
- Опциональное поле (default: false)
- Тип: BOOLEAN

**imageId** (ID изображения):
- Опциональное поле (`nullable = true`)
- Тип: BIGINT
- Кастомная валидация: `@ValidImageId`

**depositAmount** (минимальная сумма депозита):
- Опциональное поле (`nullable = true`)
- Тип: TEXT
- Валидатор: `@Size(max = 255)` (опционально, если нужно ограничение длины)

**depositNote** (примечание о депозите):
- Опциональное поле (`nullable = true`)
- Тип: TEXT
- Валидатор: `@Size(max = 1000)` (опционально, если нужно ограничение длины)

#### 2.2. Кастомные валидаторы

**@UniqueTableNumber** - проверка уникальности номера стола в рамках помещения:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = UniqueTableNumberValidator.class)
public @interface UniqueTableNumber {
    String message() default "Table number already exists for this room";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `TableRepository.findByRoomIdAndTableNumberAndIsActiveTrue(roomId, tableNumber)`

**@ValidRoomId** - валидация существования и активности помещения:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidRoomIdValidator.class)
public @interface ValidRoomId {
    String message() default "Room not found, inactive, or does not belong to restaurant";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через JOIN: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE r.id = :roomId AND f.restaurant_id = :restaurantId AND r.is_active = true`

#### 2.3. Логика проверки существования связанных сущностей

**Проверка помещения:**
1. При создании/обновлении стола:
   - Выполнить запрос через JOIN: `SELECT r.* FROM rooms r JOIN floors f ON r.floor_id = f.id WHERE r.id = :roomId AND f.restaurant_id = :restaurantId AND r.is_active = true`
   - Если помещение не найдено, неактивно или не принадлежит ресторану → вернуть ошибку 400

**Проверка принадлежности стола к ресторану:**
1. При получении/обновлении/удалении стола:
   - Выполнить запрос через JOIN: `SELECT t.* FROM tables t JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE t.id = :tableId AND f.restaurant_id = :restaurantId AND t.is_active = true`
   - Если стол не найден или не принадлежит ресторану → вернуть ошибку 404

### 3. Загрузка фотографий столов

#### 3.1. Процесс загрузки
- Загрузка изображения через `/admin-api/image` (см. шаг 3.1)
- Автоматическая генерация превью при загрузке
- Сохранение `image_id` в поле `image_id` стола
- Одно изображение на стол (на первом этапе)

#### 3.2. Отвязка изображения
- Установка `imageId = null` через PUT запрос
- Изображение остается в таблице `images` (не удаляется автоматически)

### 4. Карта расположения

#### 4.1. GET `/admin-api/r/:id/table/map` - получение карты столов
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `floorId` - long (optional) - фильтр по этажу
- `roomId` - long (optional) - фильтр по помещению

**Response 200 OK:**
```json
{
  "floors": [
    {
      "id": 1,
      "floorNumber": "1",
      "rooms": [
        {
          "id": 1,
          "name": "Зал 1",
          "imageId": 123,
          "previewImageId": 124,
          "tables": [
            {
              "id": 1,
              "tableNumber": "1",
              "capacity": 4,
              "hasWindow": true,
              "hasAirConditioning": true,
              "isSmoking": false,
              "imageId": 125,
              "depositAmount": "5000 руб.",
              "depositNote": "только на напитки"
            }
          ]
        }
      ]
    }
  ]
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Построение иерархической структуры: этажи → помещения → столы
3. Применение фильтров (если указаны)
4. Возврат структурированных данных для визуализации карты

### 5. Логика soft delete

#### 5.1. Поведение при удалении
- Установка `is_active = false` и `deleted_at = NOW()`
- Стол скрывается из всех GET запросов
- Стол остается в БД для истории и статистики

#### 5.2. Проверка использования перед удалением (опционально)
- Проверка наличия активных бронирований с этим столом
- Если проверка включена и есть активные бронирования → вернуть ошибку 400
- Если проверка отключена → разрешить удаление (стол просто скрывается)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Table Controller:
   - `POST /admin-api/r/:id/table` endpoint
   - `GET /admin-api/r/:id/table` endpoint (с фильтрацией)
   - `GET /admin-api/r/:id/table/:tableId` endpoint
   - `PUT /admin-api/r/:id/table/:tableId` endpoint
   - `DELETE /admin-api/r/:id/table/:tableId` endpoint

2. ✅ Table Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка доступа к ресторану

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка уникальности номера стола
   - Проверка существования помещения

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание стола
   - Получение списка столов (с фильтрацией)
   - Получение стола по ID
   - Обновление стола
   - Мягкое удаление стола

2. ✅ Проверка доступа работает:
   - Менеджер может работать только со своими ресторанами
   - ADMIN может работать с любыми ресторанами

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Уникальность номера стола проверяется
   - Проверка существования помещения

4. ✅ Загрузка фотографий работает:
   - Фотографии столов загружаются через `/admin-api/image`
   - Превью генерируется автоматически

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Проверка доступа через интерцептор работает
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Загрузка фотографий работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


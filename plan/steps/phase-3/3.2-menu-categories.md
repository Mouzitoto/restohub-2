# Шаг 3.2: Категории меню

## Описание
Реализация CRUD операций для глобальных категорий блюд, управление порядком отображения. Категории меню существуют независимо от ресторанов и используются всеми ресторанами.

## Задачи

### 1. CRUD для категорий блюд

#### 1.1. POST `/admin-api/menu-category` - создание категории
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Request Body:**
```json
{
  "name": "string (required, max 255, уникальное)",
  "description": "string (optional, TEXT, max 10000)",
  "displayOrder": "integer (optional, default: 0, min: 0)"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "name": "string",
  "description": "string | null",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа: только ADMIN может создавать категории
2. Валидация всех полей согласно правилам
3. Проверка уникальности названия категории глобально: `SELECT * FROM menu_categories WHERE name = :name AND is_active = true`
4. Создание записи в таблице `menu_categories`
5. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
6. Возврат созданной категории

**Ошибки:**
- 400 Bad Request: невалидные данные, дубликат названия категории
- 403 Forbidden: пользователь не ADMIN

#### 1.2. GET `/admin-api/menu-category` - список категорий
**Доступ:** ADMIN и MANAGER

**Query параметры:**
- `limit` - integer (optional, default: 100, min: 1, max: 200) - количество результатов
- `offset` - integer (optional, default: 0, min: 0) - смещение для пагинации
- `sortBy` - string (optional, default: "displayOrder") - поле для сортировки: "name", "displayOrder", "createdAt"
- `sortOrder` - string (optional, default: "asc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "string",
      "description": "string | null",
      "displayOrder": 0,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 10,
    "limit": 100,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Построение запроса: `SELECT * FROM menu_categories WHERE is_active = true`
2. Применение сортировки (по умолчанию по `display_order ASC`)
3. Применение пагинации (LIMIT/OFFSET)
4. Подсчет общего количества записей
5. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры

#### 1.3. GET `/admin-api/menu-category/:categoryId` - получение категории
**Доступ:** ADMIN и MANAGER

**Path параметры:**
- `categoryId` - long (required) - ID категории

**Response 200 OK:**
```json
{
  "id": 1,
  "name": "string",
  "description": "string | null",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Поиск категории: `SELECT * FROM menu_categories WHERE id = :categoryId AND is_active = true`
2. Возврат категории

**Ошибки:**
- 404 Not Found: категория не найдена или неактивна

#### 1.4. PUT `/admin-api/menu-category/:categoryId` - обновление категории
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Path параметры:**
- `categoryId` - long (required) - ID категории

**Request Body:**
```json
{
  "name": "string (optional, max 255, уникальное)",
  "description": "string (optional, TEXT, max 10000)",
  "displayOrder": "integer (optional, min: 0)"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "name": "string",
  "description": "string | null",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "deletedAt": null
}
```

**Логика:**
1. Проверка доступа: только ADMIN может обновлять категории
2. Поиск категории: `SELECT * FROM menu_categories WHERE id = :categoryId AND is_active = true`
3. Валидация всех переданных полей
4. Проверка уникальности названия глобально (если изменяется `name`): `SELECT * FROM menu_categories WHERE name = :name AND id != :categoryId AND is_active = true`
5. Обновление только переданных полей (PATCH-логика)
6. Установка `updated_at = NOW()`
7. Возврат обновленной категории

**Ошибки:**
- 400 Bad Request: невалидные данные, дубликат названия категории
- 404 Not Found: категория не найдена или неактивна
- 403 Forbidden: пользователь не ADMIN

#### 1.5. DELETE `/admin-api/menu-category/:categoryId` - удаление категории
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Path параметры:**
- `categoryId` - long (required) - ID категории

**Response 204 No Content**

**Логика:**
1. Проверка доступа: только ADMIN может удалять категории
2. Поиск категории: `SELECT * FROM menu_categories WHERE id = :categoryId AND is_active = true`
3. Проверка использования категории:
   - Проверка наличия активных блюд в категории: `SELECT COUNT(*) FROM menu_items WHERE menu_category_id = :categoryId AND is_active = true`
   - Если есть активные блюда → вернуть ошибку 400
4. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `deleted_at = NOW()`
   - Установка `updated_at = NOW()`
5. Каскадное мягкое удаление связанных блюд (если настроено в БД):
   - `menu_items` → `is_active = false`, `deleted_at = NOW()` для всех блюд категории

**Ошибки:**
- 404 Not Found: категория не найдена или неактивна
- 400 Bad Request: категория используется (есть активные блюда в категории)
- 403 Forbidden: пользователь не ADMIN

### 2. Валидация полей категории

#### 2.1. Правила валидации для каждого поля

**name** (название):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 255)`
- Кастомная проверка уникальности: название должно быть уникальным глобально

**description** (описание):
- Опциональное поле (`nullable = true`)
- Тип: TEXT (без ограничения длины в БД)
- Максимальная длина на уровне валидации: 10000 символов (`@Size(max = 10000)`)

**displayOrder** (порядок отображения):
- Опциональное поле при создании (default: 0)
- Тип: INTEGER
- Минимальное значение: 0 (`@Min(0)`)
- По умолчанию: 0 при создании

#### 2.2. Кастомные валидаторы

**@UniqueCategoryName** - проверка уникальности названия категории глобально:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = UniqueCategoryNameValidator.class)
public @interface UniqueCategoryName {
    String message() default "Category name already exists";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `MenuCategoryRepository.findByNameAndIsActiveTrue(name)`
- Возвращает ошибку, если категория с таким названием уже существует

#### 2.3. Логика проверки существования связанных сущностей

**Проверка категории:**
1. При получении/обновлении/удалении категории:
   - Выполнить запрос: `SELECT * FROM menu_categories WHERE id = :categoryId AND is_active = true`
   - Если категория не найдена или неактивна → вернуть ошибку 404

### 3. Управление порядком отображения

#### 3.1. Логика сортировки
- По умолчанию категории сортируются по `display_order ASC`
- Если `display_order` одинаковый, дополнительная сортировка по `created_at ASC`
- При создании новой категории `display_order` устанавливается как максимальное значение + 1 глобально

#### 3.2. Массовое обновление порядка (опционально)
**Endpoint:** `PUT /admin-api/menu-category/reorder`
**Доступ:** Только ADMIN

**Request Body:**
```json
{
  "categoryIds": [1, 3, 2, 4] // массив ID категорий в новом порядке
}
```

**Логика:**
1. Проверка доступа: только ADMIN
2. Проверка существования всех категорий: `SELECT * FROM menu_categories WHERE id IN (:categoryIds) AND is_active = true`
3. Обновление `display_order` для каждой категории согласно позиции в массиве (0, 1, 2, ...)
4. Установка `updated_at = NOW()` для всех обновленных категорий

### 4. Логика soft delete

#### 4.1. Поведение при удалении
- Установка `is_active = false` и `deleted_at = NOW()`
- Категория скрывается из всех GET запросов (фильтр `is_active = true`)
- Каскадное мягкое удаление связанных блюд (если настроено в БД)

#### 4.2. Проверка использования перед удалением
- Проверка наличия активных блюд в категории
- Если есть активные блюда → вернуть ошибку 400 с сообщением "Category has active menu items"
- Если активных блюд нет → разрешить удаление

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Category Controller:
   - `POST /admin-api/menu-category` endpoint
   - `GET /admin-api/menu-category` endpoint
   - `GET /admin-api/menu-category/:categoryId` endpoint
   - `PUT /admin-api/menu-category/:categoryId` endpoint
   - `DELETE /admin-api/menu-category/:categoryId` endpoint
   - `PUT /admin-api/menu-category/reorder` endpoint (опционально)

2. ✅ Category Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка уникальности названия

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка уникальности названия глобально

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание категории (только ADMIN)
   - Получение списка категорий (ADMIN и MANAGER)
   - Обновление категории (только ADMIN)
   - Мягкое удаление категории (только ADMIN)

2. ✅ Проверка доступа работает:
   - MANAGER может только просматривать категории
   - ADMIN может создавать, редактировать и удалять категории

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Уникальность названия проверяется глобально
   - Порядок отображения валидируется

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Проверка использования категории перед удалением работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


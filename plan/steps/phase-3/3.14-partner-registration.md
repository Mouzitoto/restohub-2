# Шаг 3.14: Регистрация партнеров

## Описание
Реализация API для регистрации новых партнеров (владельцев ресторанов) через публичный лендинг. Процесс регистрации включает: заполнение формы, подтверждение email через код (заглушка код 1234), создание пользователя с ролью MANAGER.

## Задачи

### 1. API endpoints для регистрации партнеров

#### 1.1. POST `/admin-api/auth/register` - регистрация нового партнера
**Доступ:** Публичный (без аутентификации)

**Request Body:**
```json
{
  "email": "string (required, max 255, уникальный, email format)",
  "password": "string (required, min 8 символов)",
  "confirmPassword": "string (required, должен совпадать с password)",
  "agreeToTerms": "boolean (required, должен быть true)"
}
```

**Response 200 OK:**
```json
{
  "message": "Код подтверждения отправлен на ваш email",
  "email": "partner@example.com"
}
```

**Логика:**
1. Валидация всех полей согласно правилам
2. Проверка уникальности email: `SELECT * FROM users WHERE email = :email AND is_active = true`
3. Проверка совпадения паролей (`password` и `confirmPassword`)
4. Проверка согласия с офертой (`agreeToTerms` должен быть `true`)
5. Генерация кода подтверждения (заглушка: код `1234`)
6. Сохранение кода подтверждения в таблице `email_verification_codes`:
   - `user_email` - email пользователя
   - `code` - хеш кода подтверждения (для заглушки можно хранить как есть или захешировать)
   - `expires_at` - TIMESTAMP (время истечения: NOW() + 15 минут)
   - `used` - BOOLEAN (default: false)
   - `created_at` - TIMESTAMP (NOW())
7. **Заглушка:** Вместо отправки email, код всегда `1234`
8. Возврат успешного ответа с сообщением

**Ошибки:**
- 400 Bad Request: невалидные данные, дубликат email, пароли не совпадают, не согласен с офертой
- 409 Conflict: email уже зарегистрирован

#### 1.2. POST `/admin-api/auth/verify-email` - подтверждение email
**Доступ:** Публичный (без аутентификации)

**Request Body:**
```json
{
  "email": "string (required, email format)",
  "code": "string (required, 4 символа)"
}
```

**Response 200 OK:**
```json
{
  "message": "Email успешно подтвержден. Регистрация завершена.",
  "userId": 1
}
```

**Логика:**
1. Валидация email и кода
2. Поиск кода подтверждения: `SELECT * FROM email_verification_codes WHERE user_email = :email AND used = false AND expires_at > NOW() ORDER BY created_at DESC LIMIT 1`
3. Проверка кода:
   - **Заглушка:** Если код = `1234`, считать валидным
   - В production: сравнение хеша кода
4. Если код не найден или истек → 400 Bad Request
5. Если код неверный → 400 Bad Request
6. Создание пользователя:
   - Хеширование пароля через BCrypt
   - Создание записи в таблице `users`:
     - `email` - email из запроса
     - `password` - хешированный пароль
     - `role_id` - 2 (MANAGER)
     - `is_active` - true
     - `email_verified` - true (новое поле в таблице users)
     - `created_at` - NOW()
     - `updated_at` - NOW()
7. Пометить код как использованный: `UPDATE email_verification_codes SET used = true, used_at = NOW() WHERE id = :codeId`
8. Возврат успешного ответа с ID созданного пользователя

**Ошибки:**
- 400 Bad Request: невалидные данные, код неверный, код истек, код уже использован
- 404 Not Found: код подтверждения не найден

#### 1.3. POST `/admin-api/auth/resend-verification-code` - повторная отправка кода
**Доступ:** Публичный (без аутентификации)

**Request Body:**
```json
{
  "email": "string (required, email format)"
}
```

**Response 200 OK:**
```json
{
  "message": "Код подтверждения отправлен на ваш email",
  "email": "partner@example.com"
}
```

**Логика:**
1. Валидация email
2. Проверка: пользователь с таким email не должен быть уже зарегистрирован и подтвержден
3. Генерация нового кода подтверждения (заглушка: код `1234`)
4. Пометить старые коды для этого email как использованные (если есть)
5. Сохранение нового кода в таблице `email_verification_codes`
6. **Заглушка:** Вместо отправки email, код всегда `1234`
7. Возврат успешного ответа

**Ошибки:**
- 400 Bad Request: невалидный email
- 409 Conflict: email уже зарегистрирован и подтвержден

#### 1.4. GET `/admin-api/auth/terms` - получение текста оферты
**Доступ:** Публичный (без аутентификации)

**Response 200 OK:**
```json
{
  "terms": "Текст оферты (заглушка)\n\nНастоящая оферта определяет условия использования платформы Resto-Hub...\n\n[Здесь будет полный текст оферты]"
}
```

**Логика:**
1. Возврат текста оферты (заглушка)
2. В будущем: текст может храниться в БД или конфигурации

**Ошибки:**
- Нет ошибок (всегда возвращает текст)

### 2. Структура таблицы email_verification_codes

Создать таблицу `email_verification_codes` в БД:
- `id` - BIGSERIAL PRIMARY KEY
- `user_email` - VARCHAR(255) NOT NULL (email пользователя)
- `code` - VARCHAR(255) NOT NULL (код подтверждения, для заглушки можно хранить как есть, в production - хеш)
- `expires_at` - TIMESTAMP NOT NULL (время истечения кода)
- `used` - BOOLEAN NOT NULL DEFAULT FALSE (использован ли код)
- `created_at` - TIMESTAMP NOT NULL DEFAULT NOW()
- `used_at` - TIMESTAMP NULL (когда код был использован)
- Индекс на `user_email` для быстрого поиска
- Индекс на `code` для быстрого поиска при валидации
- Автоматическая очистка: удалять истекшие коды (через scheduled task или при проверке)

### 3. Добавление поля email_verified в таблицу users

Добавить поле `email_verified` в таблицу `users`:
- `email_verified` - BOOLEAN NOT NULL DEFAULT FALSE
- При создании пользователя через регистрацию: `email_verified = true` (после подтверждения кода)
- При создании пользователя через админ-панель: `email_verified = true` (по умолчанию)

### 4. Валидация данных

#### 4.1. Email
- Обязательное поле
- Формат: email (regex: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`)
- Максимальная длина: 255 символов
- Уникальность: не должно быть другого активного пользователя с таким email

#### 4.2. Password
- Обязательное поле
- Минимальная длина: 8 символов
- Хеширование через BCrypt перед сохранением

#### 4.3. ConfirmPassword
- Обязательное поле
- Должен совпадать с `password`

#### 4.4. AgreeToTerms
- Обязательное поле
- Должен быть `true`
- Если `false` → 400 Bad Request

#### 4.5. Code
- Обязательное поле
- Формат: 4 символа (для заглушки: `1234`)
- В production: может быть 6-значный числовой код

### 5. Безопасность

#### 5.1. Хеширование паролей
- Использовать BCrypt для хеширования паролей
- Никогда не возвращать пароль в ответах API

#### 5.2. Защита от спама
- Ограничение частоты запросов на `/auth/register` и `/auth/resend-verification-code` (rate limiting)
- Один код подтверждения активен в течение 15 минут
- После использования кода, он больше не может быть использован

#### 5.3. Валидация кода
- Код действителен только в течение 15 минут
- Код может быть использован только один раз
- При повторной отправке кода, старые коды помечаются как использованные

### 6. Заглушка для отправки email

**Текущая реализация (заглушка):**
- Код подтверждения всегда `1234`
- Email не отправляется
- Код сохраняется в БД для проверки

**Будущая реализация:**
- Интеграция с email сервисом (SMTP, SendGrid, AWS SES и т.д.)
- Генерация случайного 6-значного кода
- Отправка email с кодом подтверждения
- Хеширование кода перед сохранением в БД

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Partner Registration Controller:
   - `POST /admin-api/auth/register` endpoint
   - `POST /admin-api/auth/verify-email` endpoint
   - `POST /admin-api/auth/resend-verification-code` endpoint
   - `GET /admin-api/auth/terms` endpoint

2. ✅ Partner Registration Service:
   - Метод для регистрации партнера
   - Метод для подтверждения email
   - Метод для повторной отправки кода
   - Валидация данных
   - Хеширование паролей через BCrypt
   - Работа с таблицей `email_verification_codes`

3. ✅ DTO классы:
   - `RegisterPartnerRequest`
   - `VerifyEmailRequest`
   - `ResendVerificationCodeRequest`
   - `RegisterPartnerResponse`
   - `VerifyEmailResponse`
   - `TermsResponse`

4. ✅ Миграция БД:
   - Создание таблицы `email_verification_codes`
   - Добавление поля `email_verified` в таблицу `users`

### Функциональные проверки:
1. ✅ Регистрация партнера работает:
   - Валидация всех полей
   - Проверка уникальности email
   - Проверка совпадения паролей
   - Проверка согласия с офертой
   - Генерация кода подтверждения (заглушка: 1234)
   - Сохранение кода в БД

2. ✅ Подтверждение email работает:
   - Валидация кода
   - Проверка срока действия кода
   - Создание пользователя с ролью MANAGER
   - Хеширование пароля
   - Помечание кода как использованного

3. ✅ Повторная отправка кода работает:
   - Генерация нового кода
   - Помечание старых кодов как использованных
   - Сохранение нового кода в БД

4. ✅ Получение текста оферты работает:
   - GET запрос на `/admin-api/auth/terms` возвращает текст оферты

5. ✅ Валидация работает:
   - Все поля валидируются корректно
   - Ошибки возвращаются с понятными сообщениями

6. ✅ Безопасность работает:
   - Пароли хешируются через BCrypt
   - Коды подтверждения имеют срок действия
   - Rate limiting работает (если реализован)

### Критерии готовности:
- ✅ Все endpoints для регистрации партнеров реализованы
- ✅ Валидация всех полей работает
- ✅ Хеширование паролей через BCrypt работает
- ✅ Работа с таблицей `email_verification_codes` работает
- ✅ Заглушка для кода подтверждения (1234) работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда:
- Все endpoints регистрации партнеров работают
- Валидация и безопасность работают корректно
- Заглушка для кода подтверждения работает
- Все функциональные проверки пройдены успешно


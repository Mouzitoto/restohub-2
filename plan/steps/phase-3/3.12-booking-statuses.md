# Шаг 3.12: Статусы бронирований

## Описание
Реализация CRUD операций для управления статусами бронирований и предзаказов. Доступ только для ADMIN.

## Задачи

### 1. CRUD для статусов бронирований

#### 1.1. POST `/admin-api/booking-status` - создание статуса
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Request Body:**
```json
{
  "code": "string (required, max 50, уникальное, только латинские буквы и подчеркивания)",
  "name": "string (required, max 255)",
  "displayOrder": "integer (optional, default: 0, min: 0)"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "code": "string",
  "name": "string",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

**Логика:**
1. Проверка доступа: только ADMIN может создавать статусы
2. Валидация всех полей согласно правилам
3. Проверка уникальности кода: `SELECT * FROM booking_statuses WHERE code = :code AND is_active = true`
4. Создание записи в таблице `booking_statuses`
5. Установка `is_active = true`, `created_at = NOW()`, `updated_at = NOW()`
6. Возврат созданного статуса

**Ошибки:**
- 400 Bad Request: невалидные данные, дубликат кода
- 403 Forbidden: пользователь не ADMIN

#### 1.2. GET `/admin-api/booking-status` - список статусов
**Доступ:** ADMIN и MANAGER

**Query параметры:**
- `limit` - integer (optional, default: 100, min: 1, max: 200) - количество результатов
- `offset` - integer (optional, default: 0, min: 0) - смещение для пагинации
- `sortBy` - string (optional, default: "displayOrder") - поле для сортировки: "code", "name", "displayOrder", "createdAt"
- `sortOrder` - string (optional, default: "asc") - порядок сортировки: "asc" или "desc"

**Response 200 OK:**
```json
{
  "data": [
    {
      "id": 1,
      "code": "PENDING",
      "name": "Ожидает подтверждения",
      "displayOrder": 0,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 4,
    "limit": 100,
    "offset": 0,
    "hasMore": false
  }
}
```

**Логика:**
1. Построение запроса: `SELECT * FROM booking_statuses WHERE is_active = true`
2. Применение сортировки (по умолчанию по `display_order ASC`)
3. Применение пагинации (LIMIT/OFFSET)
4. Подсчет общего количества записей
5. Возврат списка с пагинацией

**Ошибки:**
- 400 Bad Request: невалидные query параметры

#### 1.3. GET `/admin-api/booking-status/:statusId` - получение статуса
**Доступ:** ADMIN и MANAGER

**Path параметры:**
- `statusId` - long (required) - ID статуса

**Response 200 OK:**
```json
{
  "id": 1,
  "code": "PENDING",
  "name": "Ожидает подтверждения",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

**Логика:**
1. Поиск статуса: `SELECT * FROM booking_statuses WHERE id = :statusId AND is_active = true`
2. Возврат статуса

**Ошибки:**
- 404 Not Found: статус не найден или неактивен

#### 1.4. PUT `/admin-api/booking-status/:statusId` - обновление статуса
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Path параметры:**
- `statusId` - long (required) - ID статуса

**Request Body:**
```json
{
  "name": "string (optional, max 255)",
  "displayOrder": "integer (optional, min: 0)"
}
```

**Response 200 OK:**
```json
{
  "id": 1,
  "code": "PENDING",
  "name": "string",
  "displayOrder": 0,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

**Логика:**
1. Проверка доступа: только ADMIN может обновлять статусы
2. Поиск статуса: `SELECT * FROM booking_statuses WHERE id = :statusId AND is_active = true`
3. Валидация всех переданных полей
4. Обновление только переданных полей (PATCH-логика)
5. **Поле `code` нельзя изменять** (неизменяемое после создания)
6. Установка `updated_at = NOW()`
7. Возврат обновленного статуса

**Ошибки:**
- 400 Bad Request: невалидные данные
- 404 Not Found: статус не найден или неактивен
- 403 Forbidden: пользователь не ADMIN

#### 1.5. DELETE `/admin-api/booking-status/:statusId` - удаление статуса
**Доступ:** Только ADMIN (`@PreAuthorize("hasRole('ADMIN')")`)

**Path параметры:**
- `statusId` - long (required) - ID статуса

**Response 204 No Content**

**Логика:**
1. Проверка доступа: только ADMIN может удалять статусы
2. Поиск статуса: `SELECT * FROM booking_statuses WHERE id = :statusId AND is_active = true`
3. Проверка использования статуса:
   - Проверка наличия бронирований с этим статусом: `SELECT COUNT(*) FROM bookings WHERE booking_status_id = :statusId`
   - Проверка наличия предзаказов с этим статусом: `SELECT COUNT(*) FROM pre_orders WHERE booking_status_id = :statusId`
   - Если есть бронирования или предзаказы → вернуть ошибку 400
4. Мягкое удаление:
   - Установка `is_active = false`
   - Установка `updated_at = NOW()`

**Ошибки:**
- 404 Not Found: статус не найден или неактивен
- 400 Bad Request: статус используется (есть бронирования или предзаказы с этим статусом)
- 403 Forbidden: пользователь не ADMIN

### 2. Валидация полей статуса

#### 2.1. Правила валидации для каждого поля

**code** (код статуса):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 50 символов (`@Size(max = 50)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 50)`
- Формат: только латинские буквы (верхний регистр), цифры и подчеркивания (`@Pattern(regexp = "^[A-Z0-9_]+$")`)
- Кастомная проверка уникальности: код должен быть уникальным глобально

**name** (название статуса):
- Обязательное поле (`@NotNull`)
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)
- Валидатор: `@NotBlank`, `@Size(max = 255)`

**displayOrder** (порядок отображения):
- Опциональное поле при создании (default: 0)
- Тип: INTEGER
- Минимальное значение: 0 (`@Min(0)`)
- По умолчанию: 0 при создании

#### 2.2. Кастомные валидаторы

**@UniqueBookingStatusCode** - проверка уникальности кода статуса глобально:
```java
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = UniqueBookingStatusCodeValidator.class)
public @interface UniqueBookingStatusCode {
    String message() default "Booking status code already exists";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через `BookingStatusRepository.findByCodeAndIsActiveTrue(code)`
- Возвращает ошибку, если статус с таким кодом уже существует

#### 2.3. Логика проверки существования связанных сущностей

**Проверка статуса:**
1. При получении/обновлении/удалении статуса:
   - Выполнить запрос: `SELECT * FROM booking_statuses WHERE id = :statusId AND is_active = true`
   - Если статус не найден или неактивен → вернуть ошибку 404

**Проверка использования статуса:**
1. При удалении статуса:
   - Проверить наличие бронирований: `SELECT COUNT(*) FROM bookings WHERE booking_status_id = :statusId`
   - Проверить наличие предзаказов: `SELECT COUNT(*) FROM pre_orders WHERE booking_status_id = :statusId`
   - Если есть записи → вернуть ошибку 400 с сообщением "Status is in use"

### 3. Логика soft delete

#### 3.1. Поведение при удалении
- Установка `is_active = false`
- Статус скрывается из всех GET запросов (фильтр `is_active = true`)
- Статус нельзя удалить, если он используется в бронированиях или предзаказах

#### 3.2. Проверка использования перед удалением
- Проверка наличия бронирований с этим статусом
- Проверка наличия предзаказов с этим статусом
- Если есть записи → вернуть ошибку 400 с сообщением "Status is in use"
- Если записей нет → разрешить удаление

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ BookingStatus Controller:
   - `POST /admin-api/booking-status` endpoint
   - `GET /admin-api/booking-status` endpoint
   - `GET /admin-api/booking-status/:statusId` endpoint
   - `PUT /admin-api/booking-status/:statusId` endpoint
   - `DELETE /admin-api/booking-status/:statusId` endpoint

2. ✅ BookingStatus Service:
   - Методы для CRUD операций
   - Валидация данных
   - Проверка использования статуса перед удалением

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка уникальности кода
   - Проверка формата кода (только латинские буквы, цифры, подчеркивания)

### Функциональные проверки:
1. ✅ CRUD операции работают:
   - Создание статуса (только ADMIN)
   - Получение списка статусов (ADMIN и MANAGER)
   - Обновление статуса (только ADMIN)
   - Мягкое удаление статуса (только ADMIN)

2. ✅ Проверка доступа работает:
   - MANAGER может только просматривать статусы
   - ADMIN может создавать, редактировать и удалять статусы

3. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Уникальность кода проверяется глобально
   - Формат кода проверяется (только латинские буквы, цифры, подчеркивания)
   - Проверка использования статуса перед удалением работает

### Критерии готовности:
- ✅ Все CRUD endpoints работают
- ✅ Валидация данных работает
- ✅ Мягкое удаление работает корректно
- ✅ Проверка использования статуса перед удалением работает
- ✅ Поле `code` нельзя изменять после создания
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


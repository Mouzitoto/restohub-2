# Шаг 3.10: Аналитика

## Описание
Реализация API для получения статистики и аналитики: бронирования, предзаказы, клиенты, экспорт данных.

## Задачи

### 1. API для статистики бронирований

#### 1.1. GET `/admin-api/r/:id/analytics/booking` - статистика бронирований
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `dateFrom` - date (optional, format: YYYY-MM-DD, default: 30 дней назад) - дата начала периода
- `dateTo` - date (optional, format: YYYY-MM-DD, default: сегодня) - дата окончания периода
- `groupBy` - string (optional, default: "day") - группировка: "day", "week", "month"

**Response 200 OK:**
```json
{
  "restaurantId": 1,
  "period": {
    "dateFrom": "2024-01-01",
    "dateTo": "2024-01-31"
  },
  "summary": {
    "total": 150,
    "byStatus": {
      "PENDING": 10,
      "APPROVED": 80,
      "REJECTED": 20,
      "CANCELLED": 10
    },
    "averagePersons": 3.5,
    "conversionRate": 0.73
  },
  "chart": [
    {
      "period": "2024-01-01",
      "count": 5,
      "byStatus": {
        "PENDING": 1,
        "APPROVED": 2
      }
    }
  ],
  "popularTables": [
    {
      "tableId": 1,
      "tableNumber": "1",
      "count": 25,
      "percentage": 16.67
    }
  ]
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана по ID с `is_active = true`
3. Валидация дат: `dateFrom <= dateTo`, `dateTo <= CURRENT_DATE`
4. Построение запроса для получения бронирований:
   - `SELECT b.*, t.table_number FROM bookings b JOIN tables t ON b.table_id = t.id JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE f.restaurant_id = :id AND b.booking_date >= :dateFrom AND b.booking_date <= :dateTo`
5. Расчет общей статистики:
   - Общее количество: `COUNT(*)`
   - По статусам: `GROUP BY status`
   - Среднее количество персон: `AVG(person_count)`
   - Конверсия: `APPROVED / total * 100`
6. Группировка по периодам:
   - По дням: `DATE_TRUNC('day', booking_date)`
   - По неделям: `DATE_TRUNC('week', booking_date)`
   - По месяцам: `DATE_TRUNC('month', booking_date)`
7. Популярные столы:
   - `SELECT table_id, COUNT(*) as count FROM bookings WHERE ... GROUP BY table_id ORDER BY count DESC LIMIT 10`
8. Возврат статистики

**Ошибки:**
- 400 Bad Request: невалидные query параметры, неверные даты
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 2. API для статистики предзаказов

#### 2.1. GET `/admin-api/r/:id/analytics/pre-order` - статистика предзаказов
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `dateFrom` - date (optional, format: YYYY-MM-DD, default: 30 дней назад)
- `dateTo` - date (optional, format: YYYY-MM-DD, default: сегодня)
- `groupBy` - string (optional, default: "day") - группировка: "day", "week", "month"

**Response 200 OK:**
```json
{
  "restaurantId": 1,
  "period": {
    "dateFrom": "2024-01-01",
    "dateTo": "2024-01-31"
  },
  "summary": {
    "total": 100,
    "byStatus": {
      "PENDING": 5,
      "APPROVED": 70,
      "REJECTED": 5,
      "CANCELLED": 5
    },
    "totalRevenue": 350000.00,
    "averageCheck": 3500.00,
    "conversionRate": 0.85
  },
  "chart": [
    {
      "period": "2024-01-01",
      "count": 3,
      "revenue": 10500.00
    }
  ],
  "popularItems": [
    {
      "menuItemId": 1,
      "menuItemName": "Пицца Маргарита",
      "quantity": 50,
      "revenue": 50000.00,
      "percentage": 14.29
    }
  ]
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана и валидация дат
3. Построение запроса для получения предзаказов:
   - `SELECT po.* FROM pre_orders po WHERE po.restaurant_id = :id AND po.date >= :dateFrom AND po.date <= :dateTo`
4. Расчет общей статистики:
   - Общее количество: `COUNT(*)`
   - По статусам: `GROUP BY status`
   - Общая выручка: `SUM(total_amount)`
   - Средний чек: `AVG(total_amount)`
   - Конверсия: `APPROVED / total * 100`
5. Группировка по периодам (аналогично бронированиям)
6. Популярные блюда:
   - `SELECT poi.menu_item_id, mi.name, SUM(poi.quantity) as quantity, SUM(poi.total_price) as revenue FROM pre_order_items poi JOIN menu_items mi ON poi.menu_item_id = mi.id JOIN pre_orders po ON poi.pre_order_id = po.id WHERE po.restaurant_id = :id AND po.date >= :dateFrom AND po.date <= :dateTo GROUP BY poi.menu_item_id, mi.name ORDER BY quantity DESC LIMIT 10`
7. Возврат статистики

**Ошибки:**
- 400 Bad Request: невалидные query параметры, неверные даты
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 3. API для статистики клиентов

#### 3.1. GET `/admin-api/r/:id/analytics/client` - статистика клиентов
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `dateFrom` - date (optional, format: YYYY-MM-DD, default: 30 дней назад)
- `dateTo` - date (optional, format: YYYY-MM-DD, default: сегодня)

**Response 200 OK:**
```json
{
  "restaurantId": 1,
  "period": {
    "dateFrom": "2024-01-01",
    "dateTo": "2024-01-31"
  },
  "summary": {
    "total": 200,
    "newClients": 50,
    "returningClients": 150,
    "averageBookingsPerClient": 1.5,
    "averagePreOrdersPerClient": 0.8
  },
  "topClients": [
    {
      "clientId": 1,
      "clientPhone": "+79991234567",
      "totalBookings": 10,
      "totalPreOrders": 5,
      "totalSpent": 25000.00
    }
  ]
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана и валидация дат
3. Расчет общей статистики:
   - Общее количество клиентов: `SELECT COUNT(DISTINCT client_id) FROM bookings WHERE restaurant_id = :id AND booking_date >= :dateFrom AND booking_date <= :dateTo UNION SELECT COUNT(DISTINCT client_id) FROM pre_orders WHERE restaurant_id = :id AND date >= :dateFrom AND date <= :dateTo`
   - Новые клиенты: `SELECT COUNT(*) FROM clients WHERE restaurant_id = :id AND first_booking_date >= :dateFrom AND first_booking_date <= :dateTo`
   - Постоянные клиенты: `SELECT COUNT(*) FROM clients WHERE restaurant_id = :id AND total_bookings > 1 OR total_pre_orders > 1`
   - Среднее количество бронирований: `SELECT AVG(total_bookings) FROM clients WHERE restaurant_id = :id`
   - Среднее количество предзаказов: `SELECT AVG(total_pre_orders) FROM clients WHERE restaurant_id = :id`
4. Топ клиентов:
   - `SELECT c.id, c.phone, c.total_bookings, c.total_pre_orders, (SELECT SUM(total_amount) FROM pre_orders WHERE client_id = c.id AND restaurant_id = :id) as total_spent FROM clients c WHERE c.restaurant_id = :id ORDER BY total_bookings DESC, total_pre_orders DESC LIMIT 10`
5. Возврат статистики

**Ошибки:**
- 400 Bad Request: невалидные query параметры, неверные даты
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 4. API для экспорта данных

#### 4.1. GET `/admin-api/r/:id/analytics/export` - экспорт данных
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `type` - string (required) - тип данных: "booking", "pre-order", "client"
- `dateFrom` - date (optional, format: YYYY-MM-DD, default: 30 дней назад)
- `dateTo` - date (optional, format: YYYY-MM-DD, default: сегодня)
- `format` - string (optional, default: "csv") - формат экспорта: "csv", "xlsx", "json"

**Response 200 OK:**
- Content-Type: `text/csv` (для CSV), `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` (для XLSX), `application/json` (для JSON)
- Content-Disposition: `attachment; filename="export_YYYY-MM-DD_HH-MM-SS.csv"`
- Body: файл с данными

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана и валидация дат
3. Валидация типа данных и формата
4. Получение данных в зависимости от типа:
   - Бронирования: `SELECT b.*, t.table_number, r.name as room_name FROM bookings b JOIN tables t ON b.table_id = t.id JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE f.restaurant_id = :id AND b.booking_date >= :dateFrom AND b.booking_date <= :dateTo`
   - Предзаказы: `SELECT po.*, (SELECT json_agg(json_build_object('menuItemName', mi.name, 'quantity', poi.quantity, 'price', poi.price, 'totalPrice', poi.total_price)) FROM pre_order_items poi JOIN menu_items mi ON poi.menu_item_id = mi.id WHERE poi.pre_order_id = po.id) as items FROM pre_orders po WHERE po.restaurant_id = :id AND po.date >= :dateFrom AND po.date <= :dateTo`
   - Клиенты: `SELECT c.* FROM clients c WHERE c.restaurant_id = :id AND (c.first_booking_date >= :dateFrom AND c.first_booking_date <= :dateTo OR c.last_booking_date >= :dateFrom AND c.last_booking_date <= :dateTo)`
5. Генерация файла:
   - CSV: использование библиотеки (например, Apache Commons CSV)
   - XLSX: использование библиотеки (например, Apache POI)
   - JSON: сериализация в JSON
6. Возврат файла с правильными заголовками

**Ошибки:**
- 400 Bad Request: невалидные query параметры, неверный тип данных или формат
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану
- 500 Internal Server Error: ошибка при генерации файла

### 5. API для общей статистики

#### 5.1. GET `/admin-api/r/:id/analytics/overview` - общая статистика
**Доступ:** ADMIN и MANAGER (через интерцептор `/r/*`)

**Path параметры:**
- `id` - long (required) - ID ресторана

**Query параметры:**
- `dateFrom` - date (optional, format: YYYY-MM-DD, default: 30 дней назад)
- `dateTo` - date (optional, format: YYYY-MM-DD, default: сегодня)

**Response 200 OK:**
```json
{
  "restaurantId": 1,
  "period": {
    "dateFrom": "2024-01-01",
    "dateTo": "2024-01-31"
  },
  "bookings": {
    "total": 150,
    "approved": 80,
    "conversionRate": 0.53
  },
  "preOrders": {
    "total": 100,
    "approved": 70,
    "totalRevenue": 350000.00,
    "averageCheck": 3500.00,
    "conversionRate": 0.70
  },
  "clients": {
    "total": 200,
    "new": 50,
    "returning": 150
  },
  "popularItems": [
    {
      "menuItemId": 1,
      "menuItemName": "Пицца Маргарита",
      "quantity": 50
    }
  ],
  "popularTables": [
    {
      "tableId": 1,
      "tableNumber": "1",
      "count": 25
    }
  ]
}
```

**Логика:**
1. Проверка доступа через интерцептор `/r/*` (для MANAGER)
2. Поиск ресторана и валидация дат
3. Агрегация данных из всех предыдущих endpoints:
   - Статистика бронирований (упрощенная)
   - Статистика предзаказов (упрощенная)
   - Статистика клиентов (упрощенная)
   - Популярные блюда (топ 5)
   - Популярные столы (топ 5)
4. Возврат общей статистики

**Ошибки:**
- 400 Bad Request: невалидные query параметры, неверные даты
- 404 Not Found: ресторан не найден или неактивен
- 403 Forbidden: MANAGER не имеет доступа к этому ресторану

### 6. Валидация и бизнес-логика

#### 6.1. Валидация параметров
- **dateFrom/dateTo**: формат YYYY-MM-DD, `dateFrom <= dateTo`, `dateTo <= CURRENT_DATE`
- **groupBy**: только значения "day", "week", "month"
- **type** (для экспорта): только значения "booking", "pre-order", "client"
- **format** (для экспорта): только значения "csv", "xlsx", "json"

#### 6.2. Проверка принадлежности к ресторану
- Все запросы проверяют принадлежность данных к ресторану через JOIN или прямую проверку `restaurant_id`
- Для бронирований: через `tables → rooms → floors → restaurants`
- Для предзаказов: через `pre_orders.restaurant_id`
- Для клиентов: через связь с бронированиями/предзаказами ресторана

#### 6.3. Оптимизация запросов
- Использование индексов на `restaurant_id`, `booking_date`, `date` (для предзаказов)
- Кэширование результатов для часто запрашиваемых периодов (опционально)
- Ограничение максимального периода (например, не более 1 года)

#### 6.4. Обработка больших объемов данных
- Пагинация для экспорта (если данных много)
- Потоковая генерация файлов для экспорта
- Асинхронная обработка для больших периодов (опционально)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Analytics Controller:
   - `GET /admin-api/r/:id/analytics/booking` endpoint
   - `GET /admin-api/r/:id/analytics/pre-order` endpoint
   - `GET /admin-api/r/:id/analytics/client` endpoint
   - `GET /admin-api/r/:id/analytics/export` endpoint
   - `GET /admin-api/r/:id/analytics/overview` endpoint

2. ✅ Analytics Service:
   - Методы для расчета статистики
   - Методы для группировки данных
   - Методы для экспорта данных

3. ✅ Валидация:
   - Валидация параметров запросов
   - Проверка доступа к ресторану

### Функциональные проверки:
1. ✅ Статистика бронирований работает:
   - Данные возвращаются корректно
   - Группировка работает
   - Фильтрация по датам работает

2. ✅ Статистика предзаказов работает:
   - Данные возвращаются корректно
   - Расчет выручки работает
   - Популярные блюда определяются корректно

3. ✅ Статистика клиентов работает:
   - Данные возвращаются корректно
   - Расчет метрик работает

4. ✅ Экспорт данных работает:
   - Файлы генерируются корректно
   - Форматы CSV/Excel работают

5. ✅ Общая статистика работает:
   - Все метрики рассчитываются корректно

### Критерии готовности:
- ✅ Все endpoints работают
- ✅ Проверка доступа через интерцептор работает
- ✅ Расчет статистики работает корректно
- ✅ Экспорт данных работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.


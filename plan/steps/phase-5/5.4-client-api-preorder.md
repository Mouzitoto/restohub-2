# Шаг 5.4: Предзаказ

## Описание
Реализация процесса предзаказа блюд через WhatsApp бот. Предзаказ создается WhatsApp ботом, который уже знает номер телефона клиента.

## Процесс предзаказа

1. Клиент общается с WhatsApp ботом
2. WhatsApp бот получает от клиента:
   - Номер телефона (из WhatsApp API)
   - Имя клиента ("свое имя")
   - Данные предзаказа: список блюд с количеством, дата, время
   - "На чье имя предзаказ" (может отличаться от имени клиента)
   - Особые пожелания (опционально)
   - Привязка к бронированию (опционально)
3. WhatsApp бот вызывает API для создания предзаказа
4. API создает/обновляет клиента в таблице `clients`:
   - Если клиент существует - обновляет `first_name` (если указано новое имя) и `last_booking_date`
   - Если клиент новый - создает запись с `phone` и `first_name`
5. API создает предзаказ в таблице `pre_orders`:
   - `client_id` - обязательное поле (клиент уже существует)
   - `client_name` - "на чье имя предзаказ"
   - `booking_status_id` - PENDING
6. API создает записи в `pre_order_items` для каждой позиции
7. API создает запись в `pre_order_history` (PENDING)
8. API уведомляет WhatsApp бота о новом предзаказе
9. WhatsApp бот отправляет сообщение менеджеру ресторана с информацией о предзаказе (на языке из `restaurants.manager_language_code`)
10. Менеджер подтверждает/отклоняет предзаказ через кнопку внутри WhatsApp чата с ботом
11. Менеджер может нажать кнопку "Связаться с клиентом" для открытия WhatsApp чата с клиентом

## Задачи

### 1. API для создания предзаказа (вызывается WhatsApp ботом)
- **POST** `/admin-api/pre-order` (публичный endpoint, вызывается WhatsApp ботом)
- Тело запроса:
  - `restaurant_id` - long (required) - ID ресторана
  - `booking_id` - long (optional) - ID бронирования (для привязки к бронированию)
  - `date` - date (required, format: YYYY-MM-DD) - дата предзаказа
  - `time` - time (required, format: HH:mm:ss) - время предзаказа
  - `client_phone` - string (required) - номер телефона клиента (получен от WhatsApp API, формат: +7XXXXXXXXXX)
  - `client_first_name` - string (optional, max 255) - "свое имя" клиента
  - `client_name` - string (optional, max 255) - "на чье имя предзаказ"
  - `items` - array (required, min: 1) - массив позиций:
    - `menu_item_id` - long (required) - ID блюда
    - `quantity` - integer (required, min: 1) - количество
    - `special_requests` - string (optional, TEXT, max 10000) - особые пожелания к блюду
  - `special_requests` - string (optional, TEXT, max 10000) - общие особые пожелания
  - `whatsapp_message_id` - string (optional, max 255) - ID сообщения в WhatsApp

**Response 201 Created:**
```json
{
  "id": 1,
  "restaurantId": 1,
  "bookingId": null,
  "date": "2024-01-15",
  "time": "19:00:00",
  "clientId": 1,
  "clientName": "Иван Иванов",
  "totalAmount": 3500.00,
  "itemsCount": 3,
  "status": {
    "code": "PENDING",
    "name": "Ожидает подтверждения"
  },
  "createdAt": "2024-01-01T09:00:00Z"
}
```

**Логика:**
1. Валидация всех полей согласно правилам
2. Проверка существования ресторана: `SELECT * FROM restaurants WHERE id = :restaurantId AND is_active = true`
3. Проверка активной подписки: `SELECT * FROM restaurant_subscriptions WHERE restaurant_id = :restaurantId AND is_active = true`
4. Проверка существования всех блюд: `SELECT * FROM menu_items WHERE id IN (:menuItemIds) AND is_active = true`
5. Проверка принадлежности блюд к ресторану: `SELECT * FROM menu_items WHERE id IN (:menuItemIds) AND restaurant_id = :restaurantId`
6. Проверка доступности блюд (is_available = true)
7. Валидация формата даты и времени
8. Проверка, что дата/время не в прошлом
9. Проверка привязки к бронированию (если указано `booking_id`):
   - Проверка существования бронирования: `SELECT * FROM bookings WHERE id = :bookingId AND is_active = true`
   - Проверка принадлежности бронирования к ресторану
10. Нормализация номера телефона к формату `+7XXXXXXXXXX`
11. Работа с таблицей `clients`:
    - Поиск клиента: `SELECT * FROM clients WHERE phone = :phone`
    - Если клиент существует:
      - Обновить `first_name = :clientFirstName` (если указано)
      - Обновить `last_booking_date = NOW()`
      - Увеличить `total_pre_orders = total_pre_orders + 1`
      - Обновить `updated_at = NOW()`
      - Сохранить `client_id` для предзаказа
    - Если клиент не существует:
      - Создать нового клиента:
        - `phone = :phone` (нормализованный)
        - `first_name = :clientFirstName` (если указано)
        - `first_booking_date = NULL` (если нет бронирований)
        - `last_booking_date = NULL` (если нет бронирований)
        - `total_bookings = 0`
        - `total_pre_orders = 1`
        - `created_at = NOW()`
        - `updated_at = NOW()`
      - Сохранить `client_id` для предзаказа
12. Расчет общей стоимости:
    - Получить актуальные цены блюд: `SELECT id, price FROM menu_items WHERE id IN (:menuItemIds)`
    - Рассчитать `total_amount = SUM(price * quantity)` для всех позиций
13. Создание записи в таблице `pre_orders`:
    - `restaurant_id = :restaurantId`
    - `booking_id = :bookingId` (если указано)
    - `client_id = :clientId` (обязательное поле)
    - `client_name = :clientName` ("на чье имя предзаказ")
    - `date = :date`
    - `time = :time`
    - `total_amount = :totalAmount` (рассчитанная стоимость)
    - `special_requests = :specialRequests` (если указано)
    - `booking_status_id = (SELECT id FROM booking_statuses WHERE code = 'PENDING')`
    - `whatsapp_message_id = :whatsappMessageId` (если указано)
    - `created_at = NOW()`
    - `updated_at = NOW()`
14. Создание записей в таблице `pre_order_items` для каждой позиции:
    - `pre_order_id = <созданный_id>`
    - `menu_item_id = :menuItemId`
    - `quantity = :quantity`
    - `price = :price` (актуальная цена на момент заказа)
    - `total_price = :price * :quantity`
    - `special_requests = :specialRequests` (если указано для позиции)
15. Создание записи в таблице `pre_order_history`:
    - `pre_order_id = <созданный_id>`
    - `booking_status_id = (SELECT id FROM booking_statuses WHERE code = 'PENDING')`
    - `changed_at = NOW()`
    - `changed_by = NULL` (создано клиентом через WhatsApp бот)
    - `comment = NULL`
16. Вызов WhatsApp бота для уведомления менеджера:
   - Получить список менеджеров ресторана: `SELECT u.* FROM users u JOIN users_2_restaurants u2r ON u.id = u2r.user_id WHERE u2r.restaurant_id = :restaurantId AND u.role_id = (SELECT id FROM roles WHERE code = 'MANAGER')`
   - Получить язык менеджера из `restaurants.manager_language_code`
   - Отправить уведомление каждому менеджеру через WhatsApp бот API (на номер телефона из `users.phone`)
   - В уведомлении: информация о предзаказе, список позиций, общая стоимость, номер телефона клиента, кнопки "Подтвердить", "Отказать" и "Связаться с клиентом"
17. Возврат созданного предзаказа

**Ошибки:**
- 400 Bad Request: невалидные данные, ресторан не найден или неактивен, блюдо не найдено, блюдо недоступно, блюдо не принадлежит ресторану, неверный формат номера телефона, дата/время в прошлом, бронирование не найдено или не принадлежит ресторану
- 404 Not Found: ресторан не найден, блюдо не найдено, бронирование не найдено
- 500 Internal Server Error: ошибка при вызове WhatsApp бота

### 2. Валидация данных

#### 2.1. Правила валидации для каждого поля

**restaurant_id** (ID ресторана):
- Обязательное поле (`@NotNull`)
- Тип: LONG
- Валидатор: `@ValidRestaurantId` - проверка существования и активности ресторана

**booking_id** (ID бронирования):
- Опциональное поле
- Тип: LONG
- Валидатор: `@ValidBookingId` - проверка существования, активности и принадлежности к ресторану

**date** (дата предзаказа):
- Обязательное поле (`@NotNull`)
- Формат: YYYY-MM-DD (`@Pattern` или `@DateTimeFormat`)
- Не может быть в прошлом (`@Future` или кастомная проверка)

**time** (время предзаказа):
- Обязательное поле (`@NotNull`)
- Формат: HH:mm:ss (`@Pattern` или `@TimeFormat`)

**client_phone** (номер телефона клиента):
- Обязательное поле (`@NotNull`)
- Формат: `+7XXXXXXXXXX` или `8XXXXXXXXXX` (10 цифр после +7 или 8)
- Нормализация к формату `+7XXXXXXXXXX` при сохранении
- Кастомный валидатор: `@Phone` (см. шаг 3.1)

**client_first_name** ("свое имя" клиента):
- Опциональное поле
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)

**client_name** ("на чье имя предзаказ"):
- Опциональное поле
- Максимальная длина: 255 символов (`@Size(max = 255)`)
- Не может быть пустой строкой (после trim)

**items** (массив позиций):
- Обязательное поле (`@NotNull`, `@NotEmpty`)
- Минимальное количество позиций: 1
- Каждая позиция должна содержать:
  - `menu_item_id` - обязательное поле, тип LONG
  - `quantity` - обязательное поле, тип INTEGER, минимальное значение: 1
  - `special_requests` - опциональное поле, тип TEXT, максимальная длина: 10000

**special_requests** (общие особые пожелания):
- Опциональное поле
- Тип: TEXT
- Максимальная длина: 10000 символов (`@Size(max = 10000)`)

**whatsapp_message_id** (ID сообщения в WhatsApp):
- Опциональное поле
- Максимальная длина: 255 символов (`@Size(max = 255)`)

#### 2.2. Кастомные валидаторы

**@ValidRestaurantId** - проверка существования и активности ресторана (см. шаг 5.3)

**@ValidBookingId** - проверка существования, активности и принадлежности бронирования к ресторану:
```java
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ValidBookingIdValidator.class)
public @interface ValidBookingId {
    String message() default "Booking not found, inactive, or does not belong to restaurant";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```
- Проверка через JOIN `bookings → tables → rooms → floors → restaurants`
- Возвращает ошибку, если бронирование не найдено, неактивно или не принадлежит ресторану

#### 2.3. Логика проверки существования связанных сущностей

**Проверка ресторана:**
1. Выполнить запрос: `SELECT * FROM restaurants WHERE id = :restaurantId AND is_active = true`
2. Если ресторан не найден или неактивен → вернуть ошибку 400

**Проверка активной подписки:**
1. Выполнить запрос: `SELECT * FROM restaurant_subscriptions WHERE restaurant_id = :restaurantId AND is_active = true`
2. Если подписка не найдена или неактивна → вернуть ошибку 400

**Проверка блюд:**
1. Выполнить запрос: `SELECT * FROM menu_items WHERE id IN (:menuItemIds) AND is_active = true AND is_available = true`
2. Если какое-то блюдо не найдено или недоступно → вернуть ошибку 400
3. Проверка принадлежности к ресторану: `SELECT * FROM menu_items WHERE id IN (:menuItemIds) AND restaurant_id = :restaurantId`
4. Если какое-то блюдо не принадлежит ресторану → вернуть ошибку 400

**Проверка бронирования:**
1. Если указано `booking_id`:
   - Выполнить запрос: `SELECT b.*, f.restaurant_id FROM bookings b JOIN tables t ON b.table_id = t.id JOIN rooms r ON t.room_id = r.id JOIN floors f ON r.floor_id = f.id WHERE b.id = :bookingId`
   - Если бронирование не найдено → вернуть ошибку 404
   - Если `f.restaurant_id != :restaurantId` → вернуть ошибку 400

**Проверка даты/времени:**
1. Проверить, что `date` не в прошлом (сравнить с текущей датой)
2. Если `date` сегодня, проверить, что `time` не в прошлом (сравнить с текущим временем)
3. Если дата/время в прошлом → вернуть ошибку 400

### 3. Логика работы с клиентами

#### 3.1. Создание/обновление клиента
- При создании предзаказа WhatsApp бот передает номер телефона и имя клиента
- Если клиент существует:
  - Обновить `first_name` (если указано новое имя)
  - Обновить `last_booking_date = NOW()` (если есть бронирования)
  - Увеличить `total_pre_orders = total_pre_orders + 1`
  - Обновить `updated_at = NOW()`
- Если клиент не существует:
  - Создать нового клиента:
    - `phone = :phone` (нормализованный)
    - `first_name = :clientFirstName` (если указано)
    - `first_booking_date = NULL` (если нет бронирований)
    - `last_booking_date = NULL` (если нет бронирований)
    - `total_bookings = 0`
    - `total_pre_orders = 1`
    - `created_at = NOW()`
    - `updated_at = NOW()`

### 4. Расчет стоимости
- Получение актуальных цен блюд из БД: `SELECT id, price FROM menu_items WHERE id IN (:menuItemIds)`
- Расчет стоимости каждой позиции: `total_price = price * quantity`
- Расчет общей стоимости: `total_amount = SUM(total_price)` для всех позиций
- Сохранение цены каждой позиции в `pre_order_items.price` (цена на момент заказа)

### 5. Интеграция с Telegram ботом
- API для отправки уведомлений менеджерам:
  - Endpoint Telegram бота (настраивается через конфигурацию)
  - Формат уведомления: текст с информацией о предзаказе (включая список позиций и общую стоимость) + inline кнопки
  - Кнопки: "Подтвердить" и "Отклонить" с callback данными (pre_order_id, manager_id)
- Обработка callback от Telegram бота:
  - Получение данных из callback
  - Вызов соответствующего endpoint для изменения статуса (см. шаг 3.7)

### 6. Обработка ошибок
- Валидационные ошибки (400)
- Ресторан не найден (404)
- Блюдо не найдено (404)
- Некорректные данные (400)
- Неверный формат номера телефона (400)
- Дата/время в прошлом (400)
- Бронирование не найдено (404)
- Ошибка при вызове Telegram бота (500)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ PreOrder Controller:
   - `POST /admin-api/pre-order` endpoint (публичный, вызывается WhatsApp ботом)

2. ✅ PreOrder Service:
   - Метод для создания предзаказа
   - Метод для создания/обновления клиента
   - Метод для расчета стоимости
   - Валидация данных
   - Интеграция с WhatsApp ботом

3. ✅ Валидация:
   - Валидация обязательных полей
   - Проверка существования ресторана и блюд
   - Проверка принадлежности блюд к ресторану
   - Проверка доступности блюд
   - Проверка даты/времени (не в прошлом)
   - Валидация номера телефона

### Функциональные проверки:
1. ✅ Создание предзаказа работает:
   - Предзаказ создается с обязательным `client_id`
   - Клиент создается/обновляется корректно
   - Позиции создаются корректно
   - Стоимость рассчитывается правильно
   - Запись создается в истории изменений (PENDING)
   - WhatsApp бот получает уведомление и отправляет его менеджеру

2. ✅ Валидация работает:
   - Обязательные поля проверяются
   - Ресторан и блюда проверяются на существование и активность
   - Блюда проверяются на принадлежность к ресторану
   - Дата/время проверяются (не в прошлом)
   - Номер телефона валидируется и нормализуется

3. ✅ Работа с клиентами работает:
   - Новый клиент создается корректно
   - Существующий клиент обновляется корректно
   - Статистика клиента обновляется

4. ✅ Расчет стоимости работает:
   - Цены берутся актуальные из БД
   - Стоимость каждой позиции рассчитывается правильно
   - Общая стоимость рассчитывается правильно

### Критерии готовности:
- ✅ Endpoint работает
- ✅ Валидация данных работает
- ✅ Клиент создается/обновляется корректно
- ✅ Предзаказ создается с обязательным `client_id`
- ✅ Позиции создаются корректно
- ✅ Стоимость рассчитывается правильно
- ✅ Запись создается в истории изменений
- ✅ Интеграция с WhatsApp ботом работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все endpoints работают и все функциональные проверки пройдены успешно.

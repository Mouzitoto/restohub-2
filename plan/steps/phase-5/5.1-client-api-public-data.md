# Шаг 5.1: Публичные данные ресторанов

## Описание
Реализация публичного API для получения данных о ресторанах, меню и карте столов для client-web.

## Интерцептор проверки подписки

### RestaurantSubscriptionInterceptor
Все endpoints, связанные с конкретным рестораном, автоматически проверяют наличие активной подписки через интерцептор `RestaurantSubscriptionInterceptor`.

**Паттерны путей:**
- `/client-api/restaurants/**` - все пути, начинающиеся с `/client-api/restaurants`
- `/client-api/r/**` - все пути, начинающиеся с `/client-api/r`

**Логика работы:**
1. Интерцептор извлекает `restaurantId` из path variable (например, `/restaurants/{id}`, `/r/{id}`, `/r/{id}/menu`)
2. Использует `SubscriptionCheckService` для проверки активной подписки
3. Подписка считается активной, если:
   - `is_active = true`
   - `CURRENT_DATE >= start_date`
   - `CURRENT_DATE <= end_date`
4. Если подписка неактивна или ресторан не найден:
   - Возвращает HTTP 404 с JSON ответом: `{"exceptionName": "RESTAURANT_NOT_FOUND", "message": "Ресторан не найден или неактивен"}`
5. Если подписка активна - пропускает запрос дальше к контроллеру

**Исключения:**
- Список ресторанов (`/client-api/restaurants` или `/client-api/r`) пропускается интерцептором - фильтрация выполняется в контроллере

**Кэширование:**
- Результат проверки подписки кэшируется на 10 минут через Caffeine
- Кэш хранит только положительные результаты (наличие подписки)
- Ключ кэша: `restaurantId`

## Задачи

### 1. API для получения списка ресторанов
- **GET** `/client-api/r`
- Query параметры:
  - `limit` - количество результатов
  - `offset` - пагинация
  - `status` - фильтр по статусу (только активные)
- Возвращает:
  - Список ресторанов с базовой информацией
  - Только рестораны с активной подпиской
- Поля в ответе:
  - id
  - название
  - адрес
  - телефон
  - геолокация
  - логотип
  - краткое описание

### 2. API для получения информации о ресторане
- **GET** `/client-api/r/:id`
- Возвращает полную информацию о ресторане:
  - Все поля ресторана
  - Настройки дизайна (лого, фон, цвета)
  - Контактная информация
  - WhatsApp номер
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 3. API для получения меню
- **GET** `/client-api/r/:id/menu`
- Возвращает:
  - Категории блюд с порядком
  - Блюда в каждой категории с полной информацией:
    - Название, описание, цена
    - Фотографии
    - Состав, вес/объем (если есть)
  - Только доступные блюда (status = available)
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 4. API для получения списка этажей
- **GET** `/client-api/r/:id/floor`
- Возвращает:
  - Список этажей ресторана
  - Только активные этажи
- Поля в ответе:
  - id
  - floorNumber (номер этажа, например "1", "Крыша", "Подвал")
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 5. API для получения списка залов
- **GET** `/client-api/r/:id/room`
- Query параметры:
  - `floorId` - фильтр по этажу (опционально)
- Возвращает:
  - Список залов ресторана
  - Только активные залы
- Поля в ответе:
  - id
  - name (название зала)
  - floorId (ID этажа)
  - isSmoking (курение разрешено)
  - isOutdoor (зал на открытом воздухе)
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 6. API для получения информации о зале
- **GET** `/client-api/r/:id/room/:roomId`
- Возвращает:
  - Полную информацию о зале
  - План помещения (imageId)
- Поля в ответе:
  - id
  - name
  - description
  - floorId
  - isSmoking
  - isOutdoor
  - imageId (план помещения)
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 7. API для получения списка столов зала
- **GET** `/client-api/r/:id/table`
- Query параметры:
  - `roomId` - фильтр по залу (required для выбора столов)
  - `floorId` - фильтр по этажу (опционально)
- Возвращает:
  - Список столов зала
  - Только активные столы
- Поля в ответе:
  - id
  - tableNumber (номер стола)
  - roomId (ID зала)
  - capacity (количество мест)
  - description (описание стола, опционально)
  - imageId (фото стола)
  - depositAmount (депозит, если указан)
  - depositNote (примечание о депозите)
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`

### 8. API для получения карты столов (иерархическая структура)
- **GET** `/client-api/r/:id/table/map`
- Query параметры:
  - `floorId` - фильтр по этажу (опционально)
  - `roomId` - фильтр по помещению (опционально)
- Возвращает:
  - Иерархическую структуру этажей → залов → столов
  - Планы помещений
  - Номера столов (`tableNumber`) для сопоставления с визуальной схемой
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`
- **Примечание**: Координаты столов не хранятся в БД. Номера столов на схеме соответствуют `tableNumber` в БД

### 9. API для получения промо-событий ресторана
- **GET** `/client-api/r/:id/promotion`
- Query параметры:
  - `promotionTypeId` - фильтр по типу промо-события (опционально)
  - `isCurrent` - boolean (опционально) - только текущие акции (CURRENT_DATE >= start_date AND (CURRENT_DATE <= end_date OR end_date IS NULL))
  - `limit` - количество результатов (опционально, default: 50)
  - `offset` - пагинация (опционально, default: 0)
- Возвращает:
  - Список активных промо-событий ресторана
  - Только активные промо-события (`is_active = true`)
  - Для повторяющихся событий: проверка, что текущая дата попадает в период повторений (если `endDate` указана)
- Поля в ответе:
  - id
  - title (заголовок)
  - description (описание, опционально)
  - promotionType (объект с id, code, name)
  - startDate (дата начала)
  - endDate (дата окончания, может быть null для бесконечных повторяющихся событий)
  - imageId (изображение, опционально)
  - isRecurring (флаг повторяющегося события)
  - recurrenceType (тип повторения: WEEKLY, MONTHLY, DAILY, или null)
  - recurrenceDayOfWeek (день недели для WEEKLY: 1-7, или null)
- **Проверка активной подписки:** выполняется автоматически через интерцептор `RestaurantSubscriptionInterceptor`
- **Примечание**: Для повторяющихся событий с `isRecurring=true` и `recurrenceType=WEEKLY` и `recurrenceDayOfWeek`, проверяется, что текущий день недели соответствует указанному дню

### 10. Оптимизация
- Кеширование публичных данных (опционально)
- Оптимизация запросов (eager loading для связанных данных)
- Сжатие ответов (gzip)

### 11. Безопасность
- Публичные endpoint'ы не требуют аутентификации
- Фильтрация только активных ресторанов
- Фильтрация только доступных данных


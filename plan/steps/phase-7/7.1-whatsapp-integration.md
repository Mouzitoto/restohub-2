# Шаг 7.1: Интеграция WhatsApp API

## Описание
Настройка интеграции с WhatsApp Business API для получения сообщений от клиентов и уведомления менеджеров ресторанов через WhatsApp бот.

## Процесс работы

1. Клиент на фронте выбирает стол и предзаказ блюд, нажимает "Забронировать"
2. Веб шлет запрос в бэк, бэк создает бронирование в статусе DRAFT с client_id = NULL
3. Бэк отвечает фронту строкой (ссылка на наш вацап бот + booking_id + текст для вацап сообщения): `https://wa.me/ВАШ_НОМЕР_БОТА?text=BOOKING:1`
4. Фронт редиректит юзера на вацап ссылку и вставляет в поле ввода текст (BOOKING:1)
5. Юзер внутри вацапа жмет кнопку "отправить"
6. Наш_вацап_бот получает сообщение, в тексте которого есть booking_id
7. Наш_вацап_бот получает номер телефона юзера через вацап SDK
8. Наш_вацап_бот создает/редактирует юзера в БД, затем вставляет client_id в бронирование и меняет статус с DRAFT на PENDING
9. Наш_вацап_бот отправляет сообщение менеджеру ресторана с информацией о бронировании и клиенте (на языке, указанном в `restaurants.manager_language_code`)
10. В сообщении менеджеру есть кнопки: "Подтвердить", "Отказать" и "Связаться с клиентом"
11. Менеджер нажимает кнопку в чате с вацап ботом:
    - "Подтвердить" → вацап бот обновляет статус бронирования на APPROVED и отправляет подтверждение клиенту
    - "Отказать" → вацап бот обновляет статус бронирования на REJECTED и отправляет отказ клиенту
    - "Связаться с клиентом" → открывается WhatsApp чат с клиентом (ссылка `https://wa.me/<номер_клиента>`)
12. Менеджер может напрямую связаться с клиентом через WhatsApp и обсудить детали

## Задачи

### 1. Выбор решения для WhatsApp
- **Варианты интеграции:**
  - WhatsApp Business API (официальное решение)
  - Twilio WhatsApp API
  - MessageBird WhatsApp API
  - Green API или другие решения
- Определение требований:
  - Объем сообщений
  - Бюджет
  - Необходимость автоматических ответов
  - Двусторонняя коммуникация
  - Поддержка интерактивных кнопок (для менеджеров)

### 2. Настройка WhatsApp Business API
- Регистрация бизнес-аккаунта
- Получение API ключей
- **Настройка webhook'ов для получения сообщений** (обязательно для получения номеров клиентов)
- Настройка шаблонов сообщений (для WhatsApp Business API)
- Получение номера телефона WhatsApp бота (для генерации ссылок)
- Настройка интерактивных кнопок (для менеджеров)

### 3. Реализация WhatsApp бота
- Создание сервиса/модуля для работы с WhatsApp API
- **Webhook для получения входящих сообщений:**
  - Прием сообщений от клиентов и менеджеров
  - Парсинг текста сообщения:
    - Формат для бронирования: `BOOKING:<booking_id>`
    - Пример: `BOOKING:1`
    - Извлечение `booking_id` из текста сообщения
  - Определение типа запроса (бронирование) по префиксу `BOOKING:`
  - Извлечение номера телефона отправителя (автоматически от WhatsApp SDK)
  - Определение типа отправителя (клиент или менеджер) по номеру телефона
- **Функции:**
  - Обработка входящих сообщений с префиксом BOOKING (от клиента):
    - Парсинг `booking_id` из сообщения
    - Получение номера телефона через WhatsApp SDK
    - Вызов API `/admin-api/booking/:id/confirm` для подтверждения бронирования с номером телефона
  - Обработка callback от кнопок менеджера:
    - Парсинг `booking_id` и `action` (APPROVE, REJECT, CONTACT_CLIENT) из callback_data
    - Вызов соответствующего API для обновления статуса или генерации ссылки на клиента
  - Отправка уведомлений менеджерам ресторанов:
    - Получение списка менеджеров ресторана
    - Получение номера телефона менеджера из таблицы `users` (поле `phone`)
    - Получение языка менеджера из `restaurants.manager_language_code`
    - Формирование сообщения на нужном языке
    - Отправка сообщения с интерактивными кнопками
  - Отправка ответов клиентам:
    - После подтверждения/отклонения менеджером
    - Формирование сообщения на языке клиента (определяется по `clients.phone` или дефолтный язык)
- Конфигурация (API ключи, номер WhatsApp бота)

### 4. Хранение номеров телефонов менеджеров
- Хранение номера телефона менеджера в таблице `users` (поле `phone`)
- Валидация формата номеров (международный формат: `+7XXXXXXXXXX`)
- Поддержка разных номеров для разных менеджеров
- Получение списка менеджеров ресторана для отправки уведомлений

### 5. Формирование сообщений для менеджера
- **Для бронирования:**
  - Формирование текста сообщения в WhatsApp:
    - Стандартизированный формат
    - Информация о ресторане
    - Данные бронирования (стол, дата, время, персоны)
    - Информация о клиенте (имя, номер телефона)
    - Особые пожелания (если есть)
    - Характеристики стола
    - Позиции предзаказа (если есть)
  - Добавление интерактивных кнопок:
    - "Подтвердить" (callback_data: `APPROVE_BOOKING:<booking_id>`)
    - "Отказать" (callback_data: `REJECT_BOOKING:<booking_id>`)
    - "Связаться с клиентом" (callback_data: `CONTACT_CLIENT:<booking_id>` или прямая ссылка `https://wa.me/<номер_клиента>`)
  - Форматирование сообщения (читабельный формат)
  - Использование языка из `restaurants.manager_language_code` для формирования текста

### 6. Обработка действий менеджера
- **Обработка callback "Подтвердить":**
  - Парсинг `booking_id` из callback_data
  - Вызов API `/admin-api/r/:id/booking/:bookingId/approve` для обновления статуса на APPROVED
  - Создание записи в `booking_history`
  - Отправка сообщения клиенту о подтверждении бронирования
  - Отправка подтверждения менеджеру ("Бронирование подтверждено")
- **Обработка callback "Отказать":**
  - Парсинг `booking_id` из callback_data
  - Вызов API `/admin-api/r/:id/booking/:bookingId/reject` для обновления статуса на REJECTED
  - Создание записи в `booking_history`
  - Отправка сообщения клиенту об отклонении бронирования
  - Отправка подтверждения менеджеру ("Бронирование отклонено")
- **Обработка callback "Связаться с клиентом":**
  - Парсинг `booking_id` из callback_data
  - Получение номера телефона клиента из `bookings.client_id → clients.phone`
  - Генерация ссылки: `https://wa.me/<номер_клиента>`
  - Отправка менеджеру сообщения со ссылкой или автоматическое открытие чата (в зависимости от возможностей WhatsApp API)

### 7. Отправка ответа клиенту через WhatsApp
- **Для бронирования:**
  - После подтверждения менеджером:
    - Формирование сообщения для клиента о подтверждении бронирования
    - Отправка через WhatsApp бот
    - Информация о ресторане, столе, дате и времени
    - Позиции предзаказа (если есть)
  - После отклонения менеджером:
    - Формирование сообщения об отклонении бронирования
    - Отправка через WhatsApp бот
    - Объяснение причины (опционально, если указано менеджером)

### 8. Хранение конфигурации
- Хранение номера WhatsApp бота в конфигурации системы
- Хранение номеров телефонов менеджеров в таблице `users` (поле `phone`)
- Хранение языка менеджера в таблице `restaurants` (поле `manager_language_code`)
- Валидация формата номеров (международный формат)
- Поддержка разных номеров для разных менеджеров

### 9. Логирование
- Логирование всех входящих сообщений от клиентов и менеджеров
- Логирование всех отправленных сообщений
- Логирование взаимодействий с кнопками
- Логирование ошибок отправки
- Статистика отправок и подтверждений

### 10. Тестирование
- Тестирование получения сообщений от клиентов через WhatsApp
- Тестирование извлечения номера телефона
- Тестирование отправки уведомлений менеджерам
- Тестирование обработки callback от кнопок
- Тестирование отправки ответов клиентам
- Проверка формата сообщений
- Тестирование на разных устройствах
- Проверка корректности данных в сообщениях
- Тестирование многоязычности (разные `manager_language_code`)

### 11. Безопасность
- Хранение API ключей в безопасном месте (.env, secrets)
- Валидация данных перед обработкой
- Проверка подлинности запросов от WhatsApp (webhook verification)
- Защита от спама (rate limiting)
- Валидация формата booking_id в сообщениях
- Проверка прав доступа при обработке callback от менеджеров (проверка, что менеджер имеет доступ к ресторану)
- Проверка существования бронирования перед обновлением статуса
- Проверка, что номер телефона отправителя соответствует менеджеру ресторана

### 12. Оптимизация индексов
**Примечание**: После реализации фазы 7 необходимо проанализировать запросы к БД и создать/оптимизировать индексы.

- Анализ всех SQL запросов, выполненных в рамках фазы 7 (интеграция WhatsApp)
- Если реализовано сохранение сообщений/статусов в БД - создание индексов для таких таблиц
- Оптимизация запросов, связанных с отправкой сообщений (если есть)
- Добавление индексов через миграции Liquibase
- Тестирование производительности запросов с новыми индексами

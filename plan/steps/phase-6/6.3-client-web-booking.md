# Шаг 6.3: Бронирование

## Описание
Реализация процесса бронирования стола с выбором зала, стола и заполнением формы бронирования.

## Процесс бронирования

### Шаг 1: Выбор зала

#### 1.1. Страница выбора залов
**Маршрут:** `/r/:id/booking/rooms` (публичный)

**Структура:**
- Заголовок: "Выберите зал"
- Список залов в виде блоков (grid layout)
- Переключатель этажей внизу страницы

#### 1.2. Отображение залов
**Компонент:** RoomSelectionGrid

**Для каждого зала (блок):**
- Название зала (крупным шрифтом)
- Иконка курения:
  - Если `isSmoking = true`: иконка сигареты (не зачеркнутой)
  - Если `isSmoking = false`: иконка зачеркнутой сигареты
- Иконка открытого воздуха:
  - Если `isOutdoor = true`: иконка солнца внизу блока
  - Если `isOutdoor = false`: иконка не отображается
- При клике на блок → редирект на `/r/:id/booking/tables/:roomId`

**Логика загрузки:**
1. При загрузке страницы:
   - GET запрос на `/client-api/r/:id/floor` для получения списка этажей
   - По умолчанию выбран первый этаж из списка
   - GET запрос на `/client-api/r/:id/room?floorId=:floorId` для получения залов выбранного этажа
2. При переключении этажа:
   - Обновить выбранный этаж
   - Отправить новый запрос с `floorId`
   - Обновить список залов

#### 1.3. Переключатель этажей
**Компонент:** FloorSelector

**Отображение:**
- Внизу страницы (как пагинация)
- Кнопки с номерами этажей (например: "1", "2", "Крыша", "Подвал")
- Активный этаж выделен визуально
- По умолчанию выбран первый этаж из списка

**Логика:**
- При клике на этаж → обновить список залов для выбранного этажа
- Плавная прокрутка к списку залов после переключения

### Шаг 2: Выбор стола

#### 2.1. Страница выбора столов
**Маршрут:** `/r/:id/booking/tables/:roomId` (публичный)

**Структура:**
- Плашка сверху (sticky header):
  - Иконка "Назад" (влево)
  - Текст "Выберите стол"
  - Dropdown с номерами столов
- Область карты столов (на весь экран)
- Область формы бронирования (появляется при выборе стола)

#### 2.2. Плашка выбора стола
**Компонент:** TableSelectionHeader

**Элементы:**
- Иконка "Назад" (влево):
  - При клике → редирект на `/r/:id/booking/rooms`
- Текст "Выберите стол" (по центру)
- Dropdown "Выберите стол":
  - Опция "Скрыть" (скрывает форму бронирования)
  - Список всех столов зала с номерами
  - При выборе стола → показать форму бронирования ниже плашки
  - При выборе "Скрыть" → скрыть форму бронирования

**Логика:**
- Загрузка списка столов через GET `/client-api/r/:id/table?roomId=:roomId`
- Заполнение dropdown номерами столов
- Сохранение выбранного `tableId` в состоянии

#### 2.3. Карта расположения столов
**Компонент:** TableMapViewer

**Библиотека:** react-konva, fabric.js или leaflet для интерактивной карты

**Функциональность:**
1. Загрузка плана зала:
   - GET запрос на `/client-api/r/:id/room/:roomId` для получения `imageId` плана
   - Отображение плана как фонового изображения
2. Отображение столов на карте:
   - Карта показывает визуальное расположение столов в зале
   - На схеме каждый стол подписан номером (например, "1", "2", "3")
   - Номер стола на схеме соответствует `tableNumber` из БД
   - **Важно**: Столы на карте НЕ кликабельны, карта служит только визуальной подсказкой
3. Интерактивность карты:
   - **Zoom**: колесико мыши или pinch gesture на мобильных
   - **Pan**: перетаскивание карты мышью или touch на мобильных
   - **Минимум/максимум zoom**: ограничения для удобства
   - Кнопки управления zoom (опционально): "+", "-", "Сбросить"
4. Визуальная подсказка:
   - Клиент видит на схеме расположение столов и их номера
   - Для бронирования клиент выбирает стол в dropdown по номеру
   - При выборе стола в dropdown можно подсветить соответствующий стол на карте (опционально)

**Особенности:**
- Адаптивность для мобильных устройств
- Touch-friendly для сенсорных экранов
- Плавная анимация при zoom/pan
- Карта служит только для визуальной ориентации, не для интерактивного выбора

#### 2.4. Форма бронирования
**Компонент:** BookingForm

**Отображение:**
- Появляется ниже плашки при выборе стола из dropdown
- Плашка с dropdown остается видимой и доступной для изменения выбора
- При выборе "Скрыть" в dropdown → форма скрывается

**Поля формы:**
```typescript
interface BookingForm {
  tableId: number;              // required, из dropdown
  date: string;                  // required, format: YYYY-MM-DD
  time: string;                  // required, format: HH:mm
  personCount: number;           // required, min: 1, max: capacity стола
  clientFirstName: string | null; // optional, max 255 ("свое имя")
  clientName: string | null;     // optional, max 255 ("на чье имя бронировать")
  specialRequests: string | null; // optional, max 10000
  preOrderItems: Array<{         // optional
    menuItemId: number;
    quantity: number;
    specialRequests: string | null;
  }>;
}
```

**Секции формы:**
1. Информация о столе (readonly):
   - Фотография стола (если есть `imageId`, через компонент `ImagePreview`)
   - Номер стола
   - Количество мест
   - Описание стола (если указано)
2. Дата и время:
   - Date picker для выбора даты
   - Time picker для выбора времени
   - Валидация: дата не в прошлом, время не в прошлом (если сегодня)
3. Количество персон:
   - Number input с валидацией (min: 1, max: capacity стола)
4. Контактная информация:
   - "Свое имя" (text input, опционально)
   - "На чье имя бронировать" (text input, опционально)
5. Особые пожелания:
   - Textarea (опционально)
6. Предзаказ меню:
   - Кнопка "Предзаказ меню" → открыть модальное окно выбора блюд
   - Отображение выбранных блюд (если есть)
7. Кнопка "Забронировать":
   - При клике → отправка формы

**Валидация:**
- `tableId`: обязательное поле
- `date`: обязательное, не в прошлом
- `time`: обязательное, не в прошлом (если дата сегодня)
- `personCount`: обязательное, min: 1, max: capacity стола
- `clientFirstName`: опциональное, max 255
- `clientName`: опциональное, max 255
- `specialRequests`: опциональное, max 10000

**Логика отправки:**
1. Валидация всех полей
2. Показать loading state
3. POST запрос на `/client-api/r/:id/booking` с данными формы
4. Обработка ответа:
   - **Успех (201 Created)**:
     - Получить `whatsappUrl` и `message` из ответа
     - Редирект на страницу подтверждения через WhatsApp
   - **Ошибка (400 Bad Request)**:
     - Показать ошибки валидации под полями
   - **Ошибка (404 Not Found)**:
     - Показать сообщение "Ресторан не найден"

### Шаг 3: Подтверждение через WhatsApp

#### 3.1. Страница подтверждения
**Маршрут:** `/r/:id/booking/confirm/:bookingId` (публичный)

**Структура:**
- Заголовок: "Бронирование создано"
- Информация о бронировании
- Инструкция для подтверждения
- Кнопка "Открыть WhatsApp"

**Отображение:**
- Информация о бронировании:
  - Номер стола
  - Дата и время
  - Количество персон
- Инструкция:
  - "Для завершения бронирования отправьте сообщение в WhatsApp"
  - "Нажмите кнопку ниже, чтобы открыть WhatsApp с предзаполненным сообщением"
  - "После отправки сообщения менеджер ресторана свяжется с вами для подтверждения"
- Кнопка "Открыть WhatsApp":
  - При клике → открыть `whatsappUrl` из ответа API
  - На мобильных: открыть приложение WhatsApp
  - На десктопе: открыть WhatsApp Web

**Логика:**
- GET запрос на `/client-api/r/:id/booking/:bookingId` для получения информации о бронировании (опционально)
- Отображение данных из ответа API или из состояния приложения

## Интеграция с API

### Endpoints
- `GET /client-api/r/:id/floor` - получение списка этажей
- `GET /client-api/r/:id/room?floorId=:floorId` - получение списка залов этажа
- `GET /client-api/r/:id/room/:roomId` - получение информации о зале (план помещения)
- `GET /client-api/r/:id/table?roomId=:roomId` - получение списка столов зала
- `POST /client-api/r/:id/booking` - создание бронирования
- `GET /client-api/r/:id/booking/:bookingId` - получение информации о бронировании (опционально)

### Обработка ошибок
- Стандартизированная обработка всех HTTP статусов
- Отображение понятных сообщений пользователю
- Валидация на фронтенде перед отправкой запроса

## UX улучшения

### Навигация
- Breadcrumbs: "Ресторан → Выбор зала → Выбор стола"
- Кнопка "Назад" на каждой странице
- Сохранение состояния при навигации (опционально)

### Адаптивность
- Мобильная оптимизация всех страниц
- Touch-friendly элементы управления
- Оптимизация карты для мобильных устройств

### Производительность
- Lazy loading изображений планов залов
- Оптимизация загрузки карты столов
- Кеширование данных (опционально)

## Результаты выполнения шага

По итогу выполнения этого шага должны быть созданы следующие артефакты и выполнены следующие проверки:

### Созданные компоненты:
1. ✅ Страница выбора залов:
   - Grid с блоками залов
   - Иконки курения и открытого воздуха
   - Переключатель этажей

2. ✅ Страница выбора столов:
   - Интерактивная карта с zoom/pan
   - Плашка с dropdown выбора стола
   - Форма бронирования

3. ✅ Страница подтверждения:
   - Информация о бронировании
   - Переход в WhatsApp

4. ✅ Интеграция с API:
   - Запросы к `/client-api/r/:id/floor`
   - Запросы к `/client-api/r/:id/room`
   - Запросы к `/client-api/r/:id/table`
   - Запросы к `/client-api/r/:id/booking`
   - Обработка ответов
   - Обработка ошибок

### Функциональные проверки:
1. ✅ Навигация работает:
   - Переход со страницы ресторана на выбор залов
   - Переход с выбора залов на выбор столов
   - Кнопка "Назад" работает корректно

2. ✅ Выбор зала работает:
   - Залы отображаются блоками
   - Иконки курения и открытого воздуха отображаются корректно
   - Переключение этажей работает

3. ✅ Выбор стола работает:
   - Карта загружается и отображается как визуальная подсказка
   - Zoom и pan работают
   - Dropdown заполняется столами с номерами
   - Выбор стола в dropdown работает корректно

4. ✅ Форма бронирования работает:
   - Появляется при выборе стола
   - Скрывается при выборе "Скрыть"
   - Валидация работает корректно
   - Отправка формы работает

5. ✅ Переход в WhatsApp работает:
   - WhatsApp ссылка открывается корректно
   - Сообщение предзаполняется

### Критерии готовности:
- ✅ Все компоненты созданы и работают
- ✅ Интеграция с API работает
- ✅ Навигация работает корректно
- ✅ Карта столов работает (zoom/pan)
- ✅ Форма бронирования работает
- ✅ Все функциональные проверки пройдены успешно

**Шаг считается выполненным**, когда все компоненты работают и все функциональные проверки пройдены успешно.

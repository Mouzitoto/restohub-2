# Шаг 6.4: Предзаказ

## Описание
Реализация функционала предзаказа: выбор блюд из меню, форма предзаказа, привязка к бронированию, генерация сообщения для WhatsApp.

## Задачи

### 1. Выбор блюд из меню
- Кнопка "Добавить в предзаказ" у каждого блюда в меню
- Корзина предзаказа (shopping cart):
  - Отображение выбранных блюд
  - Количество каждого блюда
  - Итоговая стоимость
  - Возможность изменения количества
  - Удаление блюд из корзины
- Sticky корзина (опционально) - всегда видна при скролле
- Индикатор количества товаров в корзине

### 2. Форма предзаказа
- Поля формы:
  - Дата предзаказа (date picker)
  - Время предзаказа (time picker)
  - Имя клиента (text input, опционально)
  - Email клиента (email input, опционально)
  - Привязка к бронированию (checkbox + выбор бронирования, опционально)
  - Особые пожелания (textarea, опционально)
- **Важно**: Номер телефона НЕ запрашивается в форме
- Отображение списка выбранных блюд в форме:
  - Название блюда
  - Количество
  - Цена за единицу
  - Общая стоимость позиции
  - Особые пожелания к блюду (textarea для каждого, опционально)
- Итоговая стоимость предзаказа

### 3. Привязка к бронированию
- Если реализована:
  - Чекбокс "Привязать к бронированию"
  - Выбор бронирования из списка (если есть несколько)
  - Отображение информации о бронировании:
    - Дата и время
    - Номер стола
    - Количество персон
- Автоматическое заполнение даты/времени из бронирования (опционально)

### 4. Валидация
- Проверка наличия блюд в корзине
- Валидация всех полей формы
- Проверка формата телефона и email
- Проверка даты и времени (не в прошлом)

### 5. Отправка запроса на API
- POST запрос к `/client-api/r/:id/pre-order`
- Формирование массива items из корзины
- Отображение loading state
- Обработка успешного ответа
- Обработка ошибок валидации

### 6. Переход в WhatsApp для подтверждения
- Получение WhatsApp ссылки из API после создания предзаказа
- Отображение инструкции для клиента:
  - "Для завершения предзаказа отправьте сообщение в WhatsApp"
  - Кнопка "Открыть WhatsApp"
  - Информация о том, что номер телефона будет определен автоматически
- Автоматическое открытие WhatsApp при клике на кнопку
- Редирект на WhatsApp с предзаполненным текстом (PREORDER:67890)
- Инструкция: "Нажмите 'Отправить' в WhatsApp для подтверждения предзаказа"
- Отображение детальной информации о предзаказе (блюда, цены, итоговая стоимость)

### 7. Очистка корзины
- Автоматическая очистка корзины после успешной отправки
- Подтверждение при выходе с несохраненным предзаказом (опционально)
- Сохранение корзины в localStorage (опционально)

### 8. UX улучшения
- Модальное окно для корзины и формы
- Пошаговая форма (1. Выбор блюд, 2. Заполнение формы, 3. Подтверждение)
- Анимации при добавлении блюд в корзину
- Toast notifications при действиях
- Возможность вернуться к меню для добавления блюд

### 9. Расчет стоимости
- Автоматический пересчет при изменении количества
- Отображение цены за единицу и общей стоимости позиции
- Итоговая стоимость со всеми позициями
- Применение акций (если реализовано, опционально)

### 10. Мобильная оптимизация
- Адаптивная корзина (drawer или bottom sheet на мобильных)
- Touch-friendly интерфейс
- Оптимизация формы для мобильных устройств

### 11. Оптимизация индексов
**Примечание**: После реализации фазы 6 необходимо проанализировать запросы к БД через Client Web и создать/оптимизировать индексы.

- Анализ всех запросов, сделанных через Client Web (клиентская сторона может влиять на паттерны запросов)
- Проверка производительности API запросов из фронтенда
- Оптимизация индексов для запросов:
  - Получения списка ресторанов (пагинация)
  - Получения информации о ресторане с меню и столами
  - Поисковых запросов
- Координация с Client API (фаза 5) для оптимизации запросов
- Тестирование производительности с реальными данными


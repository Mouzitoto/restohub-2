# Инструкция по настройке WhatsApp Business API (Meta)

## Обзор

WhatsApp Business API от Meta - это официальное решение для интеграции с WhatsApp. Оно требует бизнес-аккаунт и верификацию, но предоставляет надежную и масштабируемую платформу.

## Преимущества

- ✅ Официальное решение от Meta
- ✅ Первые 1000 сообщений/месяц бесплатно
- ✅ 24-часовое окно обслуживания (сервисные сообщения бесплатны)
- ✅ Высокая надежность
- ✅ Масштабируемость
- ✅ Нет риска блокировки

## Шаг 1: Создание бизнес-аккаунта в Meta Business

### 1.1. Регистрация

1. Перейдите на [Meta Business](https://business.facebook.com/)
2. Нажмите **"Создать аккаунт"** или **"Create Account"**
3. Введите название вашего бизнеса
4. Введите ваше имя и email
5. Подтвердите email

### 1.2. Верификация бизнеса

1. В Meta Business перейдите в **"Настройки"** → **"Безопасность"**
2. Нажмите **"Начать верификацию бизнеса"**
3. Заполните информацию о бизнесе:
   - Название компании
   - Адрес
   - Номер телефона
   - Веб-сайт (если есть)
4. Загрузите документы:
   - Свидетельство о регистрации
   - Документы, подтверждающие адрес
5. Дождитесь одобрения (обычно 1-3 дня)

## Шаг 2: Создание приложения в Meta for Developers

### 2.1. Регистрация

1. Перейдите на [Meta for Developers](https://developers.facebook.com/)
2. Нажмите **"Мои приложения"** → **"Создать приложение"**
3. Выберите тип приложения: **"Бизнес"** или **"Другое"**
4. Введите название приложения (например, "RestoHub WhatsApp Bot")
5. Введите email для контакта
6. Нажмите **"Создать приложение"**

### 2.2. Добавление продукта WhatsApp

1. В настройках приложения найдите **"Добавить продукт"**
2. Найдите **"WhatsApp"** и нажмите **"Настроить"**
3. Выберите **"WhatsApp Business API"**

## Шаг 3: Получение API ключей

### 3.1. App ID и App Secret

1. В настройках приложения перейдите в **"Основные"** (Basic)
2. Найдите **"App ID"** - скопируйте это значение
3. Найдите **"App Secret"** - нажмите **"Показать"** и скопируйте
4. Сохраните эти значения в безопасном месте

### 3.2. Access Token

1. В разделе **"WhatsApp"** → **"API Setup"**
2. Найдите раздел **"Temporary access token"** (временный токен)
3. Скопируйте токен (он действителен 24 часа)

**Для продакшн нужен долгоживущий токен:**

1. Перейдите в **"WhatsApp"** → **"API Setup"**
2. Найдите **"System User Access Token"**
3. Создайте System User (если еще нет)
4. Сгенерируйте долгоживущий токен (60 дней или бессрочный)
5. Скопируйте токен

### 3.3. Phone Number ID

1. В разделе **"WhatsApp"** → **"API Setup"**
2. Найдите **"Phone number ID"**
3. Скопируйте ID (это числовой идентификатор)

### 3.4. WhatsApp Business Account ID

1. В разделе **"WhatsApp"** → **"API Setup"**
2. Найдите **"WhatsApp Business Account ID"**
3. Скопируйте ID

## Шаг 4: Настройка номера телефона

### 4.1. Добавление номера

1. В разделе **"WhatsApp"** → **"Phone numbers"**
2. Нажмите **"Add phone number"**
3. Выберите способ получения номара:
   - **Использовать существующий номер** (если есть)
   - **Получить новый номер** (через провайдера)

### 4.2. Верификация номера

1. Введите номер телефона
2. Выберите способ верификации (SMS или звонок)
3. Введите код подтверждения
4. Номер будет добавлен в ваш аккаунт

## Шаг 5: Настройка Webhook

### 5.1. Генерация токена верификации

1. Придумайте секретный токен (например, случайная строка из 32 символов)
2. Сохраните его в безопасном месте
3. Этот токен будет использоваться для верификации webhook

### 5.2. Настройка webhook в Meta

1. В разделе **"WhatsApp"** → **"Configuration"**
2. Найдите раздел **"Webhook"**
3. Нажмите **"Edit"** или **"Configure"**
4. Введите:
   - **Callback URL**: `https://ваш-домен.com/admin-api/whatsapp/webhook`
   - **Verify token**: ваш секретный токен (из шага 5.1)
4. Нажмите **"Verify and Save"**

### 5.3. Верификация webhook

1. Meta отправит GET запрос на ваш webhook URL
2. Ваш сервер должен ответить с `hub.challenge` если токен совпадает
3. После успешной верификации webhook будет активен

### 5.4. Подписка на события

1. В разделе **"Webhook"** найдите **"Webhook fields"**
2. Выберите события для подписки:
   - ✅ **messages** - входящие сообщения
   - ✅ **message_status** - статусы сообщений
3. Нажмите **"Save"**

## Шаг 6: Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл или `docker-compose.yml`:

```env
# WhatsApp Business API (Meta) настройки
WHATSAPP_PROVIDER=meta
WHATSAPP_APP_ID=your_app_id_here
WHATSAPP_APP_SECRET=your_app_secret_here
WHATSAPP_ACCESS_TOKEN=your_access_token_here
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id_here
WHATSAPP_BUSINESS_ACCOUNT_ID=your_business_account_id_here
WHATSAPP_WEBHOOK_VERIFY_TOKEN=your_secret_verify_token_here
WHATSAPP_BOT_PHONE=79991234567
WHATSAPP_API_BASE_URL=https://graph.facebook.com/v18.0
WHATSAPP_WEBHOOK_URL=https://ваш-домен.com/admin-api/whatsapp/webhook
```

## Шаг 7: Настройка для каждого ресторана

Для каждого ресторана в системе нужно указать WhatsApp номер в админке:

1. Войдите в админку ресторана
2. Перейдите в раздел **"Мой ресторан"**
3. Найдите поле **"WhatsApp"**
4. Введите номер телефона в формате: `+7 (999) 123-45-67` или `79991234567`
5. Сохраните изменения

**Важно:** Этот номер будет использоваться для отправки уведомлений менеджерам ресторана.

## Шаг 8: Создание шаблонов сообщений (опционально)

Если вы хотите инициировать диалоги (бот пишет первым), нужно создать шаблоны:

1. В разделе **"WhatsApp"** → **"Message templates"**
2. Нажмите **"Create template"**
3. Заполните форму:
   - **Название**: например, "booking_confirmation"
   - **Категория**: "UTILITY" (для сервисных сообщений)
   - **Язык**: выберите язык
   - **Текст**: текст шаблона (можно использовать переменные)
4. Отправьте на одобрение
5. Дождитесь одобрения (обычно 1-2 дня)

## Шаг 9: Проверка работы

1. Запустите приложение
2. Создайте тестовое бронирование
3. Проверьте, что:
   - Клиент получает WhatsApp ссылку для подтверждения
   - После подтверждения менеджер получает уведомление на WhatsApp номер ресторана
   - Кнопки в сообщении работают корректно

## Локальная разработка с ngrok

Для локальной разработки нужно использовать ngrok:

1. Установите ngrok: https://ngrok.com/download
2. Запустите ngrok:
   ```bash
   ngrok http 8082
   ```
3. Скопируйте HTTPS URL (например, `https://abc123.ngrok.io`)
4. Используйте этот URL в настройках webhook Meta:
   ```
   https://abc123.ngrok.io/admin-api/whatsapp/webhook
   ```
5. Обновите переменную окружения:
   ```env
   WHATSAPP_WEBHOOK_URL=https://abc123.ngrok.io/admin-api/whatsapp/webhook
   ```

## Устранение неполадок

### Сообщения не отправляются

1. Проверьте, что Access Token действителен
2. Проверьте правильность Phone Number ID
3. Проверьте логи приложения на наличие ошибок
4. Убедитесь, что номер телефона верифицирован

### Webhook не получает сообщения

1. Проверьте, что webhook URL доступен из интернета
2. Проверьте, что webhook верифицирован в Meta
3. Проверьте, что подписаны на нужные события (messages, message_status)
4. Проверьте логи приложения

### Кнопки не работают

1. Убедитесь, что используете правильный формат кнопок для Meta API
2. Проверьте, что callback данные правильно парсятся
3. Проверьте логи обработки callback

## Дополнительные ресурсы

- [Документация WhatsApp Business API](https://developers.facebook.com/docs/whatsapp)
- [Graph API Reference](https://developers.facebook.com/docs/graph-api)
- [Webhook Setup Guide](https://developers.facebook.com/docs/graph-api/webhooks/getting-started)

## Безопасность

1. **Никогда не коммитьте API ключи в репозиторий**
2. Используйте переменные окружения для хранения секретов
3. Регулярно обновляйте Access Token
4. Используйте долгоживущие токены для продакшн
5. Ограничьте доступ к webhook endpoint (проверка verify token)

## Стоимость

- **Первые 1000 сообщений/месяц**: БЕСПЛАТНО
- **После лимита**: ~$0.005-0.01 за сообщение
- **24-часовое окно**: все сервисные сообщения в окне БЕСПЛАТНО
- Подробнее см. `WHATSAPP_PRICING_EXPLAINED.md`

